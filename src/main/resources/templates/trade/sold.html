<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>판매한 상품</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .page-header{width:1200px;background:#fff;margin:30px auto;}
        /* 목록 아이콘: 테두리 없음 + 말풍선 툴팁 */
        .icon-btn{
            display:inline-flex; align-items:center; justify-content:center;
            width:44px; height:44px; border-radius:10px;
            border:none; background:transparent; color:#212529;
        }
        .icon-btn:hover{ color:#212529; background:transparent; }
        .icon-btn svg{ width:28px; height:28px; }
        :root .tooltip.bubble .tooltip-inner{
            position:relative; background:#111 !important; color:#fff !important;
            padding:6px 10px !important; font-size:.875rem !important; line-height:1.2 !important;
            border-radius:8px !important; box-shadow:0 4px 12px rgba(0,0,0,.2) !important; white-space:nowrap;
        }
        :root .tooltip.bubble .tooltip-arrow{ display:none !important; }
        :root .tooltip.bubble.bs-tooltip-bottom .tooltip-inner::after{
            content:""; position:absolute; left:50%; transform:translateX(-50%); top:-8px;
            width:0; height:0; border-style:solid; border-width:0 8px 8px 8px; border-color:transparent transparent #111 transparent;
        }

        /* trade/list 카드 스타일 복제 */
        .card-img-top{object-fit:cover;}
        .ratio-4x3{--bs-aspect-ratio:75%;}
        .card.pos-rel { position: relative; }
        .soldout-overlay{
            position:absolute; inset:0; background: rgba(108,117,125,.35);
            border-radius: .375rem; display:flex; align-items:center; justify-content:center; pointer-events:none;
        }
        .soldout-badge{
            background: rgba(33,37,41,.75); color:#fff; padding:.35rem .7rem; border-radius:999px;
            font-weight:700; font-size:.95rem;
        }
    </style>
</head>
<body>

<div th:replace="~{layou/header :: header}"></div>

<div class="page-header">
    <div class="container">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h2 class="mb-1">판매한 상품</h2>
                <p class="mb-0 text-muted">거래 완료된 내 판매 상품 목록</p>
            </div>

            <!-- 목록 아이콘 (버블 툴팁) -->
            <a class="icon-btn"
               th:href="@{/trade/list}"
               title="목록" aria-label="목록"
               data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="bubble">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor"
                     class="bi bi-list" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                    <path fill-rule="evenodd"
                          d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5
                   m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5
                   m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/>
                </svg>
            </a>
        </div>
    </div>
</div>

<main class="container py-3" th:with="noImg=@{/images/no-image.png}">
    <!-- 카드 그리드 (trade/list와 동일 구조) -->
    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4">
        <div class="col" th:each="t : ${trades}"
             th:with="
           stat=${t.status != null ? t.status.toString() : ''},
           isSold=${stat == 'SOLD_OUT'},
           isSale=${stat == 'FOR_SALE'},
           isResv=${stat == 'RESERVED'}">

            <div class="card h-100 shadow-sm pos-rel">
                <!-- 거래완료 오버레이 -->
                <div class="soldout-overlay" th:if="${isSold}">
                    <span class="soldout-badge">거래 완료</span>
                </div>

                <div class="ratio ratio-4x3">
                    <img class="card-img-top" alt="thumbnail" loading="lazy"
                         th:src="${ (thumbnails != null and thumbnails.containsKey(t.id)) ? thumbnails[t.id]
                        : (#strings.isEmpty(t.thumbnail) ? noImg : t.thumbnail) }"
                         onerror="this.onerror=null;this.src='/images/no-image.png'">
                </div>

                <div class="card-body">
                    <h6 class="card-title mb-1 text-truncate" th:text="${t.title}">제목</h6>

                    <div class="d-flex align-items-center gap-2 mb-2">
            <span class="badge text-bg-secondary"
                  th:text="${
                    (categoryLabels != null and categoryLabels.containsKey(t.id)) ? categoryLabels[t.id]
                    : (t.category != null ? t.category.toString() : '미분류')
                  }">카테고리</span>

                        <span class="badge"
                              th:classappend="${isSale} ? ' text-bg-primary'
                       : (${isResv} ? ' text-bg-warning' : ' text-bg-secondary')"
                              th:text="${isSale ? '판매중' : (isResv ? '예약중' : (isSold ? '판매완료' : '미정'))}">
              상태
            </span>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
            <span class="fw-semibold"
                  th:text="${(priceTexts != null and priceTexts.containsKey(t.id)) ? priceTexts[t.id]
                            : (t.price != null ? #numbers.formatInteger(t.price) + '원' : '가격문의')}">0원</span>
                    </div>

                    <p class="card-text small text-muted mb-0">
                        작성자: <span th:text="${t.sellerNickname != null ? t.sellerNickname : '알수없음'}">nickname</span>
                    </p>
                </div>

                <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                    <a class="btn btn-sm btn-outline-primary" th:if="${!isSold}"
                       th:href="@{/trade/read/{id}(id=${t.id})}">상세보기</a>
                    <button type="button" class="btn btn-sm btn-outline-secondary" th:if="${isSold}"
                            onclick="alert('이미 거래가 된 상품입니다');">상세보기</button>

                    <span class="small">❤️
            <span th:text="${(favoriteCounts != null and favoriteCounts.containsKey(t.id)) ? favoriteCounts[t.id] : 0}">0</span>
          </span>
                </div>
            </div>
        </div>
    </div>

    <!-- 빈 상태 -->
    <div th:if="${trades == null or trades.isEmpty()}" class="text-center py-5 mt-4">
        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">판매 완료된 상품이 없습니다</h5>
        <p class="text-muted">판매 완료 처리된 상품이 이곳에 표시됩니다.</p>
        <a th:href="@{/trade/list}" class="btn btn-primary mt-2">상품 둘러보기</a>
    </div>
</main>

<div th:replace="~{layou/footer :: footer}"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 툴팁 초기화 (버블)
    (function () {
        if (!(window.bootstrap && bootstrap.Tooltip)) return;
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function (el) {
            const inst = bootstrap.Tooltip.getInstance(el);
            if (inst) inst.dispose();
            new bootstrap.Tooltip(el, { container: 'body' });
        });
    })();
</script>
</body>
</html>
