<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <title>중고거래 목록</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .card-img-top{object-fit:cover;}
        .ratio-4x3{--bs-aspect-ratio:75%;}
        .card.pos-rel { position: relative; }

        /* 거래완료 오버레이 */
        .soldout-overlay{
            position:absolute; inset:0;
            background: rgba(108,117,125,.35);
            border-radius: .375rem;
            display:flex; align-items:center; justify-content:center;
            pointer-events:none;
        }
        .soldout-badge{
            background: rgba(33,37,41,.75); color:#fff;
            padding:.35rem .7rem; border-radius:999px;
            font-weight:700; font-size:.95rem;
        }

        .icon-btn{
            display:inline-flex; align-items:center; justify-content:center;
            width:34px; height:34px; border-radius:10px;
            border:1px solid #e9edf3; background:#fff; color:#6c757d; text-decoration:none;
            transition:.15s;
        }
        .icon-btn:hover{ color:#0d6efd; border-color:#d7e6ff; background:#f5f9ff; }
        .icon-btn svg{ width:18px; height:18px; }
        .gap-2 > .icon-btn{ margin-left:2px; margin-right:2px; }
    </style>
</head>
<body>

<!-- 공통 헤더 -->
<div th:replace="~{layou/header :: header}"></div>

<main class="container py-3" th:with="noImg=@{/images/no-image.png}">
    <!-- 상단 액션 바 -->
    <div class="d-flex justify-content-between align-items-center mb-3">

        <div class="d-flex align-items-center gap-2">
            <!-- 선택된 카테고리 배지(한글 라벨) -->
            <span class="badge text-bg-light"
                  th:if="${selectedCategory != null and !#strings.isEmpty(selectedCategory)}">
        선택된 카테고리: <strong th:text="${selectedCategory}">전체</strong>
      </span>

            <!-- 검색어/범위 배지 -->
            <span class="badge text-bg-light" th:if="${q != null and !#strings.isEmpty(q)}">
        검색: <strong th:text="${q}">키워드</strong>
        <small class="ms-1" th:text="${'(' + (scope != null ? scope : 'BOTH') + ')'}">(BOTH)</small>
      </span>
        </div>

        <div class="d-flex align-items-center gap-2">
            <!-- 글쓰기 -->
            <a sec:authorize="isAuthenticated()" class="icon-btn"
               th:href="@{/trade/register}" title="글쓰기" aria-label="글쓰기"
               data-bs-toggle="tooltip" data-bs-placement="bottom">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                    <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                    <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                </svg>
            </a>

            <!-- ✅ 채팅 리스트 -->
            <a class="icon-btn"
               th:href="@{/chat/list}"
               title="채팅 목록" aria-label="채팅 목록"
               data-bs-toggle="tooltip" data-bs-placement="bottom">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-dots" viewBox="0 0 16 16" aria-hidden="true">
                    <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
                    <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9 9 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.4 10.4 0 0 1-.524 2.318l-.003.011a11 11 0 0 1-.244.637c-.079.186.074.394.273.362a22 22 0 0 0 .693-.125m.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6-3.004 6-7 6a8 8 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a11 11 0 0 0 .398-2"/>
                </svg>
            </a>

            <!-- 검색(모달) -->
            <button type="button" class="icon-btn" title="검색" aria-label="검색"
                    data-bs-toggle="modal" data-bs-target="#searchModal">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                     fill="currentColor" class="bi bi-search" viewBox="0 0 16 16" aria-hidden="true">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- 카드 그리드 -->
    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4">
        <div class="col" th:each="t : ${trades}"
             th:with="stat=${t.status != null ? t.status.toString() : ''},
                      isSold=${stat == 'SOLD_OUT'},
                      isSale=${stat == 'FOR_SALE'},
                      isResv=${stat == 'RESERVED'}">
            <div class="card h-100 shadow-sm pos-rel">
                <!-- 거래완료 오버레이 -->
                <div class="soldout-overlay" th:if="${isSold}">
                    <span class="soldout-badge">거래 완료</span>
                </div>

                <div class="ratio ratio-4x3">
                    <img class="card-img-top" alt="thumbnail" loading="lazy"
                         th:src="${ (thumbnails != null and thumbnails.containsKey(t.id)) ? thumbnails[t.id]
                         : (#strings.isEmpty(t.thumbnail) ? noImg : t.thumbnail) }"
                         onerror="this.onerror=null;this.src='/images/no-image.png'">
                </div>

                <div class="card-body">
                    <h6 class="card-title mb-1 text-truncate" th:text="${t.title}">제목</h6>

                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="badge text-bg-secondary"
                              th:text="${(categoryLabels != null and categoryLabels.containsKey(t.id)) ? categoryLabels[t.id]
                                        : (t.category != null ? t.category.toString() : '미분류')}">
                          카테고리
                        </span>

                        <span class="badge"
                              th:classappend="${isSale} ? ' text-bg-primary'
                                   : (${isResv} ? ' text-bg-warning' : ' text-bg-secondary')"
                              th:text="${isSale ? '판매중' : (isResv ? '예약중' : (isSold ? '판매완료' : '미정'))}">
                          상태
                        </span>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-semibold"
                              th:text="${(priceTexts != null and priceTexts.containsKey(t.id)) ? priceTexts[t.id]
                                        : (t.price != null ? #numbers.formatInteger(t.price) + '원' : '가격문의')}">
                          0원
                        </span>
                    </div>

                    <p class="card-text small text-muted mb-0">
                        작성자: <span th:text="${t.sellerNickname != null ? t.sellerNickname : '알수없음'}">nickname</span>
                    </p>
                </div>

                <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                    <a class="btn btn-sm btn-outline-primary" th:if="${!isSold}"
                       th:href="@{/trade/read/{id}(id=${t.id})}">
                        상세보기
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-secondary" th:if="${isSold}"
                            onclick="alert('이미 거래가 된 상품입니다');">
                        상세보기
                    </button>

                    <span class="small">❤️
                        <span th:text="${(favoriteCounts != null and favoriteCounts.containsKey(t.id)) ? favoriteCounts[t.id] : 0}">0</span>
                    </span>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- 검색 모달 -->
<div class="modal fade" id="searchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content" method="get" th:action="@{/trade/list}">
            <div class="modal-header">
                <h5 class="modal-title">상품 검색</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>

            <div class="modal-body">
                <!-- 카테고리 선택 -->
                <div class="mb-3">
                    <label class="form-label">카테고리</label>
                    <select class="form-select" name="category">
                        <option value=""
                                th:selected="${selectedCategory == null or #strings.isEmpty(selectedCategory)}">전체</option>

                        <option th:each="name : ${categories}"
                                th:value="${name}"
                                th:text="${name}"
                                th:selected="${selectedCategory != null and #strings.equalsIgnoreCase(selectedCategory, name)}">
                        </option>
                    </select>
                </div>

                <!-- 검색어 -->
                <div class="mb-3">
                    <label class="form-label">검색어</label>
                    <input type="text" name="query" class="form-control"
                           placeholder="검색어를 입력하세요" th:value="${q}">
                </div>

                <!-- 검색 범위 -->
                <div class="mb-2">
                    <label class="form-label d-block">검색 범위</label>

                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="scope" id="scopeTitle" value="TITLE"
                               th:checked="${#strings.equalsIgnoreCase(scope, 'TITLE')}">
                        <label class="form-check-label" for="scopeTitle">제목</label>
                    </div>

                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="scope" id="scopeContent" value="CONTENT"
                               th:checked="${#strings.equalsIgnoreCase(scope, 'CONTENT')}">
                        <label class="form-check-label" for="scopeContent">내용</label>
                    </div>

                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="scope" id="scopeBoth" value="BOTH"
                               th:checked="${scope == null or #strings.equalsIgnoreCase(scope, 'BOTH')}">
                        <label class="form-check-label" for="scopeBoth">제목 + 내용</label>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <a class="btn btn-outline-secondary" th:href="@{/trade/list}">초기화</a>
                <button type="submit" class="btn btn-primary">검색</button>
            </div>
        </form>
    </div>
</div>

<!-- 공통 푸터 -->
<div th:replace="~{layou/footer :: footer}"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 헤더 아이콘 툴팁
    (function(){
        if (window.bootstrap && bootstrap.Tooltip) {
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el){
                try{
                    const t = bootstrap.Tooltip.getInstance(el);
                    if (t) t.dispose();
                    new bootstrap.Tooltip(el, { container: 'body' });
                }catch(e){}
            });
        }
    })();
</script>
</body>
</html>
