<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <title>중고거래 목록</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-img-top{object-fit:cover;}
        .ratio-4x3{--bs-aspect-ratio:75%;}

        /* 거래완료 오버레이 */
        .card.pos-rel { position: relative; }
        .soldout-overlay{
            position:absolute; inset:0;
            background: rgba(108,117,125,.35);
            border-radius: .375rem;
            display:flex; align-items:center; justify-content:center;
            pointer-events:none;
        }
        .soldout-badge{
            background: rgba(33,37,41,.75); color:#fff;
            padding:.35rem .7rem; border-radius:999px;
            font-weight:700; font-size:.95rem;
        }

        /* 상단 아이콘 버튼 (아이콘만) */
        .icon-btn{
            display:inline-flex; align-items:center; justify-content:center;
            width:34px; height:34px; border-radius:10px;
            border:1px solid #e9edf3; background:#fff; color:#6c757d; text-decoration:none;
            transition:.15s;
        }
        .icon-btn:hover{ color:#0d6efd; border-color:#d7e6ff; background:#f5f9ff; }
        .icon-btn svg{ width:18px; height:18px; }

        /* (참고) 다른 버튼과 간격 맞추기 */
        .gap-2 > .icon-btn{ margin-left:2px; margin-right:2px; }
    </style>
</head>
<body>
<!-- 공통 헤더 -->
<div th:replace="~{/layout/header :: header}"></div>

<main class="container py-3" th:with="noImg=@{/images/no-image.png}">
    <!-- 상단 액션 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
      <span class="badge text-bg-light" th:if="${param.category != null}">
        선택된 카테고리: <strong th:text="${param.category}">전체</strong>
      </span>
        </div>

        <div class="d-flex align-items-center gap-2">
            <!-- 글쓰기: 아이콘만 보이게 + 툴팁 "글쓰기" -->
            <a sec:authorize="isAuthenticated()" class="icon-btn"
               th:href="@{/trade/register}" title="글쓰기" aria-label="글쓰기"
               data-bs-toggle="tooltip" data-bs-placement="bottom">
                <!-- chat-square-text 아이콘 -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-chat-square-text" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                    <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1h-2.5a2 2 0 0 0-1.6.8L8 14.333 6.1 11.8a2 2 0 0 0-1.6-.8H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h2.5a1 1 0 0 1 .8.4l1.9 2.533a1 1 0 0 0 1.6 0l1.9-2.533a1 1 0 0 1 .8-.4H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                    <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5M3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6m0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5"/>
                </svg>
            </a>
            <a sec:authorize="isAnonymous()" class="icon-btn"
               th:href="@{/member/login}" title="글쓰기" aria-label="글쓰기"
               data-bs-toggle="tooltip" data-bs-placement="bottom">
                <!-- chat-square-text 아이콘 -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-chat-square-text" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                    <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1h-2.5a2 2 0 0 0-1.6.8L8 14.333 6.1 11.8a2 2 0 0 0-1.6-.8H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h2.5a1 1 0 0 1 .8.4l1.9 2.533a1 1 0 0 0 1.6 0l1.9-2.533a1 1 0 0 1 .8-.4H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                    <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5M3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6m0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5"/>
                </svg>
            </a>

            <!-- 아이콘: 찜목록 (bag) -->
            <a class="icon-btn" th:href="@{/member/favorites}" title="찜목록" aria-label="찜목록"
               data-bs-toggle="tooltip" data-bs-placement="bottom">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-bag" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                    <path d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1m3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4zM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1z"/>
                </svg>
            </a>

            <!-- 아이콘: 채팅방 (envelope) -->
            <a class="icon-btn" th:href="@{/chat/list}" title="채팅방" aria-label="채팅방"
               data-bs-toggle="tooltip" data-bs-placement="bottom">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-envelope" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                    <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1zm13 2.383-4.708 2.825L15 11.105zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741M1 11.105l4.708-2.897L1 5.383z"/>
                </svg>
            </a>

            <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">카테고리</button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" th:href="@{/trade/list}">전체보기</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li th:each="c : ${categories}">
                        <a class="dropdown-item" th:classappend="${param.category} == ${c} ? ' active'"
                           th:text="${c}" th:href="@{/trade/list(category=${c})}">카테고리</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 카드 그리드 -->
    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4">
        <div class="col" th:each="t : ${trades}"
             th:with="
           stat=${t.status != null ? t.status.toString() : ''},
           isSold=${stat == 'SOLD_OUT'},
           isSale=${stat == 'FOR_SALE'},
           isResv=${stat == 'RESERVED'}">
            <div class="card h-100 shadow-sm pos-rel">
                <!-- 거래완료 오버레이 -->
                <div class="soldout-overlay" th:if="${isSold}">
                    <span class="soldout-badge">거래 완료</span>
                </div>

                <div class="ratio ratio-4x3">
                    <img class="card-img-top" alt="thumbnail"
                         th:src="${ (thumbnails != null and thumbnails.containsKey(t.id)) ? thumbnails[t.id]
                         : (#strings.isEmpty(t.thumbnail) ? noImg : t.thumbnail) }"
                         onerror="this.onerror=null;this.src='/images/no-image.png'">
                </div>

                <div class="card-body">
                    <h6 class="card-title mb-1 text-truncate" th:text="${t.title}">제목</h6>

                    <div class="d-flex align-items-center gap-2 mb-2">
            <span class="badge text-bg-secondary"
                  th:text="${(categoryLabels != null and categoryLabels.containsKey(t.id)) ? categoryLabels[t.id]
                            : (t.category != null ? t.category.toString() : '미분류')}">
              카테고리
            </span>

                        <span class="badge"
                              th:classappend="${isSale} ? ' text-bg-primary' : (${isResv} ? ' text-bg-warning' : ' text-bg-secondary')"
                              th:text="${isSale ? '판매중' : (isResv ? '예약중' : (isSold ? '판매완료' : '미정'))}">
              상태
            </span>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
            <span class="fw-semibold"
                  th:text="${(priceTexts != null and priceTexts.containsKey(t.id)) ? priceTexts[t.id]
                            : (t.price != null ? #numbers.formatInteger(t.price) + '원' : '가격문의')}">
              0원
            </span>
                    </div>

                    <p class="card-text small text-muted mb-0">
                        작성자: <span th:text="${t.sellerNickname != null ? t.sellerNickname : '알수없음'}">nickname</span>
                    </p>
                </div>

                <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                    <!-- SOLD_OUT 이면 알럿만 띄우고 이동 금지 -->
                    <a class="btn btn-sm btn-outline-primary" th:if="${!isSold}"
                       th:href="@{/trade/read/{id}(id=${t.id})}">
                        상세보기
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-secondary" th:if="${isSold}"
                            onclick="alert('이미 거래가 된 상품입니다');">
                        상세보기
                    </button>

                    <span class="small">❤️
            <span th:text="${(favoriteCounts != null and favoriteCounts.containsKey(t.id)) ? favoriteCounts[t.id] : 0}">0</span>
          </span>
                </div>
            </div>
        </div>
    </div>

    <!-- 페이지네이션 -->
    <nav class="mt-4" th:if="${page != null and page.totalPages > 1}">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${page.first} ? 'disabled'">
                <a class="page-link" th:href="@{/trade/list(page=${page.number - 1}, size=${page.size}, category=${param.category})}">이전</a>
            </li>
            <li class="page-item" th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}"
                th:classappend="${i} == ${page.number} ? 'active'">
                <a class="page-link" th:text="${i + 1}"
                   th:href="@{/trade/list(page=${i}, size=${page.size}, category=${param.category})}">1</a>
            </li>
            <li class="page-item" th:classappend="${page.last} ? 'disabled'">
                <a class="page-link" th:href="@{/trade/list(page=${page.number + 1}, size=${page.size}, category=${param.category})}">다음</a>
            </li>
        </ul>
    </nav>
</main>

<!-- 공통 푸터 -->
<div th:replace="~{/layout/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 아이콘 툴팁 활성화
    (function(){
        if (window.bootstrap) {
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el){
                try{ new bootstrap.Tooltip(el); }catch(e){}
            });
        }
    })();
</script>
</body>
</html>
