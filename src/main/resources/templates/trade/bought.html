<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>구매한 상품</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .page-header{width:1200px;background:#fff;margin:30px auto;}

        /* 목록 아이콘: 테두리 없음 + 말풍선 툴팁 */
        .icon-btn{
            display:inline-flex; align-items:center; justify-content:center;
            width:44px; height:44px; border-radius:10px;
            border:none; background:transparent; color:#212529;
            transition:none;
        }
        .icon-btn:hover{ color:#212529; background:transparent; }
        .icon-btn svg{ width:28px; height:28px; }

        :root .tooltip.bubble .tooltip-inner{
            position:relative; background:#111 !important; color:#fff !important;
            padding:6px 10px !important; font-size:.875rem !important; line-height:1.2 !important;
            border-radius:8px !important; box-shadow:0 4px 12px rgba(0,0,0,.2) !important;
            white-space:nowrap;
        }
        :root .tooltip.bubble .tooltip-arrow{ display:none !important; }
        :root .tooltip.bubble.bs-tooltip-bottom .tooltip-inner::after{
            content:""; position:absolute; left:50%; transform:translateX(-50%); top:-8px;
            width:0; height:0; border-style:solid; border-width:0 8px 8px 8px;
            border-color:transparent transparent #111 transparent;
        }

        /* 카드 */
        .favorite-list{margin-top:.25rem;}
        .favorite-card{border-left:4px solid #0dcaf0; position:relative; overflow:visible; transition:none;}
        .favorite-card:hover{transform:none; box-shadow:0 4px 8px rgba(0,0,0,.1);}
        .favorite-card.clickable{cursor:pointer;}
        .product-thumbnail{width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:8px;}
        .product-status{font-size:.8rem; padding:.25rem .5rem; border-radius:15px;}
        .pos-rel{position:relative;}
        .soldout-overlay{position:absolute; inset:0; background:rgba(108,117,125,.35); border-radius:.375rem; display:flex; align-items:center; justify-content:center; pointer-events:none;}
        .soldout-badge{background:rgba(33,37,41,.75); color:#fff; padding:.35rem .7rem; border-radius:999px; font-weight:700; font-size:.95rem;}

        .icon-heart{
            display:inline-flex; align-items:center; justify-content:center;
            width:36px; height:36px; border-radius:10px;
            border:1px solid #e9edf3; background:#fff; color:#e03131;
            transition:.15s;
        }
        .icon-heart:hover{ background:#fff5f5; border-color:#ffd6d6; }
        .icon-heart i{ font-size:16px; line-height:1; }
    </style>
</head>
<body>
<div th:replace="~{/layout/header :: header}"></div>

<div class="page-header">
    <div class="container">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h2 class="mb-1">구매한 상품</h2>
                <p class="mb-0 text-muted">채팅에서 거래 완료된 내가 구매한 상품</p>
            </div>

            <!-- 목록 아이콘 (버블 툴팁) -->
            <a class="icon-btn"
               th:href="@{/trade/list}"
               title="목록" aria-label="목록"
               data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="bubble">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor"
                     class="bi bi-list" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                    <path fill-rule="evenodd"
                          d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5
                   m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5
                   m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/>
                </svg>
            </a>
        </div>
    </div>
</div>

<div class="container">
    <!-- 목록 -->
    <div class="row g-4 favorite-list" th:if="${trades != null and !trades.isEmpty()}">
        <div class="col-md-6" th:each="t : ${trades}">
            <div class="card favorite-card pos-rel clickable"
                 th:with="isSold=${t.status != null and (#strings.equalsIgnoreCase(t.status, 'SOLD_OUT') or #strings.equalsIgnoreCase(t.status, '판매완료'))}"
                 th:attr="data-href=${!isSold}? @{|/trade/read/${t.id}|} : null, data-sold=${isSold}">
                <div class="soldout-overlay" th:if="${isSold}">
                    <span class="soldout-badge">거래 완료</span>
                </div>

                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-4">
                            <img class="product-thumbnail"
                                 th:src="${ (thumbnails != null and thumbnails.containsKey(t.id)) ? thumbnails[t.id] : '/images/no-image.png' }"
                                 alt="상품 이미지"
                                 onerror="this.onerror=null;this.src='/images/no-image.png'">
                        </div>
                        <div class="col-8">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0" th:text="${t.title}">상품명</h6>
                                <!-- 구매 목록에서도 보통 찜 해제 버튼은 숨김 -->
                            </div>

                            <div class="mb-2">
                                <span class="badge product-status bg-secondary">판매완료</span>
                                <span class="badge bg-light text-dark ms-1"
                                      th:text="${categoryLabels != null ? categoryLabels[t.id] : '카테고리'}">카테고리</span>
                            </div>

                            <div class="seller-info mb-2 text-muted">
                                <i class="fas fa-user"></i>
                                <span th:text="${t.sellerNickname != null ? t.sellerNickname : '판매자'}">판매자</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <strong class="text-primary fs-5"
                                        th:text="${priceTexts != null and priceTexts.containsKey(t.id) ? priceTexts[t.id] : '가격문의'}">0원</strong>
                                <span class="text-muted">❤️ <span th:text="${favoriteCounts != null ? (favoriteCounts[t.id] ?: 0) : 0}">0</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /col -->
    </div>

    <!-- 빈 상태 -->
    <div th:if="${trades == null or trades.isEmpty()}" class="text-center py-5 mt-4">
        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">구매 완료된 상품이 없습니다</h5>
        <p class="text-muted">채팅에서 거래 완료된 상품이 이곳에 표시됩니다.</p>
        <a th:href="@{/trade/list}" class="btn btn-primary mt-2">상품 둘러보기</a>
    </div>
</div>

<div th:replace="~{/layout/footer :: footer}"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 카드 클릭 이동 (판매완료면 알림)
    (function(){
        document.querySelectorAll('.favorite-card.clickable').forEach(function(card){
            card.addEventListener('click', function(e){
                const isSold = card.getAttribute('data-sold') === 'true';
                if (isSold) { alert('이미 거래가 된 상품입니다'); return; }
                const href = card.getAttribute('data-href');
                if (href) window.location.href = href;
            });
        });
    })();

    // 툴팁 초기화 (버블)
    (function () {
        if (!(window.bootstrap && bootstrap.Tooltip)) return;
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function (el) {
            const inst = bootstrap.Tooltip.getInstance(el);
            if (inst) inst.dispose();
            new bootstrap.Tooltip(el, { container: 'body' });
        });
    })();
</script>
</body>
</html>
