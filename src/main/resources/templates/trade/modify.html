<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${dto != null ? dto.title + ' 수정' : '수정'}">수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* register와 동일한 업로더/썸네일 스타일 */
        .uploader{border:1px dashed #c9c9c9;border-radius:10px;padding:16px;background:#fafafa;}
        .uploader.dragover{border-color:#0d6efd;background:#eef5ff;}
        .upload-tile{display:flex;align-items:center;justify-content:center;width:100%;height:140px;cursor:pointer;}
        .thumb-grid{display:flex;flex-wrap:wrap;gap:8px;}
        .thumb{position:relative;width:90px;height:90px;border:1px solid #eee;border-radius:8px;overflow:hidden;background:#fff;}
        .thumb img{width:100%;height:100%;object-fit:cover;}
        .thumb .remove{position:absolute;right:4px;top:4px;width:22px;height:22px;border:none;border-radius:50%;background:#00000080;color:#fff;line-height:22px;text-align:center;cursor:pointer;}
        .badge-top{position:absolute;left:6px;top:6px;}
        .thumb.deleted img{outline:3px solid #dc3545;}
    </style>
</head>
<body>
<!-- 공통 헤더 -->
<div th:replace="~{/layout/header :: header}"></div>

<main class="container py-4" style="max-width:1100px;">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h3 class="mb-0" th:text="${dto.title}">수정</h3>
    </div>

    <form id="modifyForm"
          th:action="@{'/trade/modify/' + ${dto.id}}"
          method="post" enctype="multipart/form-data"
          class="needs-validation" novalidate>

        <th:block th:if="${_csrf != null}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        </th:block>

        <div class="row g-4">
            <!-- 좌측 -->
            <div class="col-12 col-lg-6">
                <div class="card shadow-sm"><div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">제목</label>
                        <input name="title" class="form-control" required th:value="${dto.title}">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">가격</label>
                        <div class="input-group">
                            <input name="price" type="number" min="0" class="form-control" required th:value="${dto.price}">
                            <span class="input-group-text">원</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">카테고리</label>
                        <!-- 현재 값 data-current로 내려보내고, 매칭 실패 시 JS가 강제 선택/삽입 -->
                        <select id="categorySelect" name="category" class="form-select" required
                                th:attr="data-current=${dto.category}">
                            <option value="" th:selected="${dto.category == null}" disabled hidden>카테고리 선택</option>
                            <!-- 지금은 라벨 리스트(예: 예술/운동/…)를 내려받는다고 가정 -->
                            <option th:each="cat : ${categories}"
                                    th:value="${cat}" th:text="${cat}"
                                    th:selected="${#strings.equalsIgnoreCase(#strings.trim(cat), #strings.trim(dto.category))}"></option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">상태</label>
                        <select name="status" class="form-select" required>
                            <option value="FOR_SALE" th:selected="${dto.status == 'FOR_SALE'}">판매중</option>
                            <option value="RESERVED" th:selected="${dto.status == 'RESERVED'}">예약중</option>
                            <option value="SOLD_OUT" th:selected="${dto.status == 'SOLD_OUT'}">판매완료</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">작성자(닉네임)</label>
                        <input name="sellerNickname" class="form-control" th:value="${nickname}">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">내용</label>
                        <textarea name="description" rows="7" class="form-control" required
                                  th:text="${dto != null && dto.description != null ? dto.description : ''}"></textarea>
                    </div>
                </div></div>
            </div>

            <!-- 우측: 이미지 (register와 동일 섹션만 유지) -->
            <div class="col-12 col-lg-6">
                <div class="card shadow-sm"><div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div class="fw-semibold">상품 이미지</div>
                        <div class="counter">
                            <span id="count" th:text="${images != null ? images.size() : 0}">0</span> / 10
                        </div>
                    </div>

                    <div id="dropzone" class="uploader mb-3">
                        <label for="fileInput" id="uploadTile" class="upload-tile" aria-label="이미지 업로드">
                            <div class="text-center">
                                <div class="mb-1">📷 사진 업로드</div>
                                <small class="text-muted">클릭 또는 드래그하여 선택 (최대 10장)</small>
                            </div>
                        </label>
                        <input id="fileInput" name="images" type="file" accept="image/*" multiple class="visually-hidden">
                    </div>

                    <!-- 기존 이미지도 동일 썸네일로 표시 -->
                    <div id="thumbs" class="thumb-grid">
                        <th:block th:if="${!#lists.isEmpty(images)}">
                            <div class="thumb existing" th:each="img,stat : ${images}" th:attr="data-id=${img.id}">
                                <img th:src="${img.imageUrl}" alt="old" onerror="this.onerror=null;this.src='/images/no-image.png'">
                                <button type="button" class="remove" aria-label="삭제">&times;</button>
                                <!-- 삭제 전달용(숨김) -->
                                <input class="del-check visually-hidden" type="checkbox" name="deleteImageIds" th:value="${img.id}">
                                <span class="badge text-bg-primary badge-top" th:if="${stat.index == 0}">대표</span>
                            </div>
                        </th:block>
                    </div>
                </div></div>
            </div>
        </div>

        <div class="d-flex gap-2 mt-4">
            <a th:href="@{/trade/read/{id}(id=${dto.id})}" class="btn btn-secondary">취소</a>
            <button type="submit" class="btn btn-primary">저장</button>
        </div>
    </form>
</main>

<!-- 공통 푸터 -->
<div th:replace="~{/layout/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    (function () {
        // ===== 카테고리 강제 선택 (코드/라벨 모두 대응) =====
        // 서버 enum -> 라벨 매핑 (컨트롤러와 동일)
        const CAT_LABEL = {
            ART:'예술', COOK:'요리', MUSIC:'음악', PET:'반려동물',
            SPORTS:'스포츠', STUDY:'스터디', TRAVEL:'여행'
        };
        const lower = (s)=> (s||'').trim().toLowerCase();

        function forceSelectCategory(select){
            if (!select) return;
            // dto.category가 data-current-enum 또는 data-current로 내려온다고 가정
            const fromEnum  = (select.dataset.currentEnum || select.getAttribute('data-current') || '').trim();  // 예: "SPORTS" 또는 "운동"
            if (!fromEnum) return;

            // enum코드면 라벨로 치환, 이미 라벨이면 그대로
            const asLabel = CAT_LABEL[fromEnum] || fromEnum;

            const opts = Array.from(select.options);
            // value/text 어디에 담겨와도 매칭
            let target =
                opts.find(o => lower(o.value) === lower(fromEnum))  ||
                opts.find(o => lower(o.text)  === lower(fromEnum))  ||
                opts.find(o => lower(o.value) === lower(asLabel))   ||
                opts.find(o => lower(o.text)  === lower(asLabel));

            if (target) select.value = target.value;     // ★ 무조건 현재 값으로 강제 선택
        }

        // 제출 전 카테고리 필수
        function ensureCategorySelected(form) {
            const sel = form.querySelector('#categorySelect');
            if (!sel) return true;
            if (!sel.value || !sel.value.trim()) {
                alert('카테고리를 설정해 주세요.');
                sel.focus();
                return false;
            }
            return true;
        }

        // ===== 이미지(기존+신규) 한 그리드에서 관리 =====
        const form     = document.getElementById('modifyForm');
        const sel      = document.getElementById('categorySelect');
        const fileInput= document.getElementById('fileInput');
        const dropzone = document.getElementById('dropzone');
        const thumbs   = document.getElementById('thumbs');
        const counter  = document.getElementById('count');

        // 등록 당시 카테고리로 강제 선택
        forceSelectCategory(sel);

        // --- 기존 썸네일(서버 렌더된 .thumb.existing) 토글 삭제 ---
        function bindExistingThumbEvents(){
            thumbs?.querySelectorAll('.thumb.existing').forEach(tile=>{
                const img = tile.querySelector('img');
                const btn = tile.querySelector('.remove');
                const chk = tile.querySelector('.del-check');  // 숨김 체크박스(name=deleteImageIds)
                const toggle = () => {
                    if (!chk) return;
                    chk.checked = !chk.checked;
                    tile.classList.toggle('deleted', chk.checked);
                    updateBadge();
                    updateCount();
                };
                img?.addEventListener('click', toggle);
                btn?.addEventListener('click', toggle);
                chk?.addEventListener('change', ()=>{ tile.classList.toggle('deleted', chk.checked); updateBadge(); updateCount(); });
            });
        }
        bindExistingThumbEvents();

        // --- 신규 업로드 버퍼 ---
        let filesBuffer = [];

        function currentExistingCount(){
            return thumbs ? thumbs.querySelectorAll('.thumb.existing:not(.deleted)').length : 0;
        }
        function currentTotalCount(){
            return currentExistingCount() + filesBuffer.length;
        }
        function updateCount(){
            if (counter) counter.textContent = String(currentTotalCount());
        }

        // 대표 배지: 삭제되지 않은 첫 타일에만 '대표'
        function updateBadge(){
            if (!thumbs) return;
            thumbs.querySelectorAll('.badge-top').forEach(b=>b.remove());
            const first = thumbs.querySelector('.thumb:not(.deleted)');
            if (first){
                const badge = document.createElement('span');
                badge.className = 'badge text-bg-primary badge-top';
                badge.textContent = '대표';
                first.appendChild(badge);
            }
        }

        // 신규 썸네일 그리기
        function renderNewThumbs(){
            if (!thumbs) return;
            // 기존 new 타일 제거
            thumbs.querySelectorAll('.thumb.new').forEach(n=>n.remove());
            filesBuffer.forEach((file,i)=>{
                const url = URL.createObjectURL(file);
                const tile = document.createElement('div'); tile.className='thumb new';
                const img  = document.createElement('img');  img.src=url; img.alt='preview';
                const btn  = document.createElement('button'); btn.type='button'; btn.className='remove'; btn.innerHTML='&times;';
                btn.addEventListener('click', ()=>{
                    const allNew = Array.from(thumbs.querySelectorAll('.thumb.new'));
                    const idx = allNew.indexOf(tile);
                    if (idx > -1) filesBuffer.splice(idx,1);
                    tile.remove();
                    updateBadge(); updateCount(); syncToInput();
                });
                tile.appendChild(img); tile.appendChild(btn);
                thumbs.appendChild(tile);
            });
        }

        // DataTransfer로 <input type=file> 재구성
        function syncToInput(){
            if (!fileInput || typeof DataTransfer==='undefined') return;
            const dt = new DataTransfer();
            filesBuffer.forEach(f=>dt.items.add(f));
            fileInput.files = dt.files;
        }

        // 업로더 이벤트
        if (dropzone && fileInput){
            document.addEventListener('click', e=>{
                if (e.target.closest('#uploadTile')) { e.preventDefault(); fileInput.click(); }
            });
            ['dragenter','dragover'].forEach(evt=> dropzone.addEventListener(evt, e=>{
                e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover');
            }));
            ['dragleave','drop'].forEach(evt=> dropzone.addEventListener(evt, e=>{
                e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover');
            }));
            dropzone.addEventListener('drop', e=> addFiles(Array.from(e.dataTransfer?.files||[])));
            fileInput.addEventListener('change', e=>{
                addFiles(Array.from(e.target.files||[]));
                if (window.DataTransfer) fileInput.value='';
            });
        }

        function addFiles(incoming){
            if (!incoming?.length) return;
            const images = incoming.filter(f=> f.type?.startsWith('image/'));
            const room   = Math.max(0, 10 - currentTotalCount());
            const toAdd  = images.slice(0, room);
            if (images.length > room) alert('최대 10장까지만 등록 가능합니다.');
            filesBuffer.push(...toAdd);
            renderNewThumbs(); updateBadge(); updateCount(); syncToInput();
        }

        // 초기 배지/카운트 보정
        updateBadge(); updateCount();

        // 제출 전 필수 체크 + 파일 동기화
        form?.addEventListener('submit', (e)=>{
            if (!ensureCategorySelected(form)) { e.preventDefault(); e.stopPropagation(); return; }
            syncToInput();
        });
    })();
</script>


</body>
</html>
