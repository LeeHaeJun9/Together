<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8" />
    <title>상품 수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<section layout:fragment="content">
    <link rel="stylesheet" th:href="@{/css/trade-register.css(v=${#dates.createNow().time})}">

    <div class="container py-4" style="max-width:1100px;">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h3 class="mb-0">상품 수정</h3>
            <a th:href="@{'/trade/read/' + ${trade.id}}" class="btn btn-outline-secondary btn-sm">상세로</a>
        </div>

        <form th:action="@{'/trade/modify/' + ${trade.id}}"
              method="post"
              enctype="multipart/form-data"
              class="needs-validation" novalidate>

            <!-- CSRF -->
            <th:block th:if="${_csrf != null}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            </th:block>

            <div class="row g-4">
                <!-- 좌측 폼 -->
                <div class="col-12 col-lg-6">
                    <div class="card shadow-sm"><div class="card-body">

                        <div class="mb-3">
                            <label class="form-label fw-semibold">제목</label>
                            <input name="title" class="form-control" th:value="${trade.title}" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">가격</label>
                            <div class="input-group">
                                <input name="price" type="number" min="0" class="form-control" th:value="${trade.price}" required>
                                <span class="input-group-text">원</span>
                            </div>
                        </div>

                        <!-- CHANGED: 카테고리 - th:field 제거, name 명시 + 선택값 반영 -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">카테고리</label>
                            <select name="category" id="category" class="form-select" required>
                                <option value="" hidden>카테고리 선택</option>
                                <option th:each="cat : ${categories}"
                                        th:value="${cat}"
                                        th:text="${cat}"
                                        th:selected="${cat} == ${trade.category}"></option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">상태</label>
                            <select name="status" class="form-select" required>
                                <option value="FOR_SALE" th:selected="${trade.status} == 'FOR_SALE'">판매중</option>
                                <option value="RESERVED" th:selected="${trade.status} == 'RESERVED'">예약중</option>
                                <option value="SOLD"     th:selected="${trade.status} == 'SOLD'">판매완료</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">작성자(닉네임)</label>
                            <input name="sellerNickname" class="form-control" th:value="${trade.sellerNickname}">
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">내용</label>
                            <textarea name="description" rows="7" class="form-control" th:text="${trade.description}" required></textarea>
                        </div>

                    </div></div>
                </div>

                <!-- 우측: 기존 이미지 + 새 이미지 업로드 -->
                <div class="col-12 col-lg-6">
                    <div class="card shadow-sm"><div class="card-body">

                        <div class="mb-2 d-flex align-items-center justify-content-between">
                            <div class="fw-semibold">기존 이미지</div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6 col-md-4" th:each="img : ${images}">
                                <div class="position-relative border rounded">
                                    <img th:src="${img.imageUrl}" class="w-100"
                                         style="aspect-ratio:4/3;object-fit:cover;border-radius:.25rem;">
                                </div>
                                <div class="form-check mt-1">
                                    <input class="form-check-input" type="checkbox" name="deleteImageIds" th:value="${img.id}" id="del__[[${img.id}]]">
                                    <label class="form-check-label small text-muted" th:for="${'del__' + img.id}">삭제</label>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div class="fw-semibold">새 이미지 추가</div>
                            <small class="text-muted">총 10장 제한 (기존 + 추가)</small>
                        </div>

                        <div id="dropzone" class="uploader mb-3">
                            <label for="fileInput" id="uploadTile" class="upload-tile" aria-label="이미지 업로드">
                                <div class="text-center">
                                    <div class="mb-1">📷 사진 업로드</div>
                                    <small class="text-muted">클릭 또는 드래그하여 선택</small>
                                </div>
                            </label>
                            <input id="fileInput" name="files" type="file" accept="image/*" multiple class="visually-hidden">
                        </div>

                        <div id="thumbs" class="thumb-grid"></div>

                    </div></div>
                </div>
            </div>

            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary">저장</button>
                <a th:href="@{'/trade/read/' + ${trade.id}}" class="btn btn-secondary">취소</a>
            </div>
        </form>
    </div>

    <!-- 업로더 미리보기 스크립트: register와 동일 로직 -->
    <script>
        (function(){
            if (window.__tradeModifyInited) return;
            window.__tradeModifyInited = true;

            const fileInput = document.getElementById('fileInput');
            const dropzone  = document.getElementById('dropzone');
            const thumbs    = document.getElementById('thumbs');
            if (!fileInput || !dropzone || !thumbs) return;

            let filesBuffer = [];

            document.addEventListener('click', (e) => {
                if (e.target.closest('#uploadTile')) { e.preventDefault(); fileInput.click(); }
            });

            ['dragenter','dragover'].forEach(evt => {
                dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover'); });
            });
            ['dragleave','drop'].forEach(evt => {
                dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover'); });
            });
            dropzone.addEventListener('drop', (e) => {
                const dropped = Array.from(e.dataTransfer?.files || []);
                addFiles(dropped);
            });
            fileInput.addEventListener('change', (e) => {
                addFiles(Array.from(e.target.files || []));
                fileInput.value = '';
            });

            function addFiles(incoming) {
                if (!incoming.length) return;
                const images = incoming.filter(f => f.type.startsWith('image/'));
                filesBuffer.push(...images);
                renderThumbs();
                syncToInput();
            }
            function removeAt(idx) {
                filesBuffer.splice(idx, 1);
                renderThumbs();
                syncToInput();
            }
            function renderThumbs() {
                thumbs.innerHTML = '';
                filesBuffer.forEach((file, i) => {
                    const url = URL.createObjectURL(file);
                    const wrap = document.createElement('div');
                    wrap.className = 'thumb';

                    const img = document.createElement('img');
                    img.src = url;

                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'remove';
                    btn.innerHTML = '&times;';
                    btn.addEventListener('click', () => removeAt(i));

                    wrap.appendChild(img);
                    wrap.appendChild(btn);
                    thumbs.appendChild(wrap);
                });
            }
            function syncToInput() {
                if (typeof DataTransfer === 'undefined') return;
                const dt = new DataTransfer();
                filesBuffer.forEach(f => dt.items.add(f));
                fileInput.files = dt.files;
            }
        })();
    </script>
</section>
</body>
</html>
