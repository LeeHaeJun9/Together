<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${dto != null ? dto.title + ' ìˆ˜ì •' : 'ìˆ˜ì •'}">ìˆ˜ì •</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* registerì™€ ë™ì¼í•œ ì—…ë¡œë”/ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼ */
        .uploader{border:1px dashed #c9c9c9;border-radius:10px;padding:16px;background:#fafafa;}
        .uploader.dragover{border-color:#0d6efd;background:#eef5ff;}
        .upload-tile{display:flex;align-items:center;justify-content:center;width:100%;height:140px;cursor:pointer;}
        .thumb-grid{display:flex;flex-wrap:wrap;gap:8px;}
        .thumb{position:relative;width:90px;height:90px;border:1px solid #eee;border-radius:8px;overflow:hidden;background:#fff;}
        .thumb img{width:100%;height:100%;object-fit:cover;}
        .thumb .remove{position:absolute;right:4px;top:4px;width:22px;height:22px;border:none;border-radius:50%;background:#00000080;color:#fff;line-height:22px;text-align:center;cursor:pointer;}
        .badge-top{position:absolute;left:6px;top:6px;}
    </style>
</head>
<body>
<!-- ê³µí†µ í—¤ë” -->
<div th:replace="~{layou/header :: header}"></div>

<main class="container py-4" style="max-width:1100px;">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h3 class="mb-0" th:text="${dto.title}">ìˆ˜ì •</h3>
    </div>

    <form id="modifyForm"
          th:action="@{'/trade/modify/' + ${dto.id}}"
          method="post" enctype="multipart/form-data"
          class="needs-validation" novalidate>

        <th:block th:if="${_csrf != null}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        </th:block>

        <div class="row g-4">
            <!-- ì¢Œì¸¡ -->
            <div class="col-12 col-lg-6">
                <div class="card shadow-sm"><div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">ì œëª©</label>
                        <input name="title" class="form-control" required th:value="${dto.title}">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">ê°€ê²©</label>
                        <div class="input-group">
                            <input name="price" type="number" min="0" class="form-control" required th:value="${dto.price}">
                            <span class="input-group-text">ì›</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">ì¹´í…Œê³ ë¦¬</label>
                        <select id="categorySelect" name="category" class="form-select" required
                                th:attr="data-current=${dto.category}">
                            <option value="" th:selected="${dto.category == null}" disabled hidden>ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                            <option th:each="cat : ${categories}"
                                    th:value="${cat}" th:text="${cat}"
                                    th:selected="${#strings.equalsIgnoreCase(#strings.trim(cat), #strings.trim(dto.category))}"></option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">ìƒíƒœ</label>
                        <select name="status" class="form-select" required>
                            <option value="FOR_SALE" th:selected="${dto.status == 'FOR_SALE'}">íŒë§¤ì¤‘</option>
                            <option value="RESERVED" th:selected="${dto.status == 'RESERVED'}">ì˜ˆì•½ì¤‘</option>
                            <option value="SOLD_OUT" th:selected="${dto.status == 'SOLD_OUT'}">íŒë§¤ì™„ë£Œ</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">ì‘ì„±ì(ë‹‰ë„¤ì„)</label>
                        <input name="sellerNickname" class="form-control" th:value="${nickname}">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">ë‚´ìš©</label>
                        <textarea name="description" rows="7" class="form-control" required
                                  th:text="${dto != null && dto.description != null ? dto.description : ''}"></textarea>
                    </div>
                </div></div>
            </div>

            <!-- ìš°ì¸¡: ì´ë¯¸ì§€ -->
            <div class="col-12 col-lg-6">
                <div class="card shadow-sm"><div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div class="fw-semibold">ìƒí’ˆ ì´ë¯¸ì§€</div>
                        <div class="counter">
                            <span id="count" th:text="${images != null ? images.size() : 0}">0</span> / 10
                        </div>
                    </div>

                    <div id="dropzone" class="uploader mb-3">
                        <label for="fileInput" id="uploadTile" class="upload-tile" aria-label="ì´ë¯¸ì§€ ì—…ë¡œë“œ">
                            <div class="text-center">
                                <div class="mb-1">ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ</div>
                                <small class="text-muted">í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸í•˜ì—¬ ì„ íƒ (ìµœëŒ€ 10ì¥)</small>
                            </div>
                        </label>
                        <input id="fileInput" name="images" type="file" accept="image/*" multiple class="visually-hidden">
                    </div>

                    <!-- ê¸°ì¡´ ì´ë¯¸ì§€ -->
                    <div id="thumbs" class="thumb-grid">
                        <th:block th:if="${!#lists.isEmpty(images)}">
                            <div class="thumb existing" th:each="img,stat : ${images}" th:attr="data-id=${img.id}">
                                <img th:src="${img.imageUrl}" alt="old" onerror="this.onerror=null;this.src='/images/no-image.png'">
                                <button type="button" class="remove" aria-label="ì‚­ì œ">&times;</button>
                                <!-- ì‚­ì œ ì „ë‹¬ìš©(ìˆ¨ê¹€) -->
                                <input class="del-check visually-hidden" type="checkbox" name="deleteImageIds" th:value="${img.id}">
                                <span class="badge text-bg-primary badge-top" th:if="${stat.index == 0}">ëŒ€í‘œ</span>
                            </div>
                        </th:block>
                    </div>
                </div></div>
            </div>
        </div>

        <div class="d-flex gap-2 mt-4">
            <a th:href="@{/trade/read/{id}(id=${dto.id})}" class="btn btn-secondary">ì·¨ì†Œ</a>
            <button type="submit" class="btn btn-primary">ì €ì¥</button>
        </div>
    </form>
</main>

<!-- ê³µí†µ í‘¸í„° -->
<div th:replace="~{layou/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    (function () {
        // ===== ì¹´í…Œê³ ë¦¬ ê°•ì œ ì„ íƒ =====
        const CAT_LABEL = {
            ART:'ì˜ˆìˆ ', COOK:'ìš”ë¦¬', MUSIC:'ìŒì•…', PET:'ë°˜ë ¤ë™ë¬¼',
            SPORTS:'ìŠ¤í¬ì¸ ', STUDY:'ìŠ¤í„°ë””', TRAVEL:'ì—¬í–‰'
        };
        const lower = (s)=> (s||'').trim().toLowerCase();
        function forceSelectCategory(select){
            if (!select) return;
            const fromEnum  = (select.dataset.currentEnum || select.getAttribute('data-current') || '').trim();
            if (!fromEnum) return;
            const asLabel = CAT_LABEL[fromEnum] || fromEnum;
            const opts = Array.from(select.options);
            let target =
                opts.find(o => lower(o.value) === lower(fromEnum))  ||
                opts.find(o => lower(o.text)  === lower(fromEnum))  ||
                opts.find(o => lower(o.value) === lower(asLabel))   ||
                opts.find(o => lower(o.text)  === lower(asLabel));
            if (target) select.value = target.value;
        }

        function ensureCategorySelected(form) {
            const sel = form.querySelector('#categorySelect');
            if (!sel) return true;
            if (!sel.value || !sel.value.trim()) {
                alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„¤ì •í•´ ì£¼ì„¸ìš”.');
                sel.focus();
                return false;
            }
            return true;
        }

        // ===== ì´ë¯¸ì§€ ê´€ë¦¬ =====
        const form     = document.getElementById('modifyForm');
        const sel      = document.getElementById('categorySelect');
        const fileInput= document.getElementById('fileInput');
        const dropzone = document.getElementById('dropzone');
        const thumbs   = document.getElementById('thumbs');
        const counter  = document.getElementById('count');

        forceSelectCategory(sel);

        // í˜„ì¬ DOMì— ë‚¨ì•„ìˆëŠ” ê¸°ì¡´ ì¸ë„¤ì¼ ìˆ˜
        function currentExistingCount(){
            return thumbs ? thumbs.querySelectorAll('.thumb.existing').length : 0;
        }
        // ì „ì²´(ê¸°ì¡´+ì‹ ê·œ)
        let filesBuffer = [];
        function currentTotalCount(){
            return currentExistingCount() + filesBuffer.length;
        }
        function updateCount(){
            if (counter) counter.textContent = String(currentTotalCount());
        }

        // ëŒ€í‘œ ë°°ì§€: ë‚¨ì•„ìˆëŠ” ì²« íƒ€ì¼ì—ë§Œ 'ëŒ€í‘œ'
        function updateBadge(){
            if (!thumbs) return;
            thumbs.querySelectorAll('.badge-top').forEach(b=>b.remove());
            const first = thumbs.querySelector('.thumb');
            if (first){
                const badge = document.createElement('span');
                badge.className = 'badge text-bg-primary badge-top';
                badge.textContent = 'ëŒ€í‘œ';
                first.appendChild(badge);
            }
        }

        // â”€â”€ âœ… ê¸°ì¡´ ì´ë¯¸ì§€ ì¦‰ì‹œ ì‚­ì œ(ë·°ì—ì„œ ì œê±° + ì „ì†¡ ìœ ì§€) â”€â”€
        function removeExistingTile(tile){
            if (!tile) return;
            const chk = tile.querySelector('.del-check');
            if (chk) {
                chk.checked = true;     // ì„œë²„ë¡œ ì‚­ì œ ì˜ì‚¬ ì „ë‹¬
                form.appendChild(chk);  // ì¸ë„¤ì¼ì„ ì§€ì›Œë„ submitì— í¬í•¨ë˜ë„ë¡ í¼ìœ¼ë¡œ ì´ë™
            }
            tile.remove();              // í™”ë©´ì—ì„œ ì¦‰ì‹œ ì œê±°
            updateBadge();
            updateCount();
        }

        function bindExistingThumbEvents(){
            thumbs?.querySelectorAll('.thumb.existing').forEach(tile=>{
                const img = tile.querySelector('img');
                const btn = tile.querySelector('.remove');
                img?.addEventListener('click', ()=> removeExistingTile(tile));
                btn?.addEventListener('click', ()=> removeExistingTile(tile));
            });
        }
        bindExistingThumbEvents();

        // â”€â”€ ì‹ ê·œ ì—…ë¡œë“œ â”€â”€
        function renderNewThumbs(){
            if (!thumbs) return;
            // ê¸°ì¡´ new íƒ€ì¼ ì œê±° í›„ ì¬ìƒì„±
            thumbs.querySelectorAll('.thumb.new').forEach(n=>n.remove());
            filesBuffer.forEach((file)=>{
                const url = URL.createObjectURL(file);
                const tile = document.createElement('div'); tile.className='thumb new';
                const img  = document.createElement('img');  img.src=url; img.alt='preview';
                const btn  = document.createElement('button'); btn.type='button'; btn.className='remove'; btn.innerHTML='&times;';
                btn.addEventListener('click', ()=>{
                    const allNew = Array.from(thumbs.querySelectorAll('.thumb.new'));
                    const idx = allNew.indexOf(tile);
                    if (idx > -1) filesBuffer.splice(idx,1);
                    tile.remove();
                    updateBadge(); updateCount(); syncToInput();
                });
                tile.appendChild(img); tile.appendChild(btn);
                thumbs.appendChild(tile);
            });
        }

        function syncToInput(){
            if (!fileInput || typeof DataTransfer==='undefined') return;
            const dt = new DataTransfer();
            filesBuffer.forEach(f=>dt.items.add(f));
            fileInput.files = dt.files;
        }

        // ì—…ë¡œë” ì´ë²¤íŠ¸
        function addFiles(incoming){
            if (!incoming?.length) return;
            const images = incoming.filter(f=> f.type?.startsWith('image/'));
            const room   = Math.max(0, 10 - currentTotalCount());
            const toAdd  = images.slice(0, room);
            if (images.length > room) alert('ìµœëŒ€ 10ì¥ê¹Œì§€ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            filesBuffer.push(...toAdd);
            renderNewThumbs(); updateBadge(); updateCount(); syncToInput();
        }

        if (dropzone && fileInput){
            document.addEventListener('click', e=>{
                if (e.target.closest('#uploadTile')) { e.preventDefault(); fileInput.click(); }
            });
            ['dragenter','dragover'].forEach(evt=> dropzone.addEventListener(evt, e=>{
                e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover');
            }));
            ['dragleave','drop'].forEach(evt=> dropzone.addEventListener(evt, e=>{
                e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover');
            }));
            dropzone.addEventListener('drop', e=> addFiles(Array.from(e.dataTransfer?.files||[])));
            fileInput.addEventListener('change', e=>{
                addFiles(Array.from(e.target.files||[]));
                if (window.DataTransfer) fileInput.value='';
            });
        }

        // ì´ˆê¸° ìƒíƒœ ë³´ì •
        updateBadge(); updateCount();

        // ì œì¶œ ì „ í•„ìˆ˜ ì²´í¬ + íŒŒì¼ ë™ê¸°í™”
        form?.addEventListener('submit', (e)=>{
            if (!ensureCategorySelected(form)) { e.preventDefault(); e.stopPropagation(); return; }
            syncToInput();
        });
    })();
</script>
</body>
</html>
