<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title th:text="${dto != null ? '게시물 보기 - ' + dto.title : '게시물 보기'}">게시물 보기</title>

    <!-- CSRF 메타 -->
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}">
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 아이콘 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        .page-wrap { max-width: 1200px; }
        .viewer{position:relative;display:flex;align-items:center;justify-content:center;width:100%;aspect-ratio:4/5;background:#fff;border-radius:12px;overflow:hidden;max-height:520px;}
        .viewer>img.thumb{width:100%;height:100%;object-fit:contain;cursor:zoom-in;}
        .nav-btn{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;border:none;border-radius:12px;background:rgba(241,243,245,.92);color:#333;box-shadow:0 2px 8px rgba(0,0,0,.12);font-size:22px;line-height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
        .nav-btn.prev{left:6px;} .nav-btn.next{right:6px;}
        .gallery{display:flex;gap:8px;flex-wrap:wrap;}
        .gallery img{width:70px;height:70px;object-fit:cover;border-radius:8px;border:1px solid #e9ecef;cursor:pointer;background:#fff;}
        .gallery img.active{outline:3px solid #0d6efd;}
        .title-lg { font-size: clamp(1.15rem, 1.0rem + 0.8vw, 1.6rem); font-weight: 800; }
        .price-md { font-size: clamp(1.0rem, 0.9rem + 0.6vw, 1.25rem); font-weight: 700; }
        .desc { white-space: pre-wrap; }
        .action-row { display:flex; flex-wrap:wrap; gap:8px; }
        .action-wrap { margin-top: 2.25rem; padding-top: 1rem; border-top: 1px solid #e9ecef; }
        .img-modal{ position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:1050; padding:24px; }
        .img-modal.show{ display:flex; }
        .img-modal .inner{ position:relative; max-width:90vw; max-height:90vh; display:flex; align-items:center; justify-content:center; }
        .img-modal img{ max-width:90vw; max-height:90vh; object-fit:contain; background:#000; }
        .img-modal .close-btn{ position:absolute; top:8px; right:8px; width:36px; height:36px; border:none; border-radius:10px;background:#0009; color:#fff; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .icon-btn{ display:inline-flex; align-items:center; justify-content:center; width:44px; height:44px; border-radius:10px; border:none;background:transparent; color:#6c757d; transition:.15s; }
        .icon-btn:hover{ color:#0d6efd; background:#f5f9ff; }
        .icon-btn svg{ width:22px; height:22px; }
    </style>
</head>
<body>
<div th:replace="~{layou/header :: header}"></div>

<main class="container page-wrap py-4">
    <!-- 우측 상단: 신고 + 목록 -->
    <div class="d-flex justify-content-end mb-3 gap-2">
        <!-- ✅ 거래 신고 버튼 (TRADE) -->
        <span th:if="${dto != null}" th:replace="~{/fragments/report :: reportBtn2('TRADE', ${dto.id})}"></span>

        <!-- 기존 목록 아이콘들 -->
        <a class="icon-btn" th:if="${backUrl != null}" th:href="${backUrl}" title="목록" aria-label="목록">
            <svg xmlns="http://www.w3.org/2000/svg" class="bi bi-list" viewBox="0 0 16 16" aria-hidden="true">
                <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/>
            </svg>
        </a>
        <a class="icon-btn" th:if="${backUrl == null}" th:href="@{/trade/list}" title="목록" aria-label="목록">
            <svg xmlns="http://www.w3.org/2000/svg" class="bi bi-filter-right" viewBox="0 0 16 16" aria-hidden="true">
                <path d="M14 10.5a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 .5-.5m0-3a.5.5 0 0 0-.5-.5h-7a.5.5 0 0 0 0 1h7a.5.5 0 0 0 .5-.5m0-3a.5.5 0 0 0-.5-.5h-11a.5.5 0 0 0 0 1h11a.5.5 0 0 0 .5-.5"/>
            </svg>
        </a>
    </div>

    <div th:if="${dto == null}" class="alert alert-warning">
        해당 게시물을 찾을 수 없습니다. <a th:href="@{/trade/list}" class="alert-link">목록으로</a>
    </div>

    <div th:if="${dto != null}" th:with="noImg=@{/images/no-image.png}">
        <div class="row g-4">
            <!-- 좌: 이미지 -->
            <div class="col-lg-6">
                <div class="viewer mb-3">
                    <button type="button" class="nav-btn prev" aria-label="이전 보기">‹</button>
                    <img id="mainImage" class="thumb"
                         th:src="${images != null and !#lists.isEmpty(images) ? images.get(0).imageUrl : (!#strings.isEmpty(dto.thumbnail) ? dto.thumbnail : noImg)}"
                         alt="thumbnail"
                         onerror="this.onerror=null;this.src='/images/no-image.png'">
                    <button type="button" class="nav-btn next" aria-label="다음 보기">›</button>
                </div>
                <div class="gallery" th:if="${!#lists.isEmpty(images)}">
                    <img th:each="img, stat : ${images}"
                         th:src="${img.imageUrl}" th:attr="data-src=${img.imageUrl}" th:alt="${'image-'+stat.index}"
                         onerror="this.onerror=null;this.src='/images/no-image.png'">
                </div>
            </div>

            <!-- 우: 정보 -->
            <div class="col-lg-6">
                <h1 class="title-lg mb-2" th:text="${dto.title}">제목</h1>
                <th:block th:with="rawCat=${dto.category}, str=${rawCat == null ? '' : rawCat.toString()}, key=${#strings.toUpperCase(#strings.trim(str))}">
                    <div class="mb-2">
            <span class="badge rounded-pill text-bg-secondary" th:switch="${key}">
              <span th:case="'ART'">예술</span>
              <span th:case="'COOK'">요리</span>
              <span th:case="'MUSIC'">음악</span>
              <span th:case="'PET'">반려동물</span>
              <span th:case="'SPORTS'">운동</span>
              <span th:case="'STUDY'">스터디</span>
              <span th:case="'TRAVEL'">여행</span>
              <span th:case="*" th:text="${#strings.isEmpty(str) ? '미분류' : str}">미분류</span>
            </span>
                    </div>
                </th:block>

                <div class="d-flex align-items-center gap-2 mb-2">
                    <button id="btnFav" class="btn btn-outline-danger btn-sm"
                            th:attr="data-trade-id=${dto.id}, data-owner=${isOwner}" type="button">
                        <span class="me-1">♥</span>
                        <span id="favText" th:text="${isOwner ? '내 게시물' : (liked != null and liked ? '찜 취소' : '찜하기')}">찜하기</span>
                    </button>
                </div>

                <div class="price-md mb-3"><span th:text="${#numbers.formatInteger(dto.price, 0, 'COMMA')}">0</span> 원</div>
                <div class="text-muted mb-3">작성자: <span class="fw-semibold" th:text="${dto.sellerNickname != null ? dto.sellerNickname : '알수없음'}">닉네임</span></div>
                <div class="desc" th:text="${dto.description}">내용이 없습니다.</div>

                <!-- CSRF 백업 -->
                <th:block th:if="${_csrf != null}">
                    <input type="hidden" id="csrfToken"  th:value="${_csrf.token}">
                    <input type="hidden" id="csrfHeader" th:value="${_csrf.headerName}">
                </th:block>

                <div class="action-wrap">
                    <div class="action-row">
                        <!-- 문의하기/수정/삭제 등 기존 버튼들 유지 -->
                        <form th:if="${!isOwner}" th:action="@{/chat/start}" method="post">
                            <th:block th:if="${_csrf != null}">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            </th:block>
                            <input type="hidden" name="tradeId" th:value="${dto.id}">
                            <button type="submit" class="btn btn-outline-primary btn-sm">문의하기</button>
                        </form>

                        <a class="btn btn-primary btn-sm ms-auto d-flex align-items-center gap-1" th:if="${isOwner}"
                           th:href="@{'/trade/modify/' + ${dto.id}}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                 class="bi bi-pencil-square" viewBox="0 0 16 16" aria-hidden="true">
                                <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                            </svg>
                            수정
                        </a>

                        <form th:if="${isOwner}" th:action="@{'/trade/remove/' + ${dto.id}}" method="post"
                              onsubmit="return confirm('삭제하시겠습니까?');">
                            <th:block th:if="${_csrf != null}">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            </th:block>
                            <button type="submit" class="btn btn-danger btn-sm d-flex align-items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                     class="bi bi-trash" viewBox="0 0 16 16" aria-hidden="true">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                                    <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                                </svg>
                                삭제
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 이미지 확대 모달 -->
    <div id="imgModal" class="img-modal" aria-hidden="true">
        <div class="inner">
            <img id="zoomImg" alt="zoom">
            <button type="button" class="close-btn" aria-label="닫기">×</button>
        </div>
    </div>
</main>

<div th:replace="~{layou/footer :: footer}"></div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    (function () {
        const main    = document.getElementById('mainImage');
        const thumbs  = Array.from(document.querySelectorAll('.gallery img'));
        const prevBtn = document.querySelector('.nav-btn.prev');
        const nextBtn = document.querySelector('.nav-btn.next');

        const urls = thumbs.length
            ? thumbs.map(el => el.getAttribute('data-src') || el.getAttribute('src'))
            : (main && main.src ? [main.src] : []);

        let idx = 0;
        function highlight(){ thumbs.forEach(t=>t.classList.remove('active')); if (thumbs[idx]) thumbs[idx].classList.add('active'); }
        function show(i){ if(!main||!urls.length) return; idx=(i+urls.length)%urls.length; main.src=urls[idx]; highlight(); }
        thumbs.forEach((el,i)=> el.addEventListener('click', ()=>show(i)));
        prevBtn && prevBtn.addEventListener('click', ()=>show(idx-1));
        nextBtn && nextBtn.addEventListener('click', ()=>show(idx+1));
        highlight();

        // 확대 모달
        const modal=document.getElementById('imgModal'), zoomImg=document.getElementById('zoomImg'), closeBtn=modal.querySelector('.close-btn');
        function openModal(src){ if(!src) return; zoomImg.src=src; modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); closeBtn.focus(); }
        function closeModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); zoomImg.src=''; }
        main && main.addEventListener('click', ()=>openModal(main.src));
        thumbs.forEach(el=> el.addEventListener('dblclick', ()=>openModal(el.getAttribute('data-src')||el.src)));
        closeBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });

        // 찜 토글
        const btn=document.getElementById('btnFav'), favText=document.getElementById('favText'), favCount=document.getElementById('favCount');
        if(!btn||!favText) return;

        const tradeId = btn.getAttribute('data-trade-id');
        const isOwner = (btn.getAttribute('data-owner') === 'true');

        if (isOwner) {
            btn.addEventListener('click', function(){ alert('본인이 작성한 게시물입니다.'); });
            return;
        }

        const metaToken  = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const metaHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
        const hiddenTok  = document.getElementById('csrfToken')?.value;
        const hiddenHead = document.getElementById('csrfHeader')?.value;
        const csrfHeaderName  = metaHeader || hiddenHead || null;
        const csrfHeaderValue = metaToken  || hiddenTok  || null;

        async function toggleFavorite(){
            try{
                btn.disabled = true;
                const headers = {'Accept':'application/json','Content-Type':'application/x-www-form-urlencoded','X-Requested-With':'XMLHttpRequest'};
                if (csrfHeaderName && csrfHeaderValue) headers[csrfHeaderName] = csrfHeaderValue;
                const body = new URLSearchParams({tradeId:String(tradeId)}).toString();
                const res = await fetch('/favorite/toggle',{method:'POST',headers,body,credentials:'same-origin'});
                if (res.status===401){ alert('로그인이 필요합니다.'); return; }
                if (res.status===403){ alert('권한이 없습니다.'); return; }
                const data = await res.json();
                if (typeof data.liked==='boolean') {
                    favText.textContent = data.liked ? '찜 취소' : '찜하기';
                    alert(data.liked ? '찜 목록에 등록되었습니다.' : '찜이 해제되었습니다.');
                }
                if (typeof data.count==='number' && favCount) favCount.textContent = data.count;
            }catch(e){ console.error(e); alert('찜 처리 중 오류가 발생했습니다.'); }
            finally{ btn.disabled=false; }
        }
        btn.addEventListener('click', toggleFavorite);
    })();
</script>
</body>
</html>
