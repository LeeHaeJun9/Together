<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/basic}">
<head>
    <title th:text="${dto != null ? dto.title : '게시물 보기'}">게시물 보기</title>
</head>
<body>

<section layout:fragment="content" class="container py-4">

    <!-- 게시물 없음 -->
    <div th:if="${dto == null}" class="alert alert-warning">
        해당 게시물을 찾을 수 없습니다. <a th:href="@{/trade/list}" class="alert-link">목록으로</a>
    </div>

    <!-- 게시물 있음 -->
    <div th:if="${dto != null}">
        <!-- 제목만 (상단 우측 버튼 제거) -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0" th:text="${dto.title}">제목</h2>
        </div>

        <style>
            .thumb { width:100%; max-width:640px; aspect-ratio:16/9; object-fit:cover; border-radius:12px; border:1px solid #eee; background:#fafafa; }
            .gallery img { width:90px; height:90px; object-fit:cover; border-radius:8px; border:1px solid #eee; margin-right:8px; cursor:pointer; }
        </style>

        <!-- 메인 이미지 -->
        <div class="mb-3" th:with="noImg=@{/images/no-image.png}">
            <img id="mainImage"
                 th:src="${images != null and !#lists.isEmpty(images)
                         ? images.get(0).imageUrl
                         : (!#strings.isEmpty(dto.thumbnail) ? dto.thumbnail : noImg)}"
                 alt="thumbnail" class="thumb">
        </div>

        <!-- 갤러리 -->
        <div class="gallery mb-3" th:if="${!#lists.isEmpty(images)}">
            <img th:each="img : ${images}"
                 th:src="${img.imageUrl}"
                 th:onclick="|document.getElementById('mainImage').src='${img.imageUrl}'|"
                 alt="image">
        </div>

        <!-- 찜 -->
        <div class="d-flex align-items-center gap-2 mb-3">
            <button id="btnFav" class="btn btn-outline-danger btn-sm" type="button"
                    th:attr="data-trade-id=${dto.id}">
                <span class="me-1">♥</span>
                <span id="favText" th:text="${liked != null and liked ? '찜 취소' : '찜하기'}">찜하기</span>
            </button>
            <span>찜 <strong id="favCount" th:text="${likeCount} ?: 0">0</strong></span>
        </div>

        <hr class="my-3"/>

        <!-- 내용 -->
        <h5 class="mb-2">내용</h5>
        <pre class="p-3 bg-light rounded border" style="white-space:pre-wrap;" th:text="${dto.description}">내용이 없습니다.</pre>

        <!-- 하단 오른쪽 버튼들만 노출 -->
        <div class="d-flex justify-content-end gap-2 mt-3">
            <!-- 목록: 컨트롤러에서 내려준 backUrl(/favorite/list or /trade/list) -->
            <a class="btn btn-secondary" th:href="${backUrl}">목록</a>

            <!-- 작성자만 수정/삭제 가능 -->
            <a class="btn btn-primary"
               th:if="${isOwner}"
               th:href="@{'/trade/modify/' + ${dto.id}}">수정</a>

            <form th:if="${isOwner}"
                  th:action="@{'/trade/remove/' + ${dto.id}}"
                  method="post"
                  onsubmit="return confirm('삭제하시겠습니까?');">
                <th:block th:if="${_csrf != null}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                </th:block>
                <button type="submit" class="btn btn-danger">삭제</button>
            </form>
        </div>
    </div>
</section>

<!-- 페이지 전용 스크립트 -->
<th:block layout:fragment="script">
    <script th:inline="javascript">
        (function () {
            const btn = document.getElementById('btnFav');
            if (!btn) return;

            const tradeId   = btn.getAttribute('data-trade-id');
            const favText   = document.getElementById('favText');
            const favCount  = document.getElementById('favCount');

            // 레이아웃(head)에 있는 CSRF 메타
            const csrfToken  = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

            async function toggleFavorite() {
                try {
                    btn.disabled = true; // 중복 클릭 방지
                    const params = new URLSearchParams({ tradeId: tradeId });
                    const headers = { 'Accept':'application/json', 'Content-Type':'application/x-www-form-urlencoded' };
                    if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

                    const res = await fetch('/favorite/toggle', { method:'POST', headers, body: params });
                    if (!res.ok) throw new Error('응답 오류');
                    const data = await res.json(); // { liked, count }

                    favText.textContent  = data.liked ? '찜 취소' : '찜하기';
                    favCount.textContent = (data.count ?? 0);

                    if (data.liked === true) {
                        alert('찜목록에 추가되었습니다.');
                    }
                } catch (e) {
                    alert('찜 처리 중 오류가 발생했습니다.');
                    console.error(e);
                } finally {
                    btn.disabled = false;
                }
            }
            btn.addEventListener('click', toggleFavorite);
        })();
    </script>
</th:block>
</body>
</html>
