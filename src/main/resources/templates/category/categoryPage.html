<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>카테고리 - Together</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/categoryPage.css}">
</head>
<body>

<div th:replace="~{layout/header :: header}"></div>

<main class="container px-4 px-lg-5">

  <div class="row g-5 mt-3">

    <div class="col-12">
      <div class="p-4 rounded-3 section-box search-box">
        <h3 class="mb-3">통합 검색</h3>

        <ul class="nav nav-pills mb-3" id="searchTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-meeting" data-section="meeting" type="button" role="tab" aria-selected="true">모임</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-cafe" data-section="cafe" type="button" role="tab" aria-selected="false">카페</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-trade" data-section="trade" type="button" role="tab" aria-selected="false">중고거래</button>
          </li>
        </ul>

        <form th:action="@{/categories}" method="get" id="categorySearchForm" class="d-flex align-items-center">
          <input type="hidden" name="category" th:value="${category}">
          <input type="hidden" name="m_page" th:value="${meetingsPage.pageRequestDTO.page}">
          <input type="hidden" name="m_size" th:value="${meetingsPage.size > 0 ? meetingsPage.size : 10}">
          <input type="hidden" name="c_page" th:value="${cafesPage.pageRequestDTO.page}">
          <input type="hidden" name="c_size" th:value="${cafesPage.size > 0 ? cafesPage.size : 4}">
          <input type="hidden" name="t_page" th:value="${tradesPage.pageRequestDTO.page}">
          <input type="hidden" name="t_size" th:value="${tradesPage.size > 0 ? tradesPage.size : 10}">

          <input type="hidden" id="searchTypeInput" name="m_type" th:value="${meetingsPage.pageRequestDTO.type}">
          <input type="hidden" id="searchKeywordInput" name="m_keyword" th:value="${meetingsPage.pageRequestDTO.keyword}">


          <select class="form-select me-2" id="searchTypeSelect" style="width: 150px;">
            <option value="tc" selected>제목+내용</option>
            <option value="t">제목</option>
            <option value="c">내용</option>
<!--            <option value="w">작성자</option>-->
          </select>

          <input class="form-control me-2" type="search" placeholder="검색어를 입력하세요."
                 aria-label="Search" id="searchKeywordText"
                 th:value="${meetingsPage.pageRequestDTO.keyword}">

          <button class="btn btn-primary" type="submit">검색</button>
        </form>
      </div>
    </div>

    <div class="col-12">
      <div class="p-4 rounded-3 section-box meeting-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="mb-0">모임</h3>
        </div>

        <div th:if="${#lists.isEmpty(meetings)}" class="alert alert-info text-center">
          <i class="fas fa-info-circle me-2"></i> 공개된 모임이 없습니다.
        </div>

        <div class="list-group list-group-flush" th:unless="${#lists.isEmpty(meetings)}">
          <a th:each="meeting : ${meetings}"
             th:href="@{/cafe/{cafeId}/meeting/read(id=${meeting.id}, cafeId=${meeting.cafe.id})}"
             class="list-group-item list-group-item-action meeting-list-item">
            <div class="d-flex w-100 justify-content-between">
              <strong class="mb-1" th:text="${meeting.title}">모임 제목</strong>
              <small class="text-primary" th:text="${#temporals.format(meeting.meetingDate, 'MM/dd HH:mm')}">날짜</small>
            </div>
            <p class="mb-1 text-truncate" th:text="${meeting.content}">모임 내용</p>
          </a>
        </div>
        <nav th:if="${meetingsPage.total > 0}" aria-label="Meeting Pagination" class="mt-4">
          <ul class="pagination justify-content-center">
            <li class="page-item" th:each="pageNum : ${#numbers.sequence(meetingsPage.start, meetingsPage.end)}"
                th:classappend="${pageNum == meetingsPage.pageRequestDTO.page} ? 'active'">
              <a class="page-link"
                 th:href="@{/categories(category=${category},
             m_page=${pageNum}, m_size=${meetingsPage.size},
             c_page=${cafesPage.pageRequestDTO.page}, c_size=${cafesPage.pageRequestDTO.size},
             t_page=${tradesPage.pageRequestDTO.page}, t_size=${tradesPage.pageRequestDTO.size},
             m_type=${meetingsPage.pageRequestDTO.type}, m_keyword=${meetingsPage.pageRequestDTO.keyword},
             c_type=${cafesPage.pageRequestDTO.type}, c_keyword=${cafesPage.pageRequestDTO.keyword},
             t_type=${tradesPage.pageRequestDTO.type}, t_keyword=${tradesPage.pageRequestDTO.keyword},
             sort=${meetingsPage.pageRequestDTO.sort})}"
                 th:text="${pageNum}"></a>
            </li>
          </ul>
        </nav>
      </div>
    </div>

    <div class="col-12">
      <div class="p-4 rounded-3 section-box cafe-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="mb-0">카페</h3>
        </div>

        <div th:if="${#lists.isEmpty(cafes)}" class="alert alert-warning text-center">
          <i class="fas fa-exclamation-triangle me-2"></i> 해당 카테고리 카페가 없습니다.
        </div>

        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4" th:unless="${#lists.isEmpty(cafes)}">
          <div class="col" th:each="cafe : ${cafes}">
            <div class="card h-100 cafe-card border-success">
              <img th:src="${cafe.cafeThumbnail ?: '/images/default-cafe.png'}" class="card-img-top" th:alt="${cafe.name}">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title text-success" th:text="${cafe.name}">카페 이름</h5>
                <p class="card-text text-truncate" th:text="${cafe.description}">카페 설명</p>
                <p class="text-muted small mt-auto mb-2"><i class="fas fa-users me-1"></i> 멤버 <span th:text="${cafe.memberCount}">0</span>명</p>
                <a th:href="@{/cafe/{id}(id=${cafe.id})}" class="btn btn-sm btn-success mt-1">카페 보기</a>
              </div>
            </div>
          </div>
        </div>
        <nav th:if="${cafesPage.total > 0}" aria-label="Cafe Pagination" class="mt-4">
          <ul class="pagination justify-content-center">
            <li class="page-item" th:each="pageNum : ${#numbers.sequence(cafesPage.start, cafesPage.end)}"
                th:classappend="${pageNum == cafesPage.pageRequestDTO.page} ? 'active'">
              <a class="page-link"
                 th:href="@{/categories(category=${category},
             m_page=${meetingsPage.pageRequestDTO.page}, m_size=${meetingsPage.pageRequestDTO.size},
             c_page=${pageNum}, c_size=${cafesPage.size},
             t_page=${tradesPage.pageRequestDTO.page}, t_size=${tradesPage.pageRequestDTO.size},
             m_type=${meetingsPage.pageRequestDTO.type}, m_keyword=${meetingsPage.pageRequestDTO.keyword},
             c_type=${cafesPage.pageRequestDTO.type}, c_keyword=${cafesPage.pageRequestDTO.keyword},
             t_type=${tradesPage.pageRequestDTO.type}, t_keyword=${tradesPage.pageRequestDTO.keyword},
             sort=${cafesPage.pageRequestDTO.sort})}"
                 th:text="${pageNum}"></a>
            </li>
          </ul>
        </nav>
      </div>
    </div>

    <div class="col-12">
      <div class="p-4 rounded-3 section-box trade-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="mb-0">중고거래</h3>
        </div>

        <div th:if="${#lists.isEmpty(trades)}" class="alert alert-secondary text-center">
          <i class="fas fa-comment-dollar me-2"></i> 해당 카테고리 거래글이 없습니다.
        </div>

        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4" th:unless="${#lists.isEmpty(trades)}">
          <div class="col" th:each="trade : ${trades}">
            <div class="card h-100 trade-card border-info">
              <img th:src="${trade.thumbnail ?: '/images/default-trade.png'}" class="card-img-top" th:alt="${trade.title}">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title text-info" th:text="${trade.title}">거래 제목</h5>
                <p class="text fw-bold mb-2">
                  <span th:text="${#numbers.formatDecimal(trade.price, 0, 'COMMA', 0, 'POINT')}">0</span>원
                </p>
                <p class="text-muted small mt-auto mb-2"><i class="fas fa-user me-1"></i> 판매자: <span th:text="${trade.sellerNickname}">닉네임</span></p>
                <a th:href="@{/trade/read/{id}(id=${trade.id})}" class="btn btn-sm btn-info mt-1">자세히 보기</a>
              </div>
            </div>
          </div>
        </div>
        <nav th:if="${tradesPage.total > 0}" aria-label="Trade Pagination" class="mt-4">
          <ul class="pagination justify-content-center">
            <li class="page-item" th:each="pageNum : ${#numbers.sequence(tradesPage.start, tradesPage.end)}"
                th:classappend="${pageNum == tradesPage.pageRequestDTO.page} ? 'active'">
              <a class="page-link"
                 th:href="@{/categories(category=${category},
             m_page=${meetingsPage.pageRequestDTO.page}, m_size=${meetingsPage.pageRequestDTO.size},
             c_page=${cafesPage.pageRequestDTO.page}, c_size=${cafesPage.pageRequestDTO.size},
             t_page=${pageNum}, t_size=${tradesPage.size},
             m_type=${meetingsPage.pageRequestDTO.type}, m_keyword=${meetingsPage.pageRequestDTO.keyword},
             c_type=${cafesPage.pageRequestDTO.type}, c_keyword=${cafesPage.pageRequestDTO.keyword},
             t_type=${tradesPage.pageRequestDTO.type}, t_keyword=${tradesPage.pageRequestDTO.keyword},
             sort=${tradesPage.pageRequestDTO.sort})}"
                 th:text="${pageNum}"></a>
            </li>
          </ul>
        </nav>
      </div>
    </div>

  </div> </main>

<div th:replace="~{layou/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('categorySearchForm');
    const searchTabs = document.getElementById('searchTabs');
    const searchTypeInput = document.getElementById('searchTypeInput'); // hidden type
    const searchKeywordInput = document.getElementById('searchKeywordInput'); // hidden keyword
    const searchTypeSelect = document.getElementById('searchTypeSelect'); // select tag
    const searchKeywordText = document.getElementById('searchKeywordText'); // visible text input

    // 현재 검색 상태를 저장하는 객체 (페이지 로드 시 Thymeleaf 값으로 초기화)
    const searchState = {
      'meeting': {
        prefix: 'm_',
        type: '[[${meetingsPage.pageRequestDTO.type}]]',
        keyword: '[[${meetingsPage.pageRequestDTO.keyword}]]',
        options: [
          { value: 'tc', text: '제목+내용' },
          { value: 't', text: '제목' },
          { value: 'c', text: '내용' },
        ]
      },
      'cafe': {
        prefix: 'c_',
        type: '[[${cafesPage.pageRequestDTO.type}]]',
        keyword: '[[${cafesPage.pageRequestDTO.keyword}]]',
        options: [
          { value: 'nd', text: '카페명+설명' },
          { value: 'n', text: '카페명' },
          { value: 'd', text: '설명' }
        ]
      },
      'trade': {
        prefix: 't_',
        type: '[[${tradesPage.pageRequestDTO.type}]]',
        keyword: '[[${tradesPage.pageRequestDTO.keyword}]]',
        options: [
          { value: 'tw', text: '제목+판매자' },
          { value: 't', text: '제목' },
          { value: 'w', text: '판매자' }
        ]
      }
    };

    // 현재 활성화된 섹션을 저장 (초기값 'meeting')
    let activeSection = 'meeting';

    // 탭 클릭 이벤트 핸들러
    searchTabs.querySelectorAll('.nav-link').forEach(button => {
      button.addEventListener('click', function() {
        // 1. 활성화 상태 변경
        searchTabs.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');

        // 2. 현재 활성 섹션 업데이트
        activeSection = this.getAttribute('data-section');
        const state = searchState[activeSection];

        // 3. 폼 필드 이름 및 값 업데이트
        searchTypeInput.name = state.prefix + 'type';
        searchKeywordInput.name = state.prefix + 'keyword';
        searchTypeInput.value = state.type;
        searchKeywordInput.value = state.keyword;
        searchKeywordText.value = state.keyword;

        // 4. 드롭다운 옵션 업데이트
        searchTypeSelect.innerHTML = ''; // 기존 옵션 제거
        state.options.forEach(option => {
          const newOption = document.createElement('option');
          newOption.value = option.value;
          newOption.textContent = option.text;
          if (option.value === state.type) {
            newOption.selected = true;
          }
          searchTypeSelect.appendChild(newOption);
        });
      });
    });

    // 폼 제출 이벤트 핸들러
    searchForm.addEventListener('submit', function() {
      // 1. 드롭다운에서 선택된 값을 hidden type input에 반영
      searchTypeInput.value = searchTypeSelect.value;

      // 2. 텍스트 필드의 값을 hidden keyword input에 반영
      searchKeywordInput.value = searchKeywordText.value;

      // 3. 검색을 시작하면 해당 섹션의 페이지는 1로 초기화 (m_page, c_page, t_page)
      const pageInputName = searchState[activeSection].prefix + 'page';
      const pageInput = document.querySelector(`input[name="${pageInputName}"]`);
      if (pageInput) {
        pageInput.value = 1;
      }
    });

    // 페이지 로드 시 URL 파라미터를 확인하여 올바른 탭이 활성화되도록 처리
    const urlParams = new URLSearchParams(window.location.search);
    let initialSection = 'meeting';

    if (urlParams.get('c_keyword') || urlParams.get('c_type')) {
      initialSection = 'cafe';
    } else if (urlParams.get('t_keyword') || urlParams.get('t_type')) {
      initialSection = 'trade';
    }

    // 초기 활성화 탭 클릭 시뮬레이션
    document.getElementById(`tab-${initialSection}`).click();
  });
</script>

</body>
</html>