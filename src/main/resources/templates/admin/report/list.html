<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>신고 관리</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        .table td, .table th { vertical-align: middle; }
        .w-actions { width: 320px; }
        .badge-type { letter-spacing: .5px; }
    </style>
</head>
<div th:replace="~{layou/header :: header}"></div>

<body class="bg-light">
<div class="container py-4">

    <div class="d-flex align-items-center justify-content-between mb-3">
        <h3 class="mb-0">신고 관리</h3>
        <form method="get" th:action="@{/admin/reports}" class="d-flex gap-2">
            <select class="form-select" name="type" style="width: 200px;">
                <option th:selected="${currentType==null}" value="">전체 유형</option>
                <option th:each="t : ${T(com.example.together.domain.ReportType).values()}"
                        th:value="${t}" th:text="${t}"></option>
            </select>
            <button class="btn btn-outline-primary">필터</button>
        </form>
    </div>

    <!-- 플래시 메시지 -->
    <div th:if="${ok}" class="alert alert-success" th:text="${ok}"></div>
    <div th:if="${err}" class="alert alert-danger" th:text="${err}"></div>

    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>유형</th>
                        <th>대상</th>
                        <th>대상 유저</th>
                        <th>신고 사유</th>
                        <th>신고자</th>
                        <th>등록일</th>
                        <th class="w-actions text-center">조치</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="row : ${page.content}">
                        <td th:text="${row.id}">1</td>

                        <td>
                            <span class="badge text-bg-secondary badge-type" th:text="${row.type}">TYPE</span>
                        </td>

                        <td>
                            <a th:if="${row.targetUrl != null}" th:href="${row.targetUrl}"
                               th:text="${row.targetLabel}">대상</a>
                            <span th:if="${row.targetUrl == null}" th:text="${row.targetLabel}">대상</span>
                            <small class="text-muted" th:if="${row.targetId != null}">
                                (#<span th:text="${row.targetId}"></span>)
                            </small>
                        </td>

                        <!-- ✅ offender* 필드 참조 제거 -->
                        <td>-</td>

                        <td th:text="${row.reason}">신고 사유</td>

                        <td>
                            <span th:text="${row.reporterNickname}">신고자닉</span>
                            <small class="text-muted" th:if="${row.reporterLoginId != null}">
                                (<span th:text="${row.reporterLoginId}">id</span>)
                            </small>
                        </td>

                        <td th:text="${#temporals.format(row.regdate, 'yyyy-MM-dd HH:mm')}">2025-01-01</td>

                        <td class="text-center">
                            <div class="d-inline-flex gap-1">
                                <form th:action="@{|/admin/reports/${row.id}/content-delete|}" method="post"
                                      th:if="${row.type.name() == 'CAFE' or row.type.name() == 'TRADE' or row.type.name() == 'POST'}"
                                      onsubmit="return confirm('정말 해당 콘텐츠를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.');">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <button class="btn btn-sm btn-danger">콘텐츠 삭제</button>
                                </form>

                                <form th:action="@{|/admin/reports/${row.id}/user-ban|}" method="post"
                                      th:if="${row.type.name() == 'USER' or row.type.name() == 'CHAT' or row.type.name() == 'COMMENT'}"
                                      onsubmit="return confirm('해당 사용자를 정지하시겠습니까?');">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <button class="btn btn-sm btn-warning">유저 제재</button>
                                </form>

                                <form th:action="@{|/admin/reports/${row.id}/ignore|}" method="post"
                                      onsubmit="return confirm('이 신고를 종결(무시) 처리하시겠습니까?');">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <button class="btn btn-sm btn-outline-secondary">신고 종결</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer">
            <nav th:if="${page.totalPages > 1}">
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item" th:classappend="${page.first} ? 'disabled'">
                        <a class="page-link" th:href="@{|/admin/reports?page=${page.number-1}&size=${page.size}|}">이전</a>
                    </li>
                    <li class="page-item disabled">
            <span class="page-link"
                  th:text="${page.number + 1} + ' / ' + ${page.totalPages}">1 / 10</span>
                    </li>
                    <li class="page-item" th:classappend="${page.last} ? 'disabled'">
                        <a class="page-link" th:href="@{|/admin/reports?page=${page.number+1}&size=${page.size}|}">다음</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

</div>
<div th:replace="~{layou/footer :: footer}"></div>

</body>
</html>
