<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시글 수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        main {
            flex-grow: 1;
            padding: 3rem 1rem;
        }
        .page-header-container {
            text-align: center;
            margin-bottom: 2rem;
        }
        .page-header-container h3 {
            font-weight: 700;
            font-size: 1.8rem;
            color: #212529;
        }
        .card-custom {
            max-width: 850px;
            margin: 0 auto;
            background-color: #fff;
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 0.3rem 1rem rgba(0,0,0,0.08);
            padding: 2.5rem;
        }
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #343a40;
            margin-right: 10px;
        }
        .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.25);
        }
        .divider {
            border-top: 1px solid #dee2e6;
            margin: 2rem 0;
        }
        .survey-section {
            background-color: #f1f3f5;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .btn-primary-custom {
            background-color: #0d6efd;
            border: none;
            padding: 0.6rem 1.5rem;
            font-weight: 500;
            border-radius: 0.4rem;
            transition: all 0.2s ease;
            color: white;
        }
        .btn-primary-custom:hover {
            background-color: #0b5ed7;
        }
        .btn-secondary-custom {
            background-color: #6c757d;
            border: none;
            padding: 0.6rem 1.5rem;
            font-weight: 500;
            border-radius: 0.4rem;
            color: white;
        }
        .vote-option-input {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>

<div th:replace="~{layout/header :: header}"></div>

<main>
    <div class="page-header-container">
        <h3><i class="fa-solid fa-pen-to-square me-2"></i>게시글 수정</h3>
    </div>

    <div class="card card-custom">
        <form th:action="@{/cafe/{cafeId}/posts/{postId}/update(cafeId=${post.cafeId}, postId=${post.id})}"
              th:object="${postCreateRequestDTO}" method="post" enctype="multipart/form-data">

            <input type="hidden" th:field="*{id}" />

            <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
            <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

            <div class="mb-3">
                <label for="title" class="form-label">제목</label>
                <input type="text" class="form-control" id="title" th:field="*{title}" required>
            </div>

            <div class="mb-3">
                <label for="content" class="form-label">내용</label>
                <textarea class="form-control" id="content" th:field="*{content}" rows="10" required></textarea>
            </div>

            <div class="mb-3">
                <label for="imageFile" class="form-label">이미지 첨부</label>
                <input type="file" class="form-control" id="imageFile" name="imageFile">
                <div th:if="${post.image}" class="mt-2 text-center">
                    <img th:src="${post.image}" class="img-thumbnail" style="max-width:200px;" alt="현재 이미지">
                </div>
            </div>

            <div class="mb-3" th:if="${isOwner}">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="pinned" th:field="*{pinned}">
                    <label class="form-check-label" for="pinned">상단에 고정</label>
                </div>
            </div>

            <div class="divider"></div>

            <div class="mb-3">
                <label class="form-label">게시글 유형</label>
                <div class="form-check form-check-inline">
                    <input type="radio" class="form-check-input" id="general" name="postType" value="GENERAL" th:field="*{postType}">
                    <label class="form-check-label" for="general">일반</label>
                </div>
                <div class="form-check form-check-inline" th:if="${isOwner}">
                    <input type="radio" class="form-check-input" id="notice" name="postType" value="NOTICE" th:field="*{postType}">
                    <label class="form-check-label" for="notice">공지사항</label>
                </div>
                <div class="form-check form-check-inline">
                    <input type="radio" class="form-check-input" id="demand" name="postType" value="DEMAND" th:field="*{postType}">
                    <label class="form-check-label" for="demand">수요조사</label>
                </div>
            </div>

            <!-- 수요조사 영역 -->
            <div id="demandSurveyFields" class="survey-section" style="display:none;">
                <h5 class="mb-3"><i class="fa-solid fa-poll me-2"></i>수요조사 정보</h5>

                <div class="mb-3">
                    <label for="surveyTitle" class="form-label">수요조사 제목</label>
                    <input type="text" class="form-control" id="surveyTitle" th:field="*{demandSurvey.title}" placeholder="수요조사 제목">
                </div>

                <div class="mb-3">
                    <label for="surveyContent" class="form-label">수요조사 내용</label>
                    <textarea class="form-control" id="surveyContent" th:field="*{demandSurvey.content}" rows="3" placeholder="수요조사 내용"></textarea>
                </div>

                <div class="mb-3">
                    <label for="deadline" class="form-label">마감일</label>
                    <input type="datetime-local" class="form-control" id="deadline" th:field="*{demandSurvey.deadline}">
                </div>

                <!-- 수요조사 옵션 -->
                <div class="mb-3">
                    <label class="form-label">투표 항목</label>
                    <div id="voteOptionsContainer">
                        <!-- 기존 옵션 반복 -->
                        <div th:each="option, iterStat : ${postCreateRequestDTO.demandSurvey.options}" class="vote-option-item d-flex align-items-center mb-2">
                            <input type="text"
                                   class="form-control vote-option-input me-2"
                                   th:field="*{demandSurvey.options[__${iterStat.index}__]}"
                                   placeholder="옵션 입력">
                            <button type="button" class="btn btn-sm btn-outline-danger removeOptionBtn" style="border: none" title="삭제">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>

                        <!-- 기존 옵션이 없으면 빈 input 1개 생성 -->
                        <div th:if="${postCreateRequestDTO.demandSurvey.options == null or #lists.isEmpty(postCreateRequestDTO.demandSurvey.options)}" class="vote-option-item d-flex align-items-center mb-2">
                            <input type="text" class="form-control vote-option-input me-2" th:field="*{demandSurvey.options[0]}" placeholder="옵션 입력">
                            <button type="button" class="btn btn-sm btn-outline-danger removeOptionBtn" title="삭제">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" id="addOptionBtn" class="btn btn-sm btn-secondary-custom mt-2">+ 항목 추가</button>
                </div>

                <div class="mb-3">
                    <label class="form-label">투표 방식</label>
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input" id="voteTypeAnonymous" th:field="*{demandSurvey.voteType}" value="ANONYMOUS" checked>
                        <label class="form-check-label" for="voteTypeAnonymous">익명</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input" id="voteTypePublic" th:field="*{demandSurvey.voteType}" value="PUBLIC">
                        <label class="form-check-label" for="voteTypePublic">공개</label>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-primary-custom me-2">수정</button>
                <a th:href="@{/cafe/{cafeId}/posts/{postId}(cafeId=${post.cafeId}, postId=${post.id})}" class="btn btn-secondary-custom">취소</a>
            </div>
        </form>
    </div>
</main>

<div th:replace="~{layout/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const postTypeRadios = document.querySelectorAll('input[name="postType"]');
    const demandSurveyFields = document.getElementById('demandSurveyFields');
    const pinnedCheckbox = document.getElementById('pinned');
    const noticeRadio = document.getElementById('notice');

    const addOptionBtn = document.getElementById('addOptionBtn');
    const voteOptionsContainer = document.getElementById('voteOptionsContainer');

    // 옵션 삭제 버튼 이벤트 등록 함수
    function attachRemoveEvent(button) {
        button.addEventListener('click', () => {
            const item = button.closest('.vote-option-item');
            if (item) item.remove();
        });
    }

    // 초기 삭제 버튼 이벤트 등록
    document.querySelectorAll('.removeOptionBtn').forEach(attachRemoveEvent);

    // 새 옵션 추가
    addOptionBtn.addEventListener('click', () => {
        const index = voteOptionsContainer.querySelectorAll('.vote-option-input').length;

        const div = document.createElement('div');
        div.className = 'vote-option-item d-flex align-items-center mb-2';

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control vote-option-input me-2';
        input.name = `demandSurvey.options[${index}]`;
        input.placeholder = '옵션 입력';

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-sm btn-outline-danger removeOptionBtn';
        removeBtn.title = '삭제';
        removeBtn.style.cssText = `border: none;`;
        removeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
        removeBtn.addEventListener('click', () => {
            div.remove();
        });

        div.appendChild(input);
        div.appendChild(removeBtn);
        voteOptionsContainer.appendChild(div);
    });

    function toggleDemandSurveyFields() {
        const selectedRadio = document.querySelector('input[name="postType"]:checked');
        demandSurveyFields.style.display = (selectedRadio && selectedRadio.id === 'demand') ? 'block' : 'none';
    }

    function togglePinnedCheckbox() {
        if (noticeRadio && noticeRadio.checked) {
            pinnedCheckbox.disabled = false;
        } else {
            pinnedCheckbox.checked = false;
            pinnedCheckbox.disabled = true;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        toggleDemandSurveyFields();
        togglePinnedCheckbox();
    });

    postTypeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            toggleDemandSurveyFields();
            togglePinnedCheckbox();
        });
    });

    document.querySelector('form').addEventListener('submit', function(e) {
        const selectedPostType = document.querySelector('input[name="postType"]:checked');
        const optionInputs = document.querySelectorAll('.vote-option-input');
        const filledOptions = Array.from(optionInputs).filter(input => input.value.trim() !== '');
        const deadlineInput = document.querySelector('input[name="demandSurvey.deadline"]'); // 수정

        if (selectedPostType && selectedPostType.value === 'DEMAND') {
            if (filledOptions.length < 2) {
                e.preventDefault();
                alert('투표 항목은 최소 2개 이상 입력해야 합니다.');
                return;
            }
            if (!deadlineInput.value) {
                e.preventDefault();
                alert('수요조사 게시글에는 마감일을 입력해야 합니다.');
                deadlineInput.focus();
                return;
            }
        }
    });

</script>

</body>
</html>
