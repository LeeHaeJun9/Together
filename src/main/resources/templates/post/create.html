<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>게시글 작성</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    body {
      background-color: #f8f9fa; /* 연한 회색 배경 */
    }
    .container {
      margin-top: 50px;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="card shadow-sm p-4">
    <h2 class="card-title text-center mb-4" th:text="'게시글 작성'">게시글 작성</h2>

    <form th:action="@{/cafe/{cafeId}/posts/create(cafeId=${cafeId})}"
          th:object="${postCreateRequestDTO}" method="post" enctype="multipart/form-data">

      <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
      <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

      <div class="mb-3">
        <label for="title" class="form-label">제목:</label>
        <input type="text" class="form-control" id="title" th:field="*{title}" required>
      </div>

      <div class="mb-3">
        <label for="content" class="form-label">내용:</label>
        <textarea class="form-control" id="content" th:field="*{content}" rows="10" required></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">게시글 유형:</label>
        <div class="form-check">
          <input type="radio" class="form-check-input" id="general" name="postType" value="GENERAL" th:field="*{postType}">
          <label class="form-check-label" for="general">일반 게시글</label>
        </div>
        <div class="form-check" th:if="${isOwner}">
          <input type="radio" class="form-check-input" id="notice" name="postType" value="NOTICE" th:field="*{postType}">
          <label class="form-check-label" for="notice">공지사항</label>
        </div>
      </div>

      <div class="mb-3">
        <label for="imageFile" class="form-label">이미지:</label>
        <input type="file" class="form-control" id="imageFile" name="imageFile">
      </div>

      <div id="demandSurveyFields" style="display: none;">
        <h3 class="mt-4 mb-3">수요조사 정보</h3>
        <div class="mb-3">
          <label for="surveyTitle" class="form-label">수요조사 제목:</label>
          <input type="text" class="form-control" id="surveyTitle" name="demandSurvey.title">
        </div>
        <div class="mb-3">
          <label for="surveyContent" class="form-label">수요조사 내용:</label>
          <textarea class="form-control" id="surveyContent" name="demandSurvey.content" rows="3"></textarea>
        </div>
        <div class="mb-3">
          <label for="deadline" class="form-label">마감일:</label>
          <input type="datetime-local" class="form-control" id="deadline" name="demandSurvey.deadline">
        </div>
        <div class="mb-3">
          <label class="form-label">투표 타입:</label>
          <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" id="voteTypeAnonymous" name="demandSurvey.voteType" value="ANONYMOUS" checked>
            <label class="form-check-label" for="voteTypeAnonymous">익명 투표</label>
          </div>
          <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" id="voteTypePublic" name="demandSurvey.voteType" value="PUBLIC">
            <label class="form-check-label" for="voteTypePublic">공개 투표</label>
          </div>
        </div>
      </div>

      <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
        <button type="submit" class="btn btn-primary me-md-2">작성하기</button>
        <a th:href="@{/cafe/{cafeId}/posts(cafeId=${cafeId})}" class="btn btn-secondary">취소</a>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // 기존 JavaScript 로직 유지
  const postTypeRadios = document.querySelectorAll('input[name="postType"]');
  const demandSurveyFields = document.getElementById('demandSurveyFields');
  const deadlineInput = document.getElementById('deadline');
  const surveyTitleInput = document.getElementById('surveyTitle');
  const surveyContentTextarea = document.getElementById('surveyContent');
  const voteTypeAnonymousInput = document.getElementById('voteTypeAnonymous');
  const voteTypePublicInput = document.getElementById('voteTypePublic');

  function toggleDemandSurveyFields() {
    if (document.getElementById('notice').checked) {
      demandSurveyFields.style.display = 'block';
      surveyTitleInput.setAttribute('required', 'required');
      deadlineInput.setAttribute('required', 'required');
      voteTypeAnonymousInput.setAttribute('required', 'required');
      voteTypePublicInput.setAttribute('required', 'required');
    } else {
      demandSurveyFields.style.display = 'none';
      surveyTitleInput.removeAttribute('required');
      deadlineInput.removeAttribute('required');
      voteTypeAnonymousInput.removeAttribute('required');
      voteTypePublicInput.removeAttribute('required');
    }
  }

  // 페이지 로드 시 초기 상태 설정
  // 공지사항(isOwner)이 아닌 경우 체크된 라디오 버튼을 찾아서 실행
  const initialCheckedRadio = document.querySelector('input[name="postType"]:checked');
  if (initialCheckedRadio) {
    if (initialCheckedRadio.id === 'notice') {
      toggleDemandSurveyFields();
    }
  } else {
    // isOwner가 아닌 경우, 일반 게시글이 기본으로 체크되도록 함
    const generalRadio = document.getElementById('general');
    if (generalRadio) {
      generalRadio.checked = true;
      toggleDemandSurveyFields();
    }
  }

  // 라디오 버튼 변경 시 함수 호출
  postTypeRadios.forEach(radio => {
    radio.addEventListener('change', toggleDemandSurveyFields);
  });
</script>

</body>
</html>