<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${post.title}"></title>
  <style>
    /* ✅ 모달 스타일 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0,0,0);
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }
    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="container">
  <a th:href="@{/cafe/{cafeId}/posts(cafeId=${cafeId})}" class="btn btn-back">목록으로</a>
  <h1 th:text="${post.title}">게시글 제목</h1>
  <div class="post-meta">
    <span th:text="${post.authorName}">작성자</span>
    <span>|</span>
    <span th:text="'조회수: ' + ${post.viewCount}">조회수</span>
  </div>

  <div class="post-content">
    <div th:if="${post.image}">
      <img th:src="${post.image}" alt="게시글 이미지">
    </div>
    <p th:text="${post.content}">게시글 내용</p>
  </div>

  <div class="comments-section">
    <h2>댓글</h2>

    <div th:each="comment : ${comments}" class="comment-item">
      <p th:text="${comment.content}">댓글 내용</p>
      <div class="comment-meta">
        <span th:text="${comment.authorName}">작성자</span> |
        <span th:text="${#temporals.format(comment.regDate, 'yyyy-MM-dd HH:mm')}">작성일</span>

        <button th:if="${comment.isOwner()}"
                class="btn btn-sm btn-info edit-comment-btn"
                th:data-comment-id="${comment.id}"
                th:data-content="${comment.content}">수정</button>

        <form th:if="${comment.isOwner()}"
              th:action="@{/cafe/{cafeId}/posts/{postId}/comments/{commentId}/delete(cafeId=${post.cafeId}, postId=${post.id}, commentId=${comment.id})}"
              method="post" style="display:inline;">
          <button type="submit" class="btn btn-danger btn-sm"
                  onclick="return confirm('정말로 삭제하시겠습니까?');">삭제</button>
        </form>
      </div>
    </div>

    <div class="comment-form-container">
      <h3>댓글 작성</h3>
      <form th:action="@{/cafe/{cafeId}/posts/{postId}/comments(cafeId=${post.cafeId}, postId=${post.id})}"
            th:object="${commentCreateRequestDTO}" method="post">
        <textarea th:field="*{content}" rows="3" required></textarea>
        <button type="submit" class="btn btn-primary">댓글 작성</button>
      </form>
    </div>
  </div>
</div>

<div id="editCommentModal" class="modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h3>댓글 수정하기</h3>
    <form id="editCommentForm">
      <input type="hidden" id="editCommentId" name="commentId">
      <textarea id="editCommentContent" name="content" rows="3" required></textarea>
      <button type="submit" class="btn btn-primary">수정 완료</button>
    </form>
  </div>
</div>

<script th:inline="javascript">

  const modal = document.getElementById('editCommentModal');
  const closeBtn = document.querySelector('.close-button');
  const editForm = document.getElementById('editCommentForm');
  const commentIdInput = document.getElementById('editCommentId');
  const contentTextarea = document.getElementById('editCommentContent');
  const editButtons = document.querySelectorAll('.edit-comment-btn');

  editButtons.forEach(button => {
    button.addEventListener('click', (event) => {
      const commentId = event.target.dataset.commentId;
      const content = event.target.dataset.content;

      commentIdInput.value = commentId;
      contentTextarea.value = content;
      modal.style.display = 'block';
    });
  });

  closeBtn.addEventListener('click', () => {
    modal.style.display = 'none';
  });

  window.addEventListener('click', (event) => {
    if (event.target == modal) {
      modal.style.display = 'none';
    }
  });

  editForm.addEventListener('submit', (event) => {
    event.preventDefault();

    const commentId = commentIdInput.value;
    const newContent = contentTextarea.value;

    const cafeId = document.body.dataset.cafeId;
    const postId = document.body.dataset.postId;


    console.log("요청 URL: " + `/cafe/${cafeId}/posts/${postId}/comments/${commentId}/update`);

    fetch(`/cafe/${cafeId}/posts/${postId}/comments/${commentId}/update`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ content: newContent })
    })
            .then(response => {
              if (!response.ok) {
                return response.text().then(errorText => {
                  throw new Error(errorText);
                });
              }
              return response.text();
            })
            .then(message => {
              alert(message);
              location.reload();
            })
            .catch(error => {
              alert("수정 실패: " + error.message);
            });
  });
</script>
</body>
</html>