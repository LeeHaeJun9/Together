<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <title th:text="${post.title}"></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/postDetail.css}">

  <script th:inline="javascript">
    const postId = [[${post.id}]];
    const cafeId = [[${cafeId}]];
    const surveyId = [[${post.demandSurvey != null ? post.demandSurvey.id : null}]];
    const deadline = [[${post.demandSurvey != null ? post.demandSurvey.deadline : null}]];
    const loggedInUserId = [[${loggedInUserId}]];
    const csrfToken = /*[[${_csrf.token}]]*/ "";
    const csrfHeader = /*[[${_csrf.headerName}]]*/ "";
  </script>
</head>
<body>

<div th:replace="~{/layout/header :: header}"></div>

<main>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <a th:href="@{/cafe/{cafeId}/posts(cafeId=${cafeId})}" class="btn btn-custom-secondary">목록으로</a>
      <div class="post-actions">
        <a th:if="${post.owner}"
           th:href="@{/cafe/{cafeId}/posts/{postId}/edit(cafeId=${cafeId}, postId=${post.id})}"
           class="btn btn-custom-primary me-2">수정</a>

        <form th:if="${post.owner}"
              th:action="@{/cafe/{cafeId}/posts/{postId}/delete(cafeId=${cafeId}, postId=${post.id})}"
              method="post" class="d-inline-block">
          <button type="submit" class="btn btn-custom-danger" onclick="return confirm('정말로 삭제하시겠습니까?');">삭제</button>
        </form>
      </div>
    </div>

    <div class="post-content-section mb-4">
      <div class="post-header-container">
        <h1 th:text="${post.title}">게시글 제목</h1>
        <div class="post-meta">
          <span th:text="${post.authorName}">작성자</span> |
          <span th:text="'조회수: ' + ${post.viewCount}">조회수</span>
        </div>
      </div>
      <div class="post-content">
        <div th:if="${post.image}" class="text-center">
          <img th:src="${post.image}" class="img-fluid rounded" alt="게시글 이미지">
        </div>
        <p th:text="${post.content}">게시글 내용</p>
      </div>
    </div>

    <div th:if="${(post.postType.name() == 'NOTICE' or post.postType.name() == 'DEMAND') and post.demandSurvey != null}" class="demand-survey-section mb-4">
      <h2 class="h4" th:text="${post.demandSurvey.title}">수요조사 제목</h2>
      <p class="mb-2" th:text="${post.demandSurvey.content}">수요조사 내용</p>
      <p class="text-muted">마감일: <span th:text="${#temporals.format(post.demandSurvey.deadline, 'yyyy-MM-dd HH:mm')}"></span></p>

      <div id="voteContainer" class="mt-3">
      </div>
    </div>

    <div class="comment-section">
      <h2 class="h4">댓글</h2>
      <hr>

      <div th:each="comment : ${comments}" class="comment-item">
        <p class="mb-1" th:text="${comment.content}">댓글 내용</p>
        <div class="comment-meta d-flex justify-content-between align-items-center">
          <div>
            <span th:text="${comment.authorName}">작성자</span> |
            <span th:text="${#temporals.format(comment.regDate, 'yyyy-MM-dd HH:mm')}">작성일</span>
          </div>
          <div>
            <button th:if="${comment.isOwner()}"
                    class="btn btn-sm btn-custom-info edit-comment-btn me-2"
                    th:data-comment-id="${comment.id}"
                    th:data-content="${comment.content}">수정</button>

            <form th:if="${comment.isOwner()}"
                  th:action="@{/cafe/{cafeId}/posts/{postId}/comments/{commentId}/delete(cafeId=${post.cafeId}, postId=${post.id}, commentId=${comment.id})}"
                  method="post" class="d-inline">
              <button type="submit" class="btn btn-custom-danger btn-sm"
                      onclick="return confirm('정말로 삭제하시겠습니까?');">삭제</button>
            </form>
          </div>
        </div>
      </div>

      <div th:if="${#lists.isEmpty(comments)}" class="text-center text-muted py-4">
        <p>아직 댓글이 없습니다. 첫 댓글을 남겨보세요!</p>
      </div>

      <div class="comment-form-container mt-4">
        <h3 class="h5">댓글 작성</h3>
        <div th:if="${isLoggedIn}">
          <form th:action="@{/cafe/{cafeId}/posts/{postId}/comments(cafeId=${post.cafeId}, postId=${post.id})}"
                th:object="${commentCreateRequestDTO}" method="post">
            <textarea th:field="*{content}" class="form-control mb-2" rows="3" required></textarea>
            <div class="text-end">
              <button type="submit" class="btn btn-custom-primary">댓글 작성</button>
            </div>
          </form>
        </div>
        <div th:unless="${isLoggedIn}" class="text-center py-3">
          <p class="text-muted">댓글을 작성하려면 <a th:href="@{/login}">로그인</a>이 필요합니다.</p>
        </div>
      </div>
    </div>
  </div>
</main>

<div id="editCommentModal" class="modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h3 class="h5">댓글 수정하기</h3>
    <form id="editCommentForm" class="mt-3">
      <input type="hidden" id="editCommentId" name="commentId">
      <textarea id="editCommentContent" name="content" class="form-control mb-3" rows="3" required></textarea>
      <button type="submit" class="btn btn-custom-primary w-100">수정 완료</button>
    </form>
  </div>
</div>

<div th:replace="~{/layout/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/postDetail.js}"></script>
</body>
</html>