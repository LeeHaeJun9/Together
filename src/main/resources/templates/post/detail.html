<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${post.title}"></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .container {
      margin-top: 50px;
    }
    .post-header {
      border-bottom: 2px solid #dee2e6;
      padding-bottom: 1rem;
      margin-bottom: 2rem;
    }
    .post-content {
      white-space: pre-wrap;
      line-height: 1.8;
      font-size: 1.1rem;
      color: #343a40;
    }
    .post-content img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 1.5rem auto;
    }
    .comment-item {
      border-bottom: 1px solid #e9ecef;
      padding: 1rem 0;
    }
    .comment-item:last-child {
      border-bottom: none;
    }
    .comment-meta {
      font-size: 0.875rem;
      color: #6c757d;
    }
    .demand-survey-section {
      background-color: #e9ecef;
      padding: 20px;
      border-radius: 8px;
      margin-top: 2rem;
    }
    /* 모달 스타일 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1050;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 500px;
      max-width: 90%;
      border-radius: 8px;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <a th:href="@{/cafe/{cafeId}/posts(cafeId=${cafeId})}" class="btn btn-secondary">목록으로</a>
    <div class="post-actions">
      <a th:if="${post.owner}"
         th:href="@{/cafe/{cafeId}/posts/{postId}/edit(cafeId=${cafeId}, postId=${post.id})}"
         class="btn btn-primary me-2">수정</a>

      <form th:if="${post.owner}"
            th:action="@{/cafe/{cafeId}/posts/{postId}/delete(cafeId=${cafeId}, postId=${post.id})}"
            method="post" class="d-inline-block">
        <button type="submit" class="btn btn-danger" onclick="return confirm('정말로 삭제하시겠습니까?');">삭제</button>
      </form>
    </div>
  </div>

  <div class="card p-4 shadow-sm">
    <h1 class="card-title text-center post-header" th:text="${post.title}">게시글 제목</h1>
    <div class="card-subtitle text-muted text-center mb-3">
      <span th:text="${post.authorName}">작성자</span> |
      <span th:text="'조회수: ' + ${post.viewCount}">조회수</span>
    </div>

    <div class="card-body post-content">
      <div th:if="${post.image}" class="text-center">
        <img th:src="${post.image}" class="img-fluid rounded" alt="게시글 이미지">
      </div>
      <p th:text="${post.content}">게시글 내용</p>
    </div>
  </div>

  <div th:if="${post.postType.name() == 'NOTICE' and post.demandSurvey != null}" class="demand-survey-section">
    <h2 class="h4" th:text="${post.demandSurvey.title}">수요조사 제목</h2>
    <p class="mb-2" th:text="${post.demandSurvey.content}">수요조사 내용</p>
    <p class="text-muted">마감일: <span th:text="${#temporals.format(post.demandSurvey.deadline, 'yyyy-MM-dd HH:mm')}"></span></p>

    <div id="voteContainer" class="mt-3">
    </div>
  </div>

  <div class="comments-section mt-5">
    <h2 class="h4">댓글</h2>
    <hr>

    <div th:each="comment : ${comments}" class="comment-item">
      <p class="mb-1" th:text="${comment.content}">댓글 내용</p>
      <div class="comment-meta d-flex justify-content-between align-items-center">
        <div>
          <span th:text="${comment.authorName}">작성자</span> |
          <span th:text="${#temporals.format(comment.regDate, 'yyyy-MM-dd HH:mm')}">작성일</span>
        </div>
        <div>
          <button th:if="${comment.isOwner()}"
                  class="btn btn-sm btn-info edit-comment-btn me-2"
                  th:data-comment-id="${comment.id}"
                  th:data-content="${comment.content}">수정</button>

          <form th:if="${comment.isOwner()}"
                th:action="@{/cafe/{cafeId}/posts/{postId}/comments/{commentId}/delete(cafeId=${post.cafeId}, postId=${post.id}, commentId=${comment.id})}"
                method="post" class="d-inline">
            <button type="submit" class="btn btn-danger btn-sm"
                    onclick="return confirm('정말로 삭제하시겠습니까?');">삭제</button>
          </form>
        </div>
      </div>
    </div>

    <div th:if="${#lists.isEmpty(comments)}" class="text-center text-muted py-4">
      <p>아직 댓글이 없습니다. 첫 댓글을 남겨보세요!</p>
    </div>

    <div class="comment-form-container mt-4">
      <h3 class="h5">댓글 작성</h3>
      <div th:if="${isLoggedIn}">
        <form th:action="@{/cafe/{cafeId}/posts/{postId}/comments(cafeId=${post.cafeId}, postId=${post.id})}"
              th:object="${commentCreateRequestDTO}" method="post">
          <textarea th:field="*{content}" class="form-control mb-2" rows="3" required></textarea>
          <div class="text-end">
            <button type="submit" class="btn btn-primary">댓글 작성</button>
          </div>
        </form>
      </div>
      <div th:unless="${isLoggedIn}" class="text-center py-3">
        <p class="text-muted">댓글을 작성하려면 <a th:href="@{/login}">로그인</a>이 필요합니다.</p>
      </div>
    </div>
  </div>
</div>

<div id="editCommentModal" class="modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h3 class="h5">댓글 수정하기</h3>
    <form id="editCommentForm" class="mt-3">
      <input type="hidden" id="editCommentId" name="commentId">
      <textarea id="editCommentContent" name="content" class="form-control mb-3" rows="3" required></textarea>
      <button type="submit" class="btn btn-primary w-100">수정 완료</button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
  const modal = document.getElementById('editCommentModal');
  const closeBtn = document.querySelector('.close-button');
  const editForm = document.getElementById('editCommentForm');
  const commentIdInput = document.getElementById('editCommentId');
  const contentTextarea = document.getElementById('editCommentContent');
  const editButtons = document.querySelectorAll('.edit-comment-btn');
  const postId = /*[[${post.id}]]*/ null;
  const cafeId = /*[[${cafeId}]]*/ null;
  const surveyId = /*[[${post.demandSurvey != null ? post.demandSurvey.id : null}]]*/ null;
  const deadline = /*[[${post.demandSurvey != null ? post.demandSurvey.deadline : null}]]*/ null;
  const loggedInUserId = /*[[${loggedInUserId}]]*/ null;

  const voteContainer = document.getElementById('voteContainer');

  if (surveyId) {
    // 투표 또는 결과 UI를 렌더링하는 메인 함수
    function renderVoteUI() {
      const now = new Date();
      const deadlineDate = new Date(deadline);
      const isExpired = now > deadlineDate;

      fetch(`/api/cafe/${cafeId}/posts/${postId}/demand-survey/${surveyId}/hasVoted?userId=${loggedInUserId}`)
              .then(response => response.json())
              .then(hasVoted => {
                if (isExpired || hasVoted) {
                  // 투표가 마감되었거나 이미 참여한 경우: 결과 UI 표시
                  showVoteResults();
                } else {
                  // 투표가 마감되지 않았고 참여하지 않은 경우: 투표 폼 UI 표시
                  showVoteForm();
                }
              })
              .catch(error => {
                console.error('투표 참여 여부 확인 실패:', error);
                voteContainer.innerHTML = `<div class="alert alert-danger">투표 정보를 불러오는 중 오류가 발생했습니다.</div>`;
              });
    }

    // 투표 폼 UI를 렌더링하는 함수
    function showVoteForm() {
      let html = `
        <div class="vote-form-options mb-3">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" id="vote-option-1" name="voteOption" value="찬성">
            <label class="form-check-label" for="vote-option-1">찬성</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" id="vote-option-2" name="voteOption" value="반대">
            <label class="form-check-label" for="vote-option-2">반대</label>
          </div>
        </div>
        <button id="submitVoteBtn" class="btn btn-primary">투표하기</button>
      `;
      voteContainer.innerHTML = html;

      // 투표 버튼 클릭 이벤트 리스너
      document.getElementById('submitVoteBtn').addEventListener('click', () => {
        const selectedOption = document.querySelector('input[name="voteOption"]:checked');
        if (selectedOption) {
          submitVote(selectedOption.value);
        } else {
          alert("옵션을 선택해주세요.");
        }
      });
    }

    // 투표 결과를 렌더링하는 함수
    async function showVoteResults() {
      try {
        const response = await fetch(`/api/cafe/${cafeId}/posts/${postId}/demand-survey/${surveyId}/votes`);
        if (!response.ok) {
          throw new Error('투표 결과를 가져오는 데 실패했습니다.');
        }
        const results = await response.json();

        let html = '<h5>투표 결과</h5><ul class="list-group">';
        results.forEach(result => {
          html += `<li class="list-group-item d-flex justify-content-between align-items-center">${result.option}
                      <span class="badge bg-primary rounded-pill">${result.count}표</span></li>`;
        });
        html += '</ul>';
        voteContainer.innerHTML = html;
      } catch (error) {
        voteContainer.innerHTML = `<div class="alert alert-danger mt-3">오류: ${error.message}</div>`;
      }
    }

    // 투표를 백엔드로 전송하는 함수
    async function submitVote(option) {
      if (!loggedInUserId) {
        alert("로그인 후 이용 가능합니다.");
        return;
      }
      try {
        const response = await fetch(`/api/cafe/${cafeId}/posts/${postId}/demand-survey/${surveyId}/votes`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ option: option, userId: loggedInUserId })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText);
        }
        alert("투표가 완료되었습니다.");
        renderVoteUI();
      } catch (error) {
        alert("투표 실패: " + error.message);
      }
    }

    renderVoteUI();
  }

  editButtons.forEach(button => {
    button.addEventListener('click', (event) => {
      const commentId = event.target.dataset.commentId;
      const content = event.target.dataset.content;

      commentIdInput.value = commentId;
      contentTextarea.value = content;
      modal.style.display = 'block';
    });
  });

  closeBtn.addEventListener('click', () => {
    modal.style.display = 'none';
  });

  window.addEventListener('click', (event) => {
    if (event.target == modal) {
      modal.style.display = 'none';
    }
  });

  editForm.addEventListener('submit', (event) => {
    event.preventDefault();

    const commentId = commentIdInput.value;
    const newContent = contentTextarea.value;

    fetch(`/cafe/${cafeId}/posts/${postId}/comments/${commentId}/update`, {
      method: 'POST', // POST로 변경
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ content: newContent })
    })
            .then(response => {
              if (!response.ok) {
                return response.text().then(errorText => {
                  throw new Error(errorText);
                });
              }
              return response.text();
            })
            .then(message => {
              alert(message);
              location.reload();
            })
            .catch(error => {
              alert("수정 실패: " + error.message);
            });
  });
</script>
</body>
</html>