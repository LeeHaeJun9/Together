<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${post.title}"></title>
  <style>
    /* ✅ 모달 스타일 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0,0,0);
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }
    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="post-actions">
    <a th:if="${post.owner}"
       th:href="@{/cafe/{cafeId}/posts/{postId}/edit(cafeId=${cafeId}, postId=${post.id})}"
       class="btn btn-primary">수정</a>

    <form th:if="${post.owner}"
          th:action="@{/cafe/{cafeId}/posts/{postId}/delete(cafeId=${cafeId}, postId=${post.id})}"
          method="post" style="display:inline-block;">
      <button type="submit" class="btn btn-danger" onclick="return confirm('정말로 삭제하시겠습니까?');">삭제</button>
    </form>
  </div>
  <a th:href="@{/cafe/{cafeId}/posts(cafeId=${cafeId})}" class="btn btn-back">목록으로</a>
  <h1 th:text="${post.title}">게시글 제목</h1>
  <div class="post-meta">
    <span th:text="${post.authorName}">작성자</span>
    <span>|</span>
    <span th:text="'조회수: ' + ${post.viewCount}">조회수</span>
  </div>

  <div class="post-content">
    <div th:if="${post.image}">
      <img th:src="${post.image}" alt="게시글 이미지">
    </div>
    <p th:text="${post.content}">게시글 내용</p>
  </div>

  <div th:if="${post.postType.name() == 'NOTICE' and post.demandSurvey != null}" class="demand-survey-section">
    <h2 th:text="${post.demandSurvey.title}">수요조사 제목</h2>
    <p th:text="${post.demandSurvey.content}">수요조사 내용</p>
    <p>마감일: <span th:text="${#temporals.format(post.demandSurvey.deadline, 'yyyy-MM-dd HH:mm')}"></span></p>

    <div id="voteContainer">
    </div>
  </div>

  <div class="comments-section">
    <h2>댓글</h2>

    <div th:each="comment : ${comments}" class="comment-item">
      <p th:text="${comment.content}">댓글 내용</p>
      <div class="comment-meta">
        <span th:text="${comment.authorName}">작성자</span> |
        <span th:text="${#temporals.format(comment.regDate, 'yyyy-MM-dd HH:mm')}">작성일</span>

        <button th:if="${comment.isOwner()}"
                class="btn btn-sm btn-info edit-comment-btn"
                th:data-comment-id="${comment.id}"
                th:data-content="${comment.content}">수정</button>

        <form th:if="${comment.isOwner()}"
              th:action="@{/cafe/{cafeId}/posts/{postId}/comments/{commentId}/delete(cafeId=${post.cafeId}, postId=${post.id}, commentId=${comment.id})}"
              method="post" style="display:inline;">
          <button type="submit" class="btn btn-danger btn-sm"
                  onclick="return confirm('정말로 삭제하시겠습니까?');">삭제</button>
        </form>
      </div>
    </div>

    <div class="comment-form-container">
      <h3>댓글 작성</h3>
      <form th:action="@{/cafe/{cafeId}/posts/{postId}/comments(cafeId=${post.cafeId}, postId=${post.id})}"
            th:object="${commentCreateRequestDTO}" method="post">
        <textarea th:field="*{content}" rows="3" required></textarea>
        <button type="submit" class="btn btn-primary">댓글 작성</button>
      </form>
    </div>
  </div>
</div>

<div id="editCommentModal" class="modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h3>댓글 수정하기</h3>
    <form id="editCommentForm">
      <input type="hidden" id="editCommentId" name="commentId">
      <textarea id="editCommentContent" name="content" rows="3" required></textarea>
      <button type="submit" class="btn btn-primary">수정 완료</button>
    </form>
  </div>
</div>

<script th:inline="javascript">

  const modal = document.getElementById('editCommentModal');
  const closeBtn = document.querySelector('.close-button');
  const editForm = document.getElementById('editCommentForm');
  const commentIdInput = document.getElementById('editCommentId');
  const contentTextarea = document.getElementById('editCommentContent');
  const editButtons = document.querySelectorAll('.edit-comment-btn');
  const postId = /*[[${post.id}]]*/ null;
  const cafeId = /*[[${cafeId}]]*/ null;
  const surveyId = /*[[${post.demandSurvey != null ? post.demandSurvey.id : null}]]*/ null;
  const deadline = /*[[${post.demandSurvey != null ? post.demandSurvey.deadline : null}]]*/ null;
  // TODO: userId를 로그인된 사용자의 실제 ID로 설정해야 합니다.
  const userId = /*[[${post.isOwner ? -1 : 1}]]*/ null;

  const voteContainer = document.getElementById('voteContainer');

  // ✅ 투표 관련 로직
  if (surveyId) {
    // 투표 또는 결과 UI를 렌더링하는 메인 함수
    function renderVoteUI() {
      const now = new Date();
      const deadlineDate = new Date(deadline);
      const isExpired = now > deadlineDate;

      // TODO: 사용자가 이미 투표했는지 확인하는 API 호출 (백엔드에 추가 필요)
      const hasVoted = false; // 임시값, 실제로는 API 응답으로 결정

      if (isExpired || hasVoted) {
        // 투표가 마감되었거나 이미 참여한 경우: 결과 UI 표시
        showVoteResults();
      } else {
        // 투표가 마감되지 않았고 참여하지 않은 경우: 투표 폼 UI 표시
        showVoteForm();
      }
    }

    // 투표 폼 UI를 렌더링하는 함수
    function showVoteForm() {
      let html = `
        <div class="vote-form-options">
          <input type="radio" id="vote-option-1" name="voteOption" value="찬성">
          <label for="vote-option-1">참석</label><br>
          <input type="radio" id="vote-option-2" name="voteOption" value="반대">
          <label for="vote-option-2">비참석</label><br>
        </div>
        <button id="submitVoteBtn">투표하기</button>
      `;
      voteContainer.innerHTML = html;

      // 투표 버튼 클릭 이벤트 리스너
      document.getElementById('submitVoteBtn').addEventListener('click', () => {
        const selectedOption = document.querySelector('input[name="voteOption"]:checked');
        if (selectedOption) {
          submitVote(selectedOption.value);
        } else {
          alert("옵션을 선택해주세요.");
        }
      });
    }

    // 투표 결과를 렌더링하는 함수
    async function showVoteResults() {
      try {
        const response = await fetch(`/cafe/${cafeId}/posts/${postId}/demand-survey/${surveyId}/votes`);
        if (!response.ok) {
          throw new Error('투표 결과를 가져오는 데 실패했습니다.');
        }
        const results = await response.json();

        let html = '<h4>투표 결과</h4><ul>';
        results.forEach(result => {
          html += `<li>${result.option}: ${result.count}표</li>`;
        });
        html += '</ul>';
        voteContainer.innerHTML = html;
      } catch (error) {
        voteContainer.innerHTML = `<div style="color:red;">오류: ${error.message}</div>`;
      }
    }

    // 투표를 백엔드로 전송하는 함수
    async function submitVote(option) {
      try {
        const response = await fetch(`/cafe/${cafeId}/posts/${postId}/demand-survey/${surveyId}/votes`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ option: option })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText);
        }
        alert("투표가 완료되었습니다.");
        renderVoteUI(); // UI를 결과 화면으로 전환
      } catch (error) {
        alert("투표 실패: " + error.message);
      }
    }

    renderVoteUI();
  }

  editButtons.forEach(button => {
    button.addEventListener('click', (event) => {
      const commentId = event.target.dataset.commentId;
      const content = event.target.dataset.content;

      commentIdInput.value = commentId;
      contentTextarea.value = content;
      modal.style.display = 'block';
    });
  });

  closeBtn.addEventListener('click', () => {
    modal.style.display = 'none';
  });

  window.addEventListener('click', (event) => {
    if (event.target == modal) {
      modal.style.display = 'none';
    }
  });

  editForm.addEventListener('submit', (event) => {
    event.preventDefault();

    const commentId = commentIdInput.value;
    const newContent = contentTextarea.value;

    const cafeId = document.body.dataset.cafeId;
    const postId = document.body.dataset.postId;


    console.log("요청 URL: " + `/cafe/${cafeId}/posts/${postId}/comments/${commentId}/update`);

    fetch(`/cafe/${cafeId}/posts/${postId}/comments/${commentId}/update`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ content: newContent })
    })
            .then(response => {
              if (!response.ok) {
                return response.text().then(errorText => {
                  throw new Error(errorText);
                });
              }
              return response.text();
            })
            .then(message => {
              alert(message);
              location.reload();
            })
            .catch(error => {
              alert("수정 실패: " + error.message);
            });
  });
</script>
</body>
</html>