<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카페 관리 - Together Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .cafe-card {
            transition: all 0.3s;
            border-left: 4px solid #28a745;
        }
        .cafe-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .cafe-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }
        .status-active { color: #28a745; }
        .status-pending { color: #ffc107; }
        .status-suspended { color: #dc3545; }
        .status-rejected { color: #6c757d; }
        .filter-section {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }
        .btn-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            margin: 0.125rem;
        }
        .sidebar {
            background-color: #f8f9fa;
            min-height: calc(100vh - 200px);
            border-radius: 10px;
        }
        .nav-link {
            color: #495057;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .nav-link:hover {
            background-color: #e9ecef;
            color: #28a745;
        }
        .nav-link.active {
            background-color: #28a745;
            color: white;
        }
        .category-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .member-count {
            font-size: 0.875rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
<!-- Admin Header -->
<div class="admin-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2><i class="fas fa-coffee me-2"></i>카페 관리</h2>
                <p class="mb-0">플랫폼의 카페를 관리하고 승인 처리를 하세요</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="/manager/manager" class="btn btn-light me-2">
                    <i class="fas fa-tachometer-alt"></i> 대시보드
                </a>
                <div class="dropdown d-inline">
                    <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-shield"></i> 관리자님
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/mypage">마이페이지</a></li>
                        <li><a class="dropdown-item" href="/main">사용자 모드</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout">로그아웃</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2">
            <div class="sidebar p-3">
                <nav class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="/manager/manager">
                            <i class="fas fa-tachometer-alt me-2"></i>대시보드
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/manager/mUser">
                            <i class="fas fa-users me-2"></i>회원 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/manager/mCafe">
                            <i class="fas fa-coffee me-2"></i>카페 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/manager/mTrade">
                            <i class="fas fa-shopping-cart me-2"></i>거래 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/manager/mMeeting">
                            <i class="fas fa-calendar-alt me-2"></i>모임 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/manager/mReport">
                            <i class="fas fa-exclamation-triangle me-2"></i>신고 관리
                        </a>
                    </li>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-10">
            <!-- Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-coffee fa-2x mb-2"></i>
                            <h4 th:text="${totalCafes ?: 89}">89</h4>
                            <small>총 카페수</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <h4 th:text="${activeCafes ?: 76}">76</h4>
                            <small>활성 카페</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <h4 th:text="${pendingCafes ?: 8}">8</h4>
                            <small>승인 대기</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-plus fa-2x mb-2"></i>
                            <h4 th:text="${newCafesToday ?: 3}">3</h4>
                            <small>오늘 신청</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter Section -->
            <div class="filter-section">
                <form method="get" action="/manager/mCafe">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">검색</label>
                            <input type="text" class="form-control" name="search"
                                   placeholder="카페명, 설명" th:value="${searchTerm}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">상태</label>
                            <select class="form-select" name="status">
                                <option value="">전체</option>
                                <option value="ACTIVE" th:selected="${status == 'ACTIVE'}">활성</option>
                                <option value="PENDING" th:selected="${status == 'PENDING'}">승인대기</option>
                                <option value="SUSPENDED" th:selected="${status == 'SUSPENDED'}">정지</option>
                                <option value="REJECTED" th:selected="${status == 'REJECTED'}">거부됨</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">카테고리</label>
                            <select class="form-select" name="category">
                                <option value="">전체</option>
                                <option value="MUSIC" th:selected="${category == 'MUSIC'}">음악</option>
                                <option value="SPORTS" th:selected="${category == 'SPORTS'}">스포츠</option>
                                <option value="STUDY" th:selected="${category == 'STUDY'}">스터디</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">정렬</label>
                            <select class="form-select" name="sort">
                                <option value="regDate" th:selected="${sort == 'regDate'}">등록일순</option>
                                <option value="name" th:selected="${sort == 'name'}">이름순</option>
                                <option value="memberCount" th:selected="${sort == 'memberCount'}">멤버수순</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-success me-2">
                                <i class="fas fa-search"></i> 검색
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                                <i class="fas fa-undo"></i> 초기화
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Bulk Actions -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="selectAll()">
                        <i class="fas fa-check-square"></i> 전체선택
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="bulkApprove()">
                        <i class="fas fa-check"></i> 선택 승인
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="bulkReject()">
                        <i class="fas fa-times"></i> 선택 거부
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="bulkSuspend()">
                        <i class="fas fa-ban"></i> 선택 정지
                    </button>
                </div>
                <div>
                    <span class="text-muted">총 <strong th:text="${totalCount ?: 89}">89</strong>개의 카페</span>
                </div>
            </div>

            <!-- Cafe Table -->
            <div class="card">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox"></th>
                            <th>썸네일</th>
                            <th>카페명</th>
                            <th>카테고리</th>
                            <th>생성자</th>
                            <th>멤버수</th>
                            <th>상태</th>
                            <th>등록일</th>
                            <th>관리</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="cafe : ${cafes}" th:if="${cafes != null and !cafes.isEmpty()}">
                            <td>
                                <input type="checkbox" class="cafe-checkbox" th:value="${cafe.id}">
                            </td>
                            <td>
                                <img th:src="${cafe.thumbnail ?: '/images/default-cafe.png'}"
                                     alt="카페 썸네일" class="cafe-thumbnail">
                            </td>
                            <td>
                                <strong th:text="${cafe.name}">독서 모임</strong>
                                <br><small class="text-muted" th:text="${#strings.abbreviate(cafe.description, 30)}">카페 설명...</small>
                            </td>
                            <td>
                                    <span class="badge category-badge"
                                          th:class="${cafe.category == 'MUSIC' ? 'bg-info' :
                                                       cafe.category == 'SPORTS' ? 'bg-warning' : 'bg-primary'}"
                                          th:text="${cafe.category == 'MUSIC' ? '음악' :
                                                       cafe.category == 'SPORTS' ? '스포츠' : '스터디'}">
                                        스터디
                                    </span>
                            </td>
                            <td>
                                <span th:text="${cafe.owner.nickname}">카페장</span>
                                <br><small class="text-muted" th:text="${cafe.owner.userId}">user123</small>
                            </td>
                            <td>
                                    <span class="member-count">
                                        <i class="fas fa-users"></i>
                                        <span th:text="${cafe.memberCount ?: 0}">0</span>명
                                    </span>
                            </td>
                            <td>
                                    <span class="badge"
                                          th:class="${cafe.status == 'ACTIVE' ? 'bg-success' :
                                                       cafe.status == 'PENDING' ? 'bg-warning' :
                                                       cafe.status == 'SUSPENDED' ? 'bg-danger' : 'bg-secondary'}"
                                          th:text="${cafe.status == 'ACTIVE' ? '활성' :
                                                       cafe.status == 'PENDING' ? '대기' :
                                                       cafe.status == 'SUSPENDED' ? '정지' : '거부'}">
                                        활성
                                    </span>
                            </td>
                            <td th:text="${#temporals.format(cafe.regDate, 'yyyy-MM-dd')}">2024-01-15</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-info btn-action"
                                            th:onclick="|viewCafeDetail(${cafe.id})|">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-success btn-action"
                                            th:if="${cafe.status == 'PENDING'}"
                                            th:onclick="|approveCafe(${cafe.id})|">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-action"
                                            th:if="${cafe.status == 'PENDING'}"
                                            th:onclick="|rejectCafe(${cafe.id})|">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button class="btn btn-outline-warning btn-action"
                                            th:if="${cafe.status == 'ACTIVE'}"
                                            th:onclick="|suspendCafe(${cafe.id})|">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                    <button class="btn btn-outline-primary btn-action"
                                            th:if="${cafe.status == 'SUSPENDED'}"
                                            th:onclick="|reactivateCafe(${cafe.id})|">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <!-- Empty State -->
                        <tr th:if="${cafes == null or cafes.isEmpty()}">
                            <td colspan="9" class="text-center py-4">
                                <i class="fas fa-coffee fa-3x text-muted mb-3"></i>
                                <br><span class="text-muted">조건에 맞는 카페가 없습니다.</span>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <nav th:if="${totalPages > 1}" aria-label="Cafe pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item" th:class="${currentPage == 0} ? 'disabled'">
                        <a class="page-link" th:href="@{/manager/mCafe(page=${currentPage - 1}, search=${searchTerm}, status=${status}, category=${category}, sort=${sort})}">이전</a>
                    </li>
                    <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                        th:class="${i == currentPage} ? 'active'">
                        <a class="page-link"
                           th:href="@{/manager/mCafe(page=${i}, search=${searchTerm}, status=${status}, category=${category}, sort=${sort})}"
                           th:text="${i + 1}">1</a>
                    </li>
                    <li class="page-item" th:class="${currentPage == totalPages - 1} ? 'disabled'">
                        <a class="page-link" th:href="@{/manager/mCafe(page=${currentPage + 1}, search=${searchTerm}, status=${status}, category=${category}, sort=${sort})}">다음</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Cafe Detail Modal -->
<div class="modal fade" id="cafeDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">카페 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="cafeDetailContent">
                <!-- Cafe detail content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="modalApproveBtn" style="display: none;">승인</button>
                <button type="button" class="btn btn-danger" id="modalRejectBtn" style="display: none;">거부</button>
                <button type="button" class="btn btn-warning" id="modalSuspendBtn" style="display: none;">정지</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Filter reset function
    function resetFilters() {
        window.location.href = '/manager/mCafe';
    }

    // Select all function
    function selectAll() {
        const checkboxes = document.querySelectorAll('.cafe-checkbox');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    }

    // Bulk operations
    function bulkApprove() {
        const selectedCafes = getSelectedCafes();
        if (selectedCafes.length === 0) {
            alert('승인할 카페를 선택해주세요.');
            return;
        }
        if (confirm(`선택한 ${selectedCafes.length}개의 카페를 승인하시겠습니까?`)) {
            // API call for bulk approve
            console.log('Approving cafes:', selectedCafes);
            location.reload();
        }
    }

    function bulkReject() {
        const selectedCafes = getSelectedCafes();
        if (selectedCafes.length === 0) {
            alert('거부할 카페를 선택해주세요.');
            return;
        }
        const reason = prompt('거부 사유를 입력해주세요:');
        if (reason && confirm(`선택한 ${selectedCafes.length}개의 카페를 거부하시겠습니까?`)) {
            // API call for bulk reject
            console.log('Rejecting cafes:', selectedCafes, 'Reason:', reason);
            location.reload();
        }
    }

    function bulkSuspend() {
        const selectedCafes = getSelectedCafes();
        if (selectedCafes.length === 0) {
            alert('정지할 카페를 선택해주세요.');
            return;
        }
        const reason = prompt('정지 사유를 입력해주세요:');
        if (reason && confirm(`선택한 ${selectedCafes.length}개의 카페를 정지하시겠습니까?`)) {
            // API call for bulk suspend
            console.log('Suspending cafes:', selectedCafes, 'Reason:', reason);
            location.reload();
        }
    }

    function getSelectedCafes() {
        const checkboxes = document.querySelectorAll('.cafe-checkbox:checked');
        return Array.from(checkboxes).map(cb => cb.value);
    }

    // Individual cafe actions
    function viewCafeDetail(cafeId) {
        // Load cafe detail via AJAX and show modal
        fetch(`/api/admin/cafes/${cafeId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('cafeDetailContent').innerHTML = `
                    <div class="row">
                        <div class="col-md-4">
                            <img src="${data.thumbnail || '/images/default-cafe.png'}"
                                 class="img-fluid rounded mb-3" style="width: 100%;">
                            <h6>카페 정보</h6>
                            <p><strong>카테고리:</strong> ${data.category}</p>
                            <p><strong>생성자:</strong> ${data.owner.name} (${data.owner.userId})</p>
                            <p><strong>멤버수:</strong> ${data.memberCount}명</p>
                            <p><strong>등록일:</strong> ${data.regDate}</p>
                            <p><strong>상태:</strong> ${data.status}</p>
                        </div>
                        <div class="col-md-8">
                            <h5>${data.name}</h5>
                            <p class="text-muted">${data.description}</p>

                            <h6>최근 활동</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>활동 유형</th>
                                            <th>내용</th>
                                            <th>일시</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>모임 개최</td>
                                            <td>정기 모임</td>
                                            <td>2024-01-20</td>
                                        </tr>
                                        <tr>
                                            <td>신규 가입</td>
                                            <td>user123 가입</td>
                                            <td>2024-01-19</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

                // Show/hide action buttons based on status
                const approveBtn = document.getElementById('modalApproveBtn');
                const rejectBtn = document.getElementById('modalRejectBtn');
                const suspendBtn = document.getElementById('modalSuspendBtn');

                if (data.status === 'PENDING') {
                    approveBtn.style.display = 'inline-block';
                    rejectBtn.style.display = 'inline-block';
                    suspendBtn.style.display = 'none';
                } else if (data.status === 'ACTIVE') {
                    approveBtn.style.display = 'none';
                    rejectBtn.style.display = 'none';
                    suspendBtn.style.display = 'inline-block';
                } else {
                    approveBtn.style.display = 'none';
                    rejectBtn.style.display = 'none';
                    suspendBtn.style.display = 'none';
                }

                // Set button event handlers
                approveBtn.onclick = () => approveCafe(cafeId);
                rejectBtn.onclick = () => rejectCafe(cafeId);
                suspendBtn.onclick = () => suspendCafe(cafeId);

                new bootstrap.Modal(document.getElementById('cafeDetailModal')).show();
            })
            .catch(error => {
                alert('카페 정보를 불러오는데 실패했습니다.');
            });
    }

    function approveCafe(cafeId) {
        if (confirm('이 카페를 승인하시겠습니까?')) {
            fetch(`/api/admin/cafes/${cafeId}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => {
                    if (response.ok) {
                        alert('카페가 승인되었습니다.');
                        location.reload();
                    } else {
                        alert('승인 처리에 실패했습니다.');
                    }
                });
        }
    }

    function rejectCafe(cafeId) {
        const reason = prompt('거부 사유를 입력해주세요:');
        if (reason && confirm('이 카페를 거부하시겠습니까?')) {
            fetch(`/api/admin/cafes/${cafeId}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason: reason })
            })
                .then(response => {
                    if (response.ok) {
                        alert('카페가 거부되었습니다.');
                        location.reload();
                    } else {
                        alert('거부 처리에 실패했습니다.');
                    }
                });
        }
    }

    function suspendCafe(cafeId) {
        const reason = prompt('정지 사유를 입력해주세요:');
        if (reason && confirm('이 카페를 정지하시겠습니까?')) {
            fetch(`/api/admin/cafes/${cafeId}/suspend`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason: reason })
            })
                .then(response => {
                    if (response.ok) {
                        alert('카페가 정지되었습니다.');
                        location.reload();
                    } else {
                        alert('정지 처리에 실패했습니다.');
                    }
                });
        }
    }

    function reactivateCafe(cafeId) {
        if (confirm('이 카페를 다시 활성화하시겠습니까?')) {
            fetch(`/api/admin/cafes/${cafeId}/reactivate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => {
                    if (response.ok) {
                        alert('카페가 활성화되었습니다.');
                        location.reload();
                    } else {
                        alert('활성화 처리에 실패했습니다.');
                    }
                });
        }
    }

    // Select all checkbox functionality
    document.getElementById('selectAllCheckbox').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.cafe-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });
</script>
</body>
</html>