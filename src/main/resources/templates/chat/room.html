<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title th:text="${trade != null ? '채팅 - ' + trade.title : '채팅'}">채팅</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root{ --bg:#f6f7fb; --line:#e9edf3; --text-muted:#6c757d; --bubble-me:#d7ecff; --bubble-you:#ffffff; }
        body{background:#fff;}
        .chat-wrap{max-width:960px;margin:0 auto;}
        .trade-head{position:sticky;top:0;z-index:100;background:linear-gradient(180deg,#fff 0%, #fff 70%, rgba(255,255,255,.9) 100%);border-bottom:1px solid var(--line);padding:14px 12px;border-radius:0 0 16px 16px;backdrop-filter:saturate(160%) blur(8px);}
        .prod-thumb{width:clamp(120px,18vw,180px);height:clamp(120px,18vw,180px);border-radius:14px;object-fit:cover;border:1px solid var(--line);background:#f1f3f5;flex:0 0 auto;}
        .title-ellipsis{max-width:clamp(220px,52vw,560px);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .chat-box{height:66vh;overflow-y:auto;background:var(--bg);border:1px solid var(--line);border-radius:16px;padding:14px;scroll-behavior:smooth;}
        .day-sep{display:flex;align-items:center;gap:10px;margin:12px 0;color:var(--text-muted);font-size:.85rem;}
        .day-sep::before,.day-sep::after{content:"";flex:1 1 0;height:1px;background:var(--line);}
        .msg-row{display:flex;align-items:flex-end;gap:10px;margin:12px 0;}
        .msg-row.me{justify-content:flex-end;}
        .msg-row.you{justify-content:flex-start;}
        .avatar{width:36px;height:36px;border-radius:50%;background:#e9f2ff;color:#1b66d2;font-weight:700;display:flex;align-items:center;justify-content:center;border:1px solid var(--line);user-select:none;}
        .msg-row.me .avatar{display:none;}
        .msg-col{display:flex;flex-direction:column;max-width:70%;}
        .msg-row.me  .msg-col{align-items:flex-end;}
        .msg-row.you .msg-col{align-items:flex-start;}
        .name{font-size:.82rem;color:var(--text-muted);margin-bottom:4px;}
        .msg-row.me .name{text-align:right;}
        .bubbleline{display:flex;align-items:flex-end;gap:6px;}
        .msg-row.me  .bubbleline{justify-content:flex-end;}
        .msg-row.you .bubbleline{justify-content:flex-start;}
        .bubble{border-radius:16px;padding:10px 12px;box-shadow:0 1px 3px rgba(0,0,0,.06);background:var(--bubble-you);border:1px solid var(--line);max-width:100%;}
        .msg-row.me .bubble{background:var(--bubble-me);border-color:#cfe5fb;}
        .text{white-space:pre-wrap;word-break:break-word;}
        .time-out{font-size:.75rem;color:var(--text-muted);white-space:nowrap;min-width:42px;line-height:1;text-align:center;}
        .msg-row.me  .time-out{margin-right:6px;}
        .msg-row.you .time-out{margin-left:6px;}

        /* ===== 상단 우측 묶음: ‘목록’ 아이콘 + 상태 변경 컨트롤 ===== */
        .head-right{ display:flex; flex-direction:column; align-items:flex-end; gap:20px; }

        /* 리스트 화면과 동일한 아이콘 버튼 스타일 */
        .icon-btn{
            width:44px; height:44px; padding:0; border-radius:10px;
            display:inline-flex; align-items:center; justify-content:center;
            border:none; background:transparent; color:#6c757d; text-decoration:none; transition:.15s;
            line-height:0;
        }
        .icon-btn:hover{ color:#0d6efd; background:#f5f9ff; }
        .icon-btn:focus{ outline:none; box-shadow:0 0 0 .2rem rgba(13,110,253,.15); }
        .icon-btn svg{ width:27px; height:27px; }

        /* ===== 입력 영역: 버튼을 '박스 밖 오른쪽'에 배치 ===== */
        .sendbar{position:sticky;bottom:0;z-index:101;background:#fff;padding:10px 0 14px;}
        .send-row{display:flex;gap:10px;align-items:center;}
        .sendbar .field{
            flex:1 1 auto;
            display:flex; align-items:center;
            border:1px solid var(--line); border-radius:12px;
            padding:4px 10px; background:#fff;
            height:46px;
        }
        #msgInput{
            border:none; outline:none; box-shadow:none;
            flex:1 1 auto; padding:6px 8px; height:38px;
        }
        .send-btn{
            width:46px; height:46px; border-radius:12px;
            display:inline-flex; align-items:center; justify-content:center;
            padding:0;
        }
        .send-btn svg{ width:18px; height:18px; }
        .send-btn:disabled{ opacity:.6; cursor:not-allowed; }

        @media (max-width:576px){
            .prod-thumb{width:120px;height:120px;}
            .msg-col{max-width:80%;}
        }
    </style>
</head>
<body>
<div th:replace="~{/layout/header :: header}"></div>

<div class="container py-3 chat-wrap">
    <!-- 상단(상품 표시 카드) -->
    <div class="trade-head d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-3">
            <img class="prod-thumb"
                 th:with="noImg=@{/images/no-image.png}"
                 th:src="${trade != null and !#strings.isEmpty(trade.thumbnail) ? trade.thumbnail : noImg}"
                 alt="상품 썸네일"
                 onerror="this.onerror=null;this.src='/images/no-image.png'">
            <div>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <h5 class="mb-0 title-ellipsis" th:text="${trade != null ? trade.title : '채팅'}">채팅</h5>
                    <span class="badge text-bg-secondary" th:text="${categoryLabel}">카테고리</span>
                    <span id="statusBadge" class="badge" th:classappend="${statusClass}" th:text="${statusLabel}">상태</span>
                    <span class="fw-semibold" th:text="${priceText}">0원</span>
                </div>
                <div class="text-muted small mt-1">
                    참여자: <strong th:text="${sellerName}">판매자</strong> · <strong th:text="${buyerName}">구매자</strong>
                </div>
            </div>
        </div>

        <!-- 우상단: '목록' 아이콘 + (판매자 전용) 상태 변경 컨트롤 -->
        <div class="head-right">
            <!-- 목록 아이콘 (리스트 화면과 동일 스타일/툴팁) -->
            <a class="icon-btn"
               th:href="@{/chat/list}"
               aria-label="나가기"
               data-bs-toggle="tooltip"
               data-bs-placement="left"
               data-bs-title="나가기">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                </svg>
            </a>

            <!-- 판매자 전용 상태 변경 컨트롤 (아이콘 아래, 간격 띄움) -->
            <div class="d-flex align-items-center gap-2" th:if="${me == room.sellerId}">
                <select id="statusSelect" class="form-select form-select-sm" style="width:auto;"
                        th:disabled="${statusLabel} == '판매완료'">
                    <option value="FOR_SALE" th:selected="${statusLabel} == '판매중'">판매중</option>
                    <option value="RESERVED" th:selected="${statusLabel} == '예약중'">예약중</option>
                    <option value="SOLD_OUT" th:selected="${statusLabel} == '판매완료'">판매완료</option>
                </select>
                <button id="btnStatusSave" class="btn btn-sm btn-outline-primary"
                        th:disabled="${statusLabel} == '판매완료'">상태 저장</button>
            </div>
        </div>
    </div>

    <!-- 메시지 -->
    <div id="chatBox" class="chat-box my-3">
        <div th:each="m, st : ${messages}"
             th:with="ts=${#temporals.format(m.regDate, 'yyyy-MM-dd''T''HH:mm:ss')},
              day=${#temporals.format(m.regDate, 'yyyy-MM-dd')},
              time=${#temporals.format(m.regDate, 'HH:mm')}"
             th:class="'msg-row ' + (${m.senderId} == ${me} ? 'me' : 'you')"
             th:attr="data-id=${m.id}, data-ts=${ts}, data-day=${day}">
            <div class="avatar" th:if="${m.senderId} != ${me}" th:text="${#strings.substring(names[m.senderId],0,1)}">닉</div>
            <div class="msg-col">
                <div class="name" th:text="${names[m.senderId]}">닉네임</div>
                <div class="bubbleline">
                    <div class="time-out" th:if="${m.senderId} == ${me}" th:text="${time}">12:00</div>
                    <div class="bubble"><div class="text" th:text="${m.content}">내용</div></div>
                    <div class="time-out" th:if="${m.senderId} != ${me}" th:text="${time}">12:00</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 입력: 버튼을 입력 박스 '밖' 오른쪽에 배치 -->
    <div class="sendbar">
        <div class="send-row">
            <form id="sendForm" class="field">
                <input type="text" id="msgInput" class="form-control" placeholder="메시지를 입력하세요" maxlength="2000">
            </form>

            <button id="sendBtnOutside" class="btn btn-primary send-btn" type="button" aria-label="보내기" title="보내기 (Enter)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16" aria-hidden="true">
                    <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
                </svg>
                <span class="visually-hidden">보내기</span>
            </button>
        </div>
    </div>

    <!-- CSRF -->
    <th:block th:if="${_csrf != null}">
        <input type="hidden" id="csrfName"  th:value="${_csrf.headerName}">
        <input type="hidden" id="csrfToken" th:value="${_csrf.token}">
    </th:block>

    <input type="hidden" id="roomId" th:value="${room.id}">
    <input type="hidden" id="meId"   th:value="${me}">
    <input type="hidden" id="initLastId"
           th:value="${#lists.isEmpty(messages) ? '' : messages.get(messages.size()-1).id}">
</div>

<div th:replace="~{/layout/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 부트스트랩 툴팁 활성화 (
    // 아이콘)
    (function(){
        if (window.bootstrap){
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el=>{
                try{ new bootstrap.Tooltip(el); }catch(e){}
            });
        }
    })();

    (function(){
        const roomId=document.getElementById('roomId').value;
        const me=document.getElementById('meId').value;
        const box=document.getElementById('chatBox');
        const form=document.getElementById('sendForm');
        const input=document.getElementById('msgInput');
        const sendBtn=document.getElementById('sendBtnOutside');
        const hName=document.getElementById('csrfName')?.value;
        const hToken=document.getElementById('csrfToken')?.value;

        // ====== 상태 변경 UI ======
        const sel = document.getElementById('statusSelect');
        const btn = document.getElementById('btnStatusSave');
        const badge = document.getElementById('statusBadge');

        async function saveStatus(){
            if (!sel || !btn) return;
            btn.disabled = true;
            try{
                const headers={'Content-Type':'application/x-www-form-urlencoded'};
                if (hName && hToken) headers[hName]=hToken;
                const body=new URLSearchParams({roomId, status: sel.value}).toString();
                const res=await fetch('/chat/trade/status',{method:'POST',headers,body,credentials:'same-origin'});
                if (res.status===401){ alert('로그인이 필요합니다.'); return; }
                if (res.status===403){ alert('변경 권한이 없습니다. (판매자만 가능)'); return; }
                if (res.status===409){ alert('이미 거래 완료된 글은 상태를 바꿀 수 없습니다.'); return; }
                if (!res.ok){ alert('상태 변경 중 오류가 발생했습니다.'); return; }

                const data = await res.json();
                if (data && data.ok){
                    badge.textContent = data.statusLabel || '상태';
                    badge.className = 'badge ' + (data.statusClass || 'text-bg-secondary');

                    if (data.status === 'SOLD_OUT'){
                        sel.value = 'SOLD_OUT';
                        sel.disabled = true;
                        btn.disabled = true;
                        alert('거래가 완료되었습니다.');
                    }
                }
            }catch(e){ console.error(e); alert('상태 변경 중 오류가 발생했습니다.'); }
            finally{ if (sel && sel.value !== 'SOLD_OUT') btn.disabled=false; }
        }
        btn?.addEventListener('click', saveStatus);

        // ====== 채팅 로직 ======
        let lastId=Number(document.getElementById('initLastId')?.value||'')||null;
        const seenIds=new Set();
        Array.from(box.querySelectorAll('.msg-row')).forEach(r=>{ const id=Number(r.dataset.id); if(!isNaN(id)) seenIds.add(id); });

        let lastDayOnDom=null;
        function scrollBottom(){ box.scrollTop=box.scrollHeight; }
        function formatTime(ts){ if(!ts) return ''; const d=new Date(ts); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
        function dayStr(ts){ return ts?ts.slice(0,10):null; }
        function addDaySeparator(day){ if(!day||lastDayOnDom===day) return; const sep=document.createElement('div'); sep.className='day-sep'; sep.innerHTML=`<span>${day}</span>`; box.appendChild(sep); lastDayOnDom=day; }
        (function initDaySeps(){ const rows=Array.from(box.querySelectorAll('.msg-row')); let prev=null; rows.forEach(r=>{ const d=r.getAttribute('data-day'); if(d&&d!==prev){ const sep=document.createElement('div'); sep.className='day-sep'; sep.innerHTML=`<span>${d}</span>`; box.insertBefore(sep,r); prev=d; lastDayOnDom=d; } }); })();
        function avatarInitial(name){ return (name&&name.trim())?name.trim().charAt(0):'알'; }

        function append(msg){
            if(!msg||msg.id==null) return;
            const mid=Number(msg.id);
            if(seenIds.has(mid)) return;
            seenIds.add(mid);
            if(lastId==null||mid>lastId) lastId=mid;

            const ts=msg.regDate; const day=dayStr(ts); addDaySeparator(day);
            const mine=String(msg.senderId)===String(me);

            const row=document.createElement('div');
            row.className='msg-row '+(mine?'me':'you');
            row.dataset.id=String(mid);
            row.dataset.ts=ts||'';
            row.dataset.day=day||'';

            if(!mine){
                const av=document.createElement('div');
                av.className='avatar';
                av.textContent=avatarInitial(msg.senderName);
                row.appendChild(av);
            }

            const col=document.createElement('div'); col.className='msg-col';
            const name=document.createElement('div'); name.className='name'; name.textContent=msg.senderName||'알수없음';
            col.appendChild(name);

            const line=document.createElement('div'); line.className='bubbleline';
            if(mine){ const t=document.createElement('div'); t.className='time-out'; t.textContent=formatTime(ts); line.appendChild(t); }
            const bubble=document.createElement('div'); bubble.className='bubble';
            const text=document.createElement('div'); text.className='text'; text.textContent=msg.content||'';
            bubble.appendChild(text); line.appendChild(bubble);
            if(!mine){ const t=document.createElement('div'); t.className='time-out'; t.textContent=formatTime(ts); line.appendChild(t); }

            col.appendChild(line); row.appendChild(col); box.appendChild(row);
        }

        // ====== 적응형 폴링 ======
        let delayMs = 2000;
        const MIN_DELAY = 2000, MAX_DELAY = 30000, HIDDEN_DELAY = 45000, BACKOFF = 1.8;
        let controller = null;

        async function pollOnce(){
            try{
                controller?.abort();
                controller = new AbortController();
                const url=new URL('/chat/messages',location.origin);
                url.searchParams.set('roomId',roomId);
                if(lastId!=null) url.searchParams.set('afterId',String(lastId));
                const res=await fetch(url,{credentials:'same-origin', signal: controller.signal});
                if(!res.ok) return false;
                const list=await res.json();
                if(Array.isArray(list)&&list.length){
                    list.forEach(m=>append(m));
                    scrollBottom();
                    return true;
                }
                return false;
            }catch(e){
                if(e.name!=='AbortError'){ console.error(e); }
                return false;
            }
        }
        (async function adaptiveLoop(){
            while(true){
                const got = await pollOnce();
                const base = document.hidden ? HIDDEN_DELAY : MIN_DELAY;
                delayMs = got ? base : Math.min(MAX_DELAY, Math.round(delayMs*BACKOFF));
                if(document.hidden) delayMs = Math.max(delayMs, HIDDEN_DELAY);
                await new Promise(r=>setTimeout(r, delayMs));
            }
        })();

        // ====== 전송 ======
        async function send(e){
            e?.preventDefault?.();
            const content=input.value.trim();
            if(!content) return;

            sendBtn.disabled = true;
            input.disabled = true;

            try{
                const headers={'Content-Type':'application/x-www-form-urlencoded'};
                if(hName&&hToken) headers[hName]=hToken;
                const body=new URLSearchParams({roomId,content}).toString();
                const res=await fetch('/chat/send',{method:'POST',headers,body,credentials:'same-origin'});
                if(res.ok){
                    const m=await res.json();
                    append(m);
                    input.value='';
                    scrollBottom();
                    delayMs = MIN_DELAY; // 새 메시지: 폴링 간격 리셋
                }else if(res.status===401){
                    alert('로그인이 필요합니다.');
                }else if(res.status===403){
                    alert('접근 권한이 없습니다.');
                }
            }catch(err){
                console.error(err);
            }finally{
                input.disabled = false;
                sendBtn.disabled = input.value.trim().length===0;
                input.focus();
            }
        }

        form.addEventListener('submit',send);
        sendBtn.addEventListener('click', send);
        input.addEventListener('input', ()=>{ sendBtn.disabled = input.value.trim().length===0; });
        input.addEventListener('keydown', (e)=>{
            if(e.key==='Enter'){ e.preventDefault(); send(e); }
        });

        // 초기 상태
        sendBtn.disabled = true;
        scrollBottom();
    })();
</script>
</body>
</html>
