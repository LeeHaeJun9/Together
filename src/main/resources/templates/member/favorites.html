<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>찜한 상품 - Together</title>

    <!-- CSRF -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

    <style>
        .favorite-card { transition:.2s; border-left:4px solid #e83e8c; }
        .favorite-card:hover { transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,.1); }
        .product-status { font-size:.8rem; padding:.25rem .5rem; border-radius:15px; }
        .product-thumbnail { width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:8px; }
        .page-header { background:linear-gradient(135deg,#e83e8c 0%,#fd7e14 100%); color:#fff; padding:2rem 0; margin-bottom:2rem; }
        .seller-info { color:#6c757d; font-size:.9rem; }
        .filter-section { background:#f8f9fa; padding:1rem; border-radius:8px; margin-bottom:2rem; }
    </style>
</head>
<body>

<div th:replace="~{/layout/header :: header}"></div>

<div class="page-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-1"><i class="fas fa-heart me-2"></i>찜한 상품</h2>
                <p class="mb-0">관심있는 상품들을 모아보세요</p>
            </div>
            <div class="col-md-4 text-end">
                <a th:href="@{/trade/list}" class="btn btn-light">
                    <i class="fas fa-store"></i> 상품 둘러보기
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">

    <!-- 통계 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <i class="fas fa-heart fa-2x mb-2"></i>
                    <h4 th:text="${totalFavorites} ?: 0">0</h4>
                    <small>총 찜한 상품</small>
                </div>
            </div>
        </div>
        <!-- 필요시 추가 카드들 (availableCount 등) -->
    </div>

    <!-- 목록 -->
    <div class="row" th:if="${favorites != null and !favorites.isEmpty()}">
        <div class="col-md-6 mb-3"
             th:each="favorite : ${favorites}"
             th:with="st=${favorite.trade != null && favorite.trade.status != null ? favorite.trade.status.toString() : ''},
                  cat=${favorite.trade != null && favorite.trade.category != null ? favorite.trade.category.toString() : ''}">
            <div class="card favorite-card">
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-4">
                            <img class="product-thumbnail"
                                 th:src="${ (thumbnails != null and thumbnails.containsKey(favorite.trade.id))
                              ? thumbnails[favorite.trade.id]
                              : (favorite.trade != null && !#strings.isEmpty(favorite.trade.thumbnail) ? favorite.trade.thumbnail : '/images/no-image.png') }"
                                 alt="상품 이미지">
                        </div>
                        <div class="col-8">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0" th:text="${favorite.trade != null ? favorite.trade.title : '상품명'}">상품명</h6>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" th:href="@{|/trade/read/${favorite.trade.id}|}">상세보기</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="#"
                                               th:attr="data-trade-id=${favorite.trade.id}"
                                               onclick="return removeFavorite(this);">찜 해제</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div class="mb-2">
                <span class="badge product-status"
                      th:classappend="${st=='FOR_SALE'} ? ' bg-success' : (${st=='RESERVED'} ? ' bg-warning text-dark' : ' bg-secondary')">
                  <span th:switch="${st}">
                    <span th:case="'FOR_SALE'">판매중</span>
                    <span th:case="'RESERVED'">예약중</span>
                    <span th:case="'SOLD_OUT'">판매완료</span>
                    <span th:case="*">상태없음</span>
                  </span>
                </span>
                                <span class="badge bg-light text-dark ms-1" th:text="${cat != '' ? cat : '카테고리'}">카테고리</span>
                            </div>

                            <div class="seller-info mb-2">
                                <i class="fas fa-user"></i>
                                <span th:text="${favorite.trade != null && !#strings.isEmpty(favorite.trade.sellerNickname) ? favorite.trade.sellerNickname : '판매자'}">판매자</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong class="text-primary fs-5"
                                        th:text="${priceTexts != null and priceTexts.containsKey(favorite.trade.id) ? priceTexts[favorite.trade.id] : '가격문의'}">0원</strong>
                            </div>

                            <div class="mt-2">
                                <a th:href="@{|/trade/read/${favorite.trade.id}|}"
                                   class="btn btn-sm btn-primary"
                                   th:disabled="${st != 'FOR_SALE'}">
                                    <span th:if="${st == 'FOR_SALE'}">구매하기</span>
                                    <span th:if="${st == 'RESERVED'}">예약중</span>
                                    <span th:if="${st == 'SOLD_OUT'}">판매완료</span>
                                </a>
                                <a th:href="@{|/chat/start/${favorite.trade.sellerUserId}|}" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-comment"></i> 문의
                                </a>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /col -->
    </div>

    <!-- 빈 상태 -->
    <div th:if="${favorites == null or favorites.isEmpty()}" class="text-center py-5">
        <i class="fas fa-heart-broken fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">찜한 상품이 없습니다</h5>
        <p class="text-muted">마음에 드는 상품을 찜해보세요!</p>
        <a th:href="@{/trade/list}" class="btn btn-primary mt-2">상품 둘러보기</a>
    </div>

</div>

<div th:replace="~{/layout/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    async function removeFavorite(el) {
        const tradeId = el.getAttribute('data-trade-id');
        if (!tradeId) return false;
        if (!confirm('찜 목록에서 제거하시겠습니까?')) return false;

        const header = document.querySelector('meta[name="_csrf_header"]')?.content;
        const token  = document.querySelector('meta[name="_csrf"]')?.content;
        const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
        if (header && token) headers[header] = token;

        try {
            const res = await fetch('/favorite/toggle', {
                method: 'POST',
                headers,
                body: new URLSearchParams({ tradeId }).toString(),
                credentials: 'same-origin'
            });
            if (res.ok) location.reload();
            else if (res.status === 401) alert('로그인이 필요합니다.');
            else if (res.status === 403) alert('권한이 없습니다(CSRF 실패 가능).');
            else alert('오류가 발생했습니다.');
        } catch (e) {
            console.error(e);
            alert('오류가 발생했습니다.');
        }
        return false;
    }
</script>
</body>
</html>
