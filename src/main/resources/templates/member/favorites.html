<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>찜한 상품 - Together</title>

    <!-- CSRF -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

    <style>
        .page-header{
            background: linear-gradient(135deg, #e83e8c 0%, #ff6b6b 100%);
            color:#fff;
            padding: 2rem 0;
            width: 100%;
            margin: 0 0 2rem;
            border-radius: 0;
            box-shadow: 0 8px 20px rgba(232,62,140,.2);
        }

        .page-header h2{ font-weight: 700; }
        .page-header p{ opacity:.95; }
        .page-header .btn-light{
            background:#fff; border:none; color:#d6336c;
            box-shadow: 0 2px 6px rgba(0,0,0,.08);
        }
        .page-header .btn-light:hover{
            background:#fff; color:#b02a58;
        }

        .favorite-card{
            transition:.2s;
            border-left:4px solid #e83e8c;
            overflow: visible;
            position: relative;
        }

        .favorite-card:hover{ transform:none; box-shadow:0 4px 8px rgba(0,0,0,.1); }

        .favorite-card.clickable{ cursor:pointer; }

        .product-status{font-size:.8rem;padding:.25rem .5rem;border-radius:15px;}
        .product-thumbnail{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px;}
        .seller-info{color:#6c757d;font-size:.9rem;}
        .stats-row{margin-bottom:2.5rem;}
        .favorite-list{margin-top:.25rem;}
        .stat-link{text-decoration:none;}
        .stat-link .card{transition:.2s;}
        .stat-link .card:hover{transform:none;box-shadow:0 6px 14px rgba(0,0,0,.12);}
        .pos-rel{position:relative;}

        .soldout-overlay{position:absolute; inset:0; background:rgba(108,117,125,.35); border-radius:.375rem; display:flex; align-items:center; justify-content:center; pointer-events:none;}
        .soldout-badge{background:rgba(33,37,41,.75); color:#fff; padding:.35rem .7rem; border-radius:999px; font-weight:700; font-size:.95rem;}

        .icon-btn{
            display:inline-flex; align-items:center; justify-content:center;
            width:36px; height:36px; border-radius:10px;
            border:1px solid #ffe3ee; background:#fff; color:#e03131;
            transition:.15s;
        }
        .icon-btn:hover{ background:#fff5f8; border-color:#ffc4da; }
        .icon-btn i{ font-size:16px; line-height:1; }
        .icon-btn.heart{ color:#e03131; }
    </style>
</head>
<body>

<div th:replace="~{/layout/header :: header}"></div>

<div class="page-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-1">
                    <i class="fas fa-heart me-2"></i>찜한 상품
                </h2>
                <p class="mb-0">관심있는 상품들을 모아보세요</p>
            </div>
            <div class="col-md-4 text-end">
                <a th:href="@{/trade/list}" class="btn btn-light">
                    <i class="fas fa-store"></i> 상품 둘러보기
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">

    <div class="row g-3 stats-row">
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <i class="fas fa-heart fa-2x mb-2"></i>
                    <h4 th:text="${totalFavorites} ?: 0">0</h4>
                    <small>총 찜한 상품</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <a th:href="@{/trade/sold}" class="stat-link">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-bag-shopping fa-2x mb-2"></i>
                        <h4 th:text="${soldCount} ?: 0">0</h4>
                        <small>판매한 상품</small>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-3">
            <a th:href="@{/trade/bought}" class="stat-link">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-cart-shopping fa-2x mb-2"></i>
                        <h4 th:text="${boughtCount} ?: 0">0</h4>
                        <small>구매한 상품</small>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-3">
            <a th:href="@{/chat/list}" class="stat-link">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-comments fa-2x mb-2"></i>
                        <h4 th:text="${chatCount} ?: 0">0</h4>
                        <small>내 채팅방</small>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="row g-4 favorite-list" th:if="${items != null and !items.isEmpty()}">
        <div class="col-md-6"
             th:each="it : ${items}"
             th:with="st=${it.status != null ? it.status.toString() : ''},
                      isSold=${st == 'SOLD_OUT'},
                      cat=${it.category != null ? it.category.toString() : ''}">
            <div class="card favorite-card pos-rel clickable"
                 th:attr="data-href=${!isSold}? @{|/trade/read/${it.tradeId}|} : null,
                          data-sold=${isSold}">
                <div class="soldout-overlay" th:if="${isSold}">
                    <span class="soldout-badge">거래 완료</span>
                </div>

                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-4">
                            <img class="product-thumbnail"
                                 th:src="${ (thumbnails != null and thumbnails.containsKey(it.tradeId))
                                           ? thumbnails[it.tradeId]
                                           : '/images/no-image.png' }"
                                 alt="상품 이미지"
                                 onerror="this.onerror=null;this.src='/images/no-image.png'">
                        </div>
                        <div class="col-8">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0" th:text="${it.title}">상품명</h6>

                                <button class="icon-btn heart"
                                        title="찜 해제"
                                        aria-label="찜 해제"
                                        th:attr="data-trade-id=${it.tradeId}"
                                        onclick="return removeFavorite(this, event);">
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>

                            <div class="mb-2">
                                <span class="badge product-status"
                                      th:classappend="${st=='FOR_SALE'} ? ' bg-success' : (${st=='RESERVED'} ? ' bg-warning text-dark' : ' bg-secondary')">
                                  <span th:switch="${st}">
                                    <span th:case="'FOR_SALE'">판매중</span>
                                    <span th:case="'RESERVED'">예약중</span>
                                    <span th:case="'SOLD_OUT'">판매완료</span>
                                    <span th:case="*">상태없음</span>
                                  </span>
                                </span>
                                <span class="badge bg-light text-dark ms-1"
                                      th:text="${cat != '' ? cat : '카테고리'}">카테고리</span>
                            </div>

                            <div class="seller-info mb-2">
                                <i class="fas fa-user"></i>
                                <span th:text="${it.sellerNickname != null ? it.sellerNickname : '판매자'}">판매자</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <strong class="text-primary fs-5"
                                        th:text="${priceTexts != null and priceTexts.containsKey(it.tradeId) ? priceTexts[it.tradeId] : '가격문의'}">0원</strong>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:if="${items == null or items.isEmpty()}" class="text-center py-5 mt-4">
        <i class="fas fa-heart-broken fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">찜한 상품이 없습니다</h5>
        <p class="text-muted">마음에 드는 상품을 찜해보세요!</p>
        <a th:href="@{/trade/list}" class="btn btn-primary mt-2">상품 둘러보기</a>
    </div>

</div>

<div th:replace="~{/layout/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    (function(){
        document.querySelectorAll('.favorite-card.clickable').forEach(function(card){
            card.addEventListener('click', function(e){
                if (e.defaultPrevented) return; // 하트 버튼이 stopPropagation한 경우
                const isSold = card.getAttribute('data-sold') === 'true';
                if (isSold) { alert('이미 거래가 된 상품입니다'); return; }
                const href = card.getAttribute('data-href');
                if (href) { window.location.href = href; }
            });
        });
    })();

    async function removeFavorite(el, evt){
        if (evt) evt.stopPropagation(); // 카드 클릭으로 인한 이동 방지

        const tradeId = el.getAttribute('data-trade-id');
        if(!tradeId) return false;
        if(!confirm('찜 목록에서 제거하시겠습니까?')) return false;

        const header = document.querySelector('meta[name="_csrf_header"]')?.content;
        const token  = document.querySelector('meta[name="_csrf"]')?.content;
        const headers = {'Content-Type':'application/x-www-form-urlencoded'};
        if(header && token) headers[header] = token;

        try{
            const res = await fetch('/favorite/toggle', {
                method:'POST', headers,
                body:new URLSearchParams({tradeId}).toString(),
                credentials:'same-origin'
            });
            if(res.ok){ location.reload(); }
            else if(res.status === 401){ alert('로그인이 필요합니다.'); }
            else if(res.status === 403){ alert('권한이 없습니다(CSRF 실패 가능).'); }
            else{ alert('오류가 발생했습니다.'); }
        }catch(e){
            console.error(e); alert('오류가 발생했습니다.');
        }
        return false;
    }
</script>
</body>
</html>
