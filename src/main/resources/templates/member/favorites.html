<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>찜한 상품 - Together</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .favorite-card {
            transition: transform 0.2s;
            border-left: 4px solid #e83e8c;
        }
        .favorite-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .product-status {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
        }
        .product-thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }
        .page-header {
            background: linear-gradient(135deg, #e83e8c 0%, #fd7e14 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .seller-info {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .favorite-date {
            color: #6c757d;
            font-size: 0.8rem;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
<!-- Header -->
<div class="page-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2><i class="fas fa-heart me-2"></i>찜한 상품</h2>
                <p class="mb-0">관심있는 상품들을 모아보세요</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="/trade/search" class="btn btn-light">
                    <i class="fas fa-search"></i> 상품 찾기
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Filter Section -->
    <div class="filter-section">
        <div class="row align-items-center">
            <div class="col-md-6">
                <select class="form-select" id="categoryFilter">
                    <option value="">모든 카테고리</option>
                    <option value="ELECTRONICS">전자제품</option>
                    <option value="FASHION">패션/의류</option>
                    <option value="BOOKS">도서/교육</option>
                </select>
            </div>
            <div class="col-md-6">
                <select class="form-select" id="sortFilter">
                    <option value="recent">최근 찜한 순</option>
                    <option value="price_low">가격 낮은 순</option>
                    <option value="price_high">가격 높은 순</option>
                    <option value="name">상품명 순</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Favorites Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <i class="fas fa-heart fa-2x mb-2"></i>
                    <h4 th:text="${totalFavorites ?: 0}">0</h4>
                    <small>총 찜한 상품</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                    <h4 th:text="${availableCount ?: 0}">0</h4>
                    <small>판매 중</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-times-circle fa-2x mb-2"></i>
                    <h4 th:text="${soldOutCount ?: 0}">0</h4>
                    <small>판매 완료</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h4 th:text="${recentCount ?: 0}">0</h4>
                    <small>최근 7일</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Favorites List -->
    <div class="row" th:if="${favorites != null and !favorites.isEmpty()}">
        <div class="col-md-6 mb-3" th:each="favorite : ${favorites}">
            <div class="card favorite-card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-4">
                            <img th:src="${favorite.trade.thumbnail ?: '/images/no-image.png'}"
                                 alt="상품 이미지" class="product-thumbnail">
                        </div>
                        <div class="col-8">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0" th:text="${favorite.trade.title}">상품명</h6>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" th:href="|/trade/${favorite.trade.id}|">상세보기</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" th:onclick="|removeFavorite(${favorite.id})|">찜 해제</a></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="mb-2">
                                <span class="badge product-status"
                                      th:class="${favorite.trade.tradeStatus == 'FOR_SALE' ? 'bg-success' :
                                                   favorite.trade.tradeStatus == 'RESERVED' ? 'bg-warning' : 'bg-secondary'}"
                                      th:text="${favorite.trade.tradeStatus == 'FOR_SALE' ? '판매중' :
                                                   favorite.trade.tradeStatus == 'RESERVED' ? '예약중' : '판매완료'}">
                                    판매중
                                </span>
                                <span class="badge bg-light text-dark ms-1"
                                      th:text="${favorite.trade.tradeCategory == 'ELECTRONICS' ? '전자제품' :
                                                   favorite.trade.tradeCategory == 'FASHION' ? '패션/의류' : '도서/교육'}">
                                    카테고리
                                </span>
                            </div>

                            <div class="seller-info mb-2">
                                <i class="fas fa-user"></i>
                                <span th:text="${favorite.trade.seller.nickname}">판매자</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong class="text-primary fs-5" th:text="|${#numbers.formatInteger(favorite.trade.price, 0, 'COMMA')}원|">가격</strong>
                                <small class="favorite-date" th:text="${#temporals.format(favorite.regDate, 'MM-dd 찜')}">찜한 날짜</small>
                            </div>

                            <div class="mt-2">
                                <a th:href="|/trade/${favorite.trade.id}|"
                                   class="btn btn-sm btn-primary"
                                   th:disabled="${favorite.trade.tradeStatus != 'FOR_SALE'}">
                                    <span th:if="${favorite.trade.tradeStatus == 'FOR_SALE'}">구매하기</span>
                                    <span th:if="${favorite.trade.tradeStatus == 'RESERVED'}">예약중</span>
                                    <span th:if="${favorite.trade.tradeStatus == 'COMPLETED'}">판매완료</span>
                                </a>
                                <button class="btn btn-sm btn-outline-secondary" th:onclick="|contactSeller(${favorite.trade.seller.id})|">
                                    <i class="fas fa-comment"></i> 문의
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div th:if="${favorites == null or favorites.isEmpty()}" class="text-center py-5">
        <i class="fas fa-heart-broken fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">찜한 상품이 없습니다</h5>
        <p class="text-muted">마음에 드는 상품을 찜해보세요!</p>
        <a href="/trade/search" class="btn btn-primary mt-2">상품 둘러보기</a>
    </div>

    <!-- Pagination -->
    <nav th:if="${totalPages > 1}" aria-label="Favorites pagination">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:class="${currentPage == 0} ? 'disabled'">
                <a class="page-link" th:href="@{/member/favorites(page=${currentPage - 1})}">이전</a>
            </li>
            <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                th:class="${i == currentPage} ? 'active'">
                <a class="page-link" th:href="@{/member/favorites(page=${i})}" th:text="${i + 1}">1</a>
            </li>
            <li class="page-item" th:class="${currentPage == totalPages - 1} ? 'disabled'">
                <a class="page-link" th:href="@{/member/favorites(page=${currentPage + 1})}">다음</a>
            </li>
        </ul>
    </nav>

    <!-- Back to MyPage -->
    <div class="text-center mt-4">
        <a href="/mypage" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> 마이페이지로 돌아가기
        </a>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function removeFavorite(favoriteId) {
        if (confirm('찜 목록에서 제거하시겠습니까?')) {
            fetch(`/api/favorites/${favoriteId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    if (response.ok) {
                        alert('찜 목록에서 제거되었습니다.');
                        location.reload();
                    } else {
                        alert('오류가 발생했습니다.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('오류가 발생했습니다.');
                });
        }
    }

    function contactSeller(sellerId) {
        // 판매자와 채팅 시작 또는 연락처 표시
        window.location.href = `/chat/start/${sellerId}`;
    }

    // 필터 기능
    document.getElementById('categoryFilter').addEventListener('change', function() {
        applyFilters();
    });

    document.getElementById('sortFilter').addEventListener('change', function() {
        applyFilters();
    });

    function applyFilters() {
        const category = document.getElementById('categoryFilter').value;
        const sort = document.getElementById('sortFilter').value;

        const params = new URLSearchParams();
        if (category) params.append('category', category);
        if (sort) params.append('sort', sort);

        window.location.href = `/member/favorites?${params.toString()}`;
    }
</script>
</body>
</html>