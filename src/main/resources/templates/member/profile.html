<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="모여라 프로필 관리" />
    <meta name="author" content="" />
    <meta name="_csrf" content="v0LXQo1EKECrn3svnXM6tedPEQtSTpFpOFAnc4T9HyZaNSc92nrgJOglTiGG-UsarF4O0N9_PGljePBECmMWR-XNfRI5VhMJ"/>
    <meta name="_csrf_header" content="X-XSRF-TOKEN"/>
    <title>모여라 - 프로필 관리</title>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Custom CSS -->
    <style>
        .profile-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .profile-header {
            background-color: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .profile-photo {
            width: 80px;
            height: 80px;
            background-color: #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
            margin-right: 20px;
        }

        .profile-info h5 {
            margin: 0;
            font-weight: bold;
            color: #333;
        }

        .profile-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-profile {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 5px;
        }

        .profile-form-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .form-control {
            border-radius: 5px;
            border: 1px solid #ced4da;
            padding: 12px;
        }

        .form-control:disabled {
            background-color: #f8f9fa;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group .form-control {
            flex: 1;
        }

        .btn-change, .btn-save, .btn-cancel, .check-button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
        }

        .btn-change {
            background-color: #6c757d;
            color: white;
        }

        .btn-change:hover {
            background-color: #5a6268;
        }

        .btn-save {
            background-color: #28a745;
            color: white;
        }

        .btn-save:hover {
            background-color: #218838;
        }

        .btn-cancel {
            background-color: #dc3545;
            color: white;
        }

        .btn-cancel:hover {
            background-color: #c82333;
        }

        .check-button {
            background: #4CAF50;
            color: white;
        }

        .check-button:hover {
            background: #45a049;
        }

        .password-section {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .hidden {
            display: none;
        }

        /* register.html과 동일한 메시지 스타일 */
        .message {
            font-size: 12px;
            margin-top: 5px;
        }

        .error-message {
            color: #ff6b6b;
        }

        .success-message {
            color: #51cf66;
        }

        .input-success {
            border: 2px solid #51cf66 !important;
            background-color: #f0fff4;
        }

        .input-error {
            border: 2px solid #ff6b6b !important;
            background-color: #fff5f5;
        }

        /* 임시 비밀번호 모달 스타일 */
        .temp-password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .temp-password-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .temp-password-title {
            font-size: 20px;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 20px;
        }

        .temp-password-display {
            background-color: #f8f9fa;
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 8px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 20px 0;
            letter-spacing: 2px;
        }

        .temp-password-info {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .btn-copy {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        .btn-copy:hover {
            background-color: #138496;
        }

        .btn-close-modal {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-close-modal:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
<!-- 헤더 -->
<header class="container px-4 px-lg-5">
    <link rel="stylesheet" href="/css/header.css">
    <div class="header-top">
        <a href="/mainPage" class="logo-section">
            <img src="/images/moyeora-logo.png" alt="Together 로고" />
            <span>모여라</span>
        </a>
        <nav>
            <ul class="nav-links">
                <li class="nav-link"><a href="/member/mypage">마이페이지</a></li>
                <li class="nav-link"><a href="/logout">로그아웃</a></li>
                <li class="nav-link"><a href="/manager">관리자페이지</a></li>
                <li class="nav-link"><a href="/cafe/admin/applications">카페 가입 승인</a></li>
            </ul>
        </nav>
    </div>
</header>

<!-- 프로필 관리 메인 -->
<div class="container">
    <div class="profile-container">
        <!-- 알림 메시지 -->
        <div id="alertContainer"></div>

        <!-- 프로필 헤더 -->
        <div class="profile-header">
            <div class="row align-items-center">
                <div class="col-auto">
                    <div class="profile-photo" onclick="document.getElementById('photoInput').click();" style="cursor: pointer;">
                        <span>프로필<br>사진</span>
                    </div>
                    <input type="file" id="photoInput" name="photo" accept="image/*" style="display: none;">
                </div>
                <div class="col">
                    <div class="profile-info">
                        <h5></h5>
                        <small class="text-muted">아이디: </small>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="profile-buttons">
                        <button class="btn btn-secondary btn-profile" onclick="document.getElementById('photoInput').click();">이미지 변경</button>
                        <a href="/member/deleteUser" class="btn btn-danger btn-profile">회원 탈퇴</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 기본 정보 수정 폼 -->
        <div class="profile-form-section">
            <div class="form-section-title">기본 정보</div>

            <form id="profileForm">
                <!-- 닉네임 -->
                <div class="form-group">
                    <label class="form-label">닉네임</label>
                    <div class="input-group">
                        <input type="text" id="nickname" class="form-control"
                               value="" placeholder="닉네임을 입력하세요" disabled>
                        <button type="button" class="btn-change" onclick="enableEdit('nickname')">변경하기</button>
                        <button type="button" class="check-button hidden" id="checkNicknameBtn" onclick="checkNicknameDuplicate()">중복확인</button>
                        <button type="button" class="btn-save hidden" onclick="saveField('nickname')" id="saveNicknameBtn" disabled>저장</button>
                        <button type="button" class="btn-cancel hidden" onclick="cancelEdit('nickname')">취소</button>
                    </div>
                    <div id="nicknameMessage" class="message"></div>
                </div>

                <!-- 이름 -->
                <div class="form-group">
                    <label class="form-label">이름</label>
                    <div class="input-group">
                        <input type="text" id="name" class="form-control"
                               value="" placeholder="이름을 입력하세요" disabled>
                        <button type="button" class="btn-change" onclick="enableEdit('name')">변경하기</button>
                        <button type="button" class="check-button hidden" id="checkNameBtn" onclick="checkNameDuplicate()">중복확인</button>
                        <button type="button" class="btn-save hidden" onclick="saveField('name')" id="saveNameBtn" disabled>저장</button>
                        <button type="button" class="btn-cancel hidden" onclick="cancelEdit('name')">취소</button>
                    </div>
                    <div id="nameMessage" class="message"></div>
                </div>

                <!-- 이메일 -->
                <div class="form-group">
                    <label class="form-label">이메일</label>
                    <div class="input-group">
                        <input type="email" id="email" class="form-control"
                               value="test@example.com" placeholder="이메일을 입력하세요" disabled>
                        <button type="button" class="btn-change" onclick="enableEdit('email')">변경하기</button>
                        <button type="button" class="check-button hidden" id="checkEmailBtn" onclick="checkEmailDuplicate()">중복확인</button>
                        <button type="button" class="btn-save hidden" onclick="saveField('email')" id="saveEmailBtn" disabled>저장</button>
                        <button type="button" class="btn-cancel hidden" onclick="cancelEdit('email')">취소</button>
                    </div>
                    <div id="emailMessage" class="message"></div>
                </div>

                <!-- 전화번호 -->
                <div class="form-group">
                    <label class="form-label">전화번호</label>
                    <div class="input-group">
                        <input type="tel" id="phone" class="form-control"
                               value="010-1234-5678" placeholder="전화번호를 입력하세요" disabled>
                        <button type="button" class="btn-change" onclick="enableEdit('phone')">변경하기</button>
                        <button type="button" class="check-button hidden" id="checkPhoneBtn" onclick="checkPhoneDuplicate()">중복확인</button>
                        <button type="button" class="btn-save hidden" onclick="saveField('phone')" id="savePhoneBtn" disabled>저장</button>
                        <button type="button" class="btn-cancel hidden" onclick="cancelEdit('phone')">취소</button>
                    </div>
                    <div id="phoneMessage" class="message"></div>
                </div>
            </form>
        </div>

        <!-- 비밀번호 변경 섹션 -->
        <div class="password-section">
            <div class="form-section-title">비밀번호 변경</div>

            <form id="passwordForm">
                <!-- 현재 비밀번호 -->
                <div class="form-group">
                    <label class="form-label">현재 비밀번호</label>
                    <input type="password" id="currentPassword" class="form-control"
                           placeholder="현재 비밀번호를 입력하세요" required>
                </div>

                <!-- 새 비밀번호 -->
                <div class="form-group">
                    <label class="form-label">새 비밀번호</label>
                    <input type="password" id="newPassword" class="form-control"
                           placeholder="새 비밀번호를 입력하세요 (8자 이상)" required>
                </div>

                <!-- 새 비밀번호 확인 -->
                <div class="form-group">
                    <label class="form-label">새 비밀번호 확인</label>
                    <input type="password" id="confirmPassword" class="form-control"
                           placeholder="새 비밀번호를 다시 입력하세요" required>
                </div>

                <button type="submit" class="btn btn-primary">비밀번호 변경</button>
            </form>
        </div>
    </div>
</div>

<!-- 임시 비밀번호 모달창 -->
<div id="tempPasswordModal" class="temp-password-modal">
    <div class="temp-password-content">
        <div class="temp-password-title">✅ 임시 비밀번호 발급 완료</div>
        <div class="temp-password-display" id="tempPasswordDisplay">temp1234</div>
        <div class="temp-password-info">
            위 임시 비밀번호를 복사하여 로그인하세요.<br>
            로그인 후 새로운 비밀번호로 변경해주세요.
        </div>
        <div>
            <button class="btn-copy" onclick="copyTempPassword()">비밀번호 복사</button>
            <button class="btn-close-modal" onclick="closeTempPasswordModal()">확인</button>
        </div>
    </div>
</div>

<footer class="footer">
    <link rel="stylesheet" href="/css/footer.css">
    <div class="container">
        <ul class="footer-links">
            <li><a href="#">회사소개</a></li>
            <li><a href="#">이용약관</a></li>
            <li><a href="#">개인정보처리방침</a></li>
            <li><a href="#">고객센터</a></li>
        </ul>
        <div class="footer-bottom">
            <p>&copy; 2025 Together. All rights reserved.</p>
        </div>
    </div>
</footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- 프로필 관리 JavaScript -->
<script>
    // CSRF 토큰 변수 정의
    const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    let originalValues = {}; // 원본 값 저장

    // 중복확인 상태 변수 (register.html에서 가져온 로직)
    let isNicknameValid = false;
    let isNameValid = false;
    let isEmailValid = false;
    let isPhoneValid = false;

    // 알림 메시지 표시 함수
    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.innerHTML = message;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alertDiv);
    }

    // 필드별 검증 상태 초기화
    function resetFieldValidation(fieldId) {
        const messageElement = document.getElementById(`${fieldId}Message`);
        const inputElement = document.getElementById(fieldId);

        if (messageElement) messageElement.textContent = '';
        if (inputElement) inputElement.className = 'form-control';

        // 각 필드의 유효성 상태 초기화
        switch(fieldId) {
            case 'nickname': isNicknameValid = false; break;
            case 'name': isNameValid = false; break;
            case 'email': isEmailValid = false; break;
            case 'phone': isPhoneValid = false; break;
        }
    }

    // 필드 수정 모드 활성화
    function enableEdit(fieldId) {
        const field = document.getElementById(fieldId);
        const container = field.parentElement;

        // 원본 값 저장
        originalValues[fieldId] = field.value;

        // 입력 필드 활성화
        field.disabled = false;
        field.focus();

        // 기본 버튼 전환
        container.querySelector('.btn-change').classList.add('hidden');
        container.querySelector('.btn-save').classList.remove('hidden');
        container.querySelector('.btn-cancel').classList.remove('hidden');

        // 중복확인 버튼 표시
        const checkBtn = container.querySelector('.check-button');
        if (checkBtn) {
            checkBtn.classList.remove('hidden');
        }

        // 저장 버튼 비활성화 (중복확인 후 활성화)
        const saveBtn = container.querySelector('.btn-save');
        if (saveBtn) {
            saveBtn.disabled = true;
        }

        // 해당 필드의 검증 상태 초기화
        resetFieldValidation(fieldId);
    }

    // 수정 취소
    function cancelEdit(fieldId) {
        const field = document.getElementById(fieldId);
        const container = field.parentElement;

        // 원본 값 복원
        field.value = originalValues[fieldId] || '';
        field.disabled = true;

        // 버튼 전환
        container.querySelector('.btn-change').classList.remove('hidden');
        container.querySelector('.btn-save').classList.add('hidden');
        container.querySelector('.btn-cancel').classList.add('hidden');

        // 중복확인 버튼 숨기기
        const checkBtn = container.querySelector('.check-button');
        if (checkBtn) {
            checkBtn.classList.add('hidden');
        }

        // 메시지 및 스타일 초기화
        resetFieldValidation(fieldId);
    }

    // 닉네임 중복 체크 함수
    async function checkNicknameDuplicate() {
        const nickname = document.getElementById('nickname').value.trim();
        const messageElement = document.getElementById('nicknameMessage');
        const inputElement = document.getElementById('nickname');
        const saveBtn = document.getElementById('saveNicknameBtn');
        const currentNickname = originalValues['nickname'];

        if (!nickname) {
            messageElement.textContent = '닉네임을 입력해주세요.';
            messageElement.className = 'message error-message';
            inputElement.className = 'form-control input-error';
            isNicknameValid = false;
            saveBtn.disabled = true;
            return;
        }

        if (nickname === currentNickname) {
            messageElement.textContent = '현재 사용중인 닉네임입니다.';
            messageElement.className = 'message success-message';
            inputElement.className = 'form-control input-success';
            isNicknameValid = true;
            saveBtn.disabled = false;
            return;
        }

        try {
            const response = await fetch(`/api/member/check-nickname?nickname=${encodeURIComponent(nickname)}`);
            const data = await response.json();

            if (data.success) {
                if (data.isDuplicate) {
                    messageElement.textContent = '이미 사용중인 닉네임입니다.';
                    messageElement.className = 'message error-message';
                    inputElement.className = 'form-control input-error';
                    isNicknameValid = false;
                    saveBtn.disabled = true;
                } else {
                    messageElement.textContent = '사용 가능한 닉네임입니다.';
                    messageElement.className = 'message success-message';
                    inputElement.className = 'form-control input-success';
                    isNicknameValid = true;
                    saveBtn.disabled = false;
                }
            } else {
                messageElement.textContent = '닉네임 확인 중 오류가 발생했습니다.';
                messageElement.className = 'message error-message';
                inputElement.className = 'form-control input-error';
                isNicknameValid = false;
                saveBtn.disabled = true;
            }
        } catch (error) {
            console.error('닉네임 중복 체크 오류:', error);
            messageElement.textContent = '네트워크 오류가 발생했습니다.';
            messageElement.className = 'message error-message';
            inputElement.className = 'form-control input-error';
            isNicknameValid = false;
            saveBtn.disabled = true;
        }
    }

    // 이름 중복 체크 함수
    async function checkNameDuplicate() {
        const name = document.getElementById('name').value.trim();
        const messageElement = document.getElementById('nameMessage');
        const inputElement = document.getElementById('name');
        const saveBtn = document.getElementById('saveNameBtn');
        const currentName = originalValues['name'];

        if (!name) {
            messageElement.textContent = '이름을 입력해주세요.';
            messageElement.className = 'message error-message';
            inputElement.className = 'form-control input-error';
            isNameValid = false;
            saveBtn.disabled = true;
            return;
        }

        if (name === currentName) {
            messageElement.textContent = '현재 사용중인 이름입니다.';
            messageElement.className = 'message success-message';
            inputElement.className = 'form-control input-success';
            isNameValid = true;
            saveBtn.disabled = false;
            return;
        }

        try {
            const response = await fetch(`/api/member/check-name?name=${encodeURIComponent(name)}`);
            const data = await response.json();

            if (data.success) {
                if (data.isDuplicate) {
                    messageElement.textContent = '이미 사용중인 이름입니다.';
                    messageElement.className = 'message error-message';
                    inputElement.className = 'form-control input-error';
                    isNameValid = false;
                    saveBtn.disabled = true;
                } else {
                    messageElement.textContent = '사용 가능한 이름입니다.';
                    messageElement.className = 'message success-message';
                    inputElement.className = 'form-control input-success';
                    isNameValid = true;
                    saveBtn.disabled = false;
                }
            } else {
                messageElement.textContent = '이름 확인 중 오류가 발생했습니다.';
                messageElement.className = 'message error-message';
                inputElement.className = 'form-control input-error';
                isNameValid = false;
                saveBtn.disabled = true;
            }
        } catch (error) {
            console.error('이름 중복 체크 오류:', error);
            messageElement.textContent = '네트워크 오류가 발생했습니다.';
            messageElement.className = 'message error-message';
            inputElement.className = 'form-control input-error';
            isNameValid = false;
            saveBtn.disabled = true;
        }
    }

    // 이메일 중복 체크 함수
    async function checkEmailDuplicate() {
        const email = document.getElementById('email').value.trim();
        const messageElement = document.getElementById('emailMessage');
        const inputElement = document.getElementById('email');
        const saveBtn = document.getElementById('saveEmailBtn');
        const currentEmail = originalValues['email'];

        if (!email) {
            messageElement.textContent = '이메일을 입력해주세요.';
            messageElement.className = 'message error-message';
            inputElement.className = 'form-control input-error';
            isEmailValid = false;
            saveBtn.disabled = true;
            return;
        }

        if (email === currentEmail) {
            messageElement.textContent = '현재 사용중인 이메일입니다.';
            messageElement.className = 'message success-message';
            inputElement.className = 'form-control input-success';
            isEmailValid = true;
            saveBtn.disabled = false;
            return;
        }

        try {
            const response = await fetch(`/api/member/check-email?email=${encodeURIComponent(email)}`);
            const data = await response.json();

            if (data.success) {
                if (data.isDuplicate) {
                    messageElement.textContent = '이미 사용중인 이메일입니다.';
                    messageElement.className = 'message error-message';
                    inputElement.className = 'form-control input-error';
                    isEmailValid = false;
                    saveBtn.disabled = true;
                } else {
                    messageElement.textContent = '사용 가능한 이메일입니다.';
                    messageElement.className = 'message success-message';
                    inputElement.className = 'form-control input-success';
                    isEmailValid = true;
                    saveBtn.disabled = false;
                }
            } else {
                messageElement.textContent = '이메일 확인 중 오류가 발생했습니다.';
                messageElement.className = 'message error-message';
                inputElement.className = 'form-control input-error';
                isEmailValid = false;
                saveBtn.disabled = true;
            }
        } catch (error) {
            console.error('이메일 중복 체크 오류:', error);
            messageElement.textContent = '네트워크 오류가 발생했습니다.';
            messageElement.className = 'message error-message';
            inputElement.className = 'form-control input-error';
            isEmailValid = false;
            saveBtn.disabled = true;
        }
    }

    // 전화번호 중복 체크 함수
    async function checkPhoneDuplicate() {
        const phone = document.getElementById('phone').value.trim();
        const messageElement = document.getElementById('phoneMessage');
        const inputElement = document.getElementById('phone');
        const saveBtn = document.getElementById('savePhoneBtn');
        const currentPhone = originalValues['phone'];

        if (!phone) {
            messageElement.textContent = '전화번호를 입력해주세요.';
            messageElement.className = 'message error-message';
            inputElement.className = 'form-control input-error';
            isPhoneValid = false;
            saveBtn.disabled = true;
            return;
        }

        if (phone === currentPhone) {
            messageElement.textContent = '현재 사용중인 전화번호입니다.';
            messageElement.className = 'message success-message';
            inputElement.className = 'form-control input-success';
            isPhoneValid = true;
            saveBtn.disabled = false;
            return;
        }

        try {
            const response = await fetch(`/api/member/check-phone?phone=${encodeURIComponent(phone)}`);
            const data = await response.json();

            if (data.success) {
                if (data.isDuplicate) {
                    messageElement.textContent = '이미 사용중인 전화번호입니다.';
                    messageElement.className = 'message error-message';
                    inputElement.className = 'form-control input-error';
                    isPhoneValid = false;
                    saveBtn.disabled = true;
                } else {
                    messageElement.textContent = '사용 가능한 전화번호입니다.';
                    messageElement.className = 'message success-message';
                    inputElement.className = 'form-control input-success';
                    isPhoneValid = true;
                    saveBtn.disabled = false;
                }
            } else {
                messageElement.textContent = '전화번호 확인 중 오류가 발생했습니다.';
                messageElement.className = 'message error-message';
                inputElement.className = 'form-control input-error';
                isPhoneValid = false;
                saveBtn.disabled = true;
            }
        } catch (error) {
            console.error('전화번호 중복 체크 오류:', error);
            messageElement.textContent = '네트워크 오류가 발생했습니다.';
            messageElement.className = 'message error-message';
            inputElement.className = 'form-control input-error';
            isPhoneValid = false;
            saveBtn.disabled = true;
        }
    }

    // 입력 필드가 변경될 때 검증 상태 초기화 (register.html에서 가져온 로직)
    document.getElementById('nickname').addEventListener('input', function() {
        const messageElement = document.getElementById('nicknameMessage');
        const inputElement = document.getElementById('nickname');
        const saveBtn = document.getElementById('saveNicknameBtn');
        messageElement.textContent = '';
        inputElement.className = 'form-control';
        isNicknameValid = false;
        saveBtn.disabled = true;
    });

    document.getElementById('name').addEventListener('input', function() {
        const messageElement = document.getElementById('nameMessage');
        const inputElement = document.getElementById('name');
        const saveBtn = document.getElementById('saveNameBtn');
        messageElement.textContent = '';
        inputElement.className = 'form-control';
        isNameValid = false;
        saveBtn.disabled = true;
    });

    document.getElementById('email').addEventListener('input', function() {
        const messageElement = document.getElementById('emailMessage');
        const inputElement = document.getElementById('email');
        const saveBtn = document.getElementById('saveEmailBtn');
        messageElement.textContent = '';
        inputElement.className = 'form-control';
        isEmailValid = false;
        saveBtn.disabled = true;
    });

    document.getElementById('phone').addEventListener('input', function() {
        const messageElement = document.getElementById('phoneMessage');
        const inputElement = document.getElementById('phone');
        const saveBtn = document.getElementById('savePhoneBtn');
        messageElement.textContent = '';
        inputElement.className = 'form-control';
        isPhoneValid = false;
        saveBtn.disabled = true;
    });

    // 필드 저장
    function saveField(fieldId) {
        const field = document.getElementById(fieldId);
        const value = field.value.trim();

        if (!value) {
            showAlert('필드를 비워둘 수 없습니다.', 'danger');
            return;
        }

        let isValid = false;
        let fieldLabel = '';
        switch(fieldId) {
            case 'nickname': isValid = isNicknameValid; fieldLabel = '닉네임'; break;
            case 'name': isValid = isNameValid; fieldLabel = '이름'; break;
            case 'email': isValid = isEmailValid; fieldLabel = '이메일'; break;
            case 'phone': isValid = isPhoneValid; fieldLabel = '전화번호'; break;
        }

        if (!isValid) {
            showAlert(`${fieldLabel} 중복확인을 먼저 해주세요.`, 'danger');
            return;
        }

        // AJAX 요청으로 서버에 업데이트
        fetch('/member/profile/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [header]: token
            },
            body: JSON.stringify({
                field: fieldId,
                value: value
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');

                    // 필드 비활성화
                    field.disabled = true;

                    // 버튼 전환
                    const container = field.parentElement;
                    container.querySelector('.btn-change').classList.remove('hidden');
                    container.querySelector('.btn-save').classList.add('hidden');
                    container.querySelector('.btn-cancel').classList.add('hidden');

                    // 중복확인 버튼 숨기기
                    const checkBtn = container.querySelector('.check-button');
                    if (checkBtn) {
                        checkBtn.classList.add('hidden');
                    }

                    // 메시지 초기화
                    resetFieldValidation(fieldId);

                } else {
                    showAlert(data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('서버 오류가 발생했습니다.', 'danger');
            });
    }

    // 페이지 로드 시 기존 값 저장 (초기화 방지)
    document.addEventListener('DOMContentLoaded', () => {
        const nicknameEl = document.getElementById('nickname');
        const nameEl = document.getElementById('name');
        const emailEl = document.getElementById('email');
        const phoneEl = document.getElementById('phone');

        if (nicknameEl) originalValues['nickname'] = nicknameEl.value;
        if (nameEl) originalValues['name'] = nameEl.value;
        if (emailEl) originalValues['email'] = emailEl.value;
        if (phoneEl) originalValues['phone'] = phoneEl.value;
    });

    // 이메일 필드에 대한 'blur' 이벤트 리스너 추가
    document.getElementById('email').addEventListener('blur', function() {
        if (!this.value.includes('@')) {
            showAlert('유효한 이메일 형식을 입력해주세요.', 'danger');
        }
    });

    // 비밀번호 변경 폼 제출 이벤트
    document.getElementById('passwordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            showAlert('새 비밀번호와 확인 비밀번호가 일치하지 않습니다.', 'danger');
            return;
        }

        if (newPassword.length < 8) {
            showAlert('새 비밀번호는 8자 이상이어야 합니다.', 'danger');
            return;
        }

        // 서버에 비밀번호 변경 요청
        fetch('/member/profile/update-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [header]: token
            },
            body: JSON.stringify({
                currentPassword: currentPassword,
                newPassword: newPassword
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('비밀번호가 성공적으로 변경되었습니다.', 'success');
                    // 폼 초기화
                    document.getElementById('passwordForm').reset();
                } else {
                    showAlert(data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('서버 오류가 발생했습니다.', 'danger');
            });
    });

    // 임시 비밀번호 모달 관련 함수 (기존 코드)
    function openTempPasswordModal(tempPassword) {
        document.getElementById('tempPasswordDisplay').textContent = tempPassword;
        document.getElementById('tempPasswordModal').style.display = 'flex';
    }

    function closeTempPasswordModal() {
        document.getElementById('tempPasswordModal').style.display = 'none';
    }

    function copyTempPassword() {
        const tempPassword = document.getElementById('tempPasswordDisplay').textContent;
        navigator.clipboard.writeText(tempPassword).then(() => {
            alert('임시 비밀번호가 복사되었습니다.');
        }).catch(err => {
            console.error('복사 실패:', err);
        });
    }

    // 이전에 정의되지 않았던 함수들
    function getFieldValidationStatus(fieldId) {
        switch(fieldId) {
            case 'nickname': return isNicknameValid;
            case 'name': return isNameValid;
            case 'email': return isEmailValid;
            case 'phone': return isPhoneValid;
            default: return false;
        }
    }

    function getFieldLabel(fieldId) {
        switch(fieldId) {
            case 'nickname': return '닉네임';
            case 'name': return '이름';
            case 'email': return '이메일';
            case 'phone': return '전화번호';
            default: return '';
        }
    }
</script>
</body>
</html>