<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/tab.html}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeetingReview Read</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>

<div layout:fragment="content">
    <h1>MeetingReview Detail</h1>

    <div class="card-body">
        <div class="input-group mb-3">
            <span class="input-group-text">Id</span>
            <input type="text" class="form-control" th:value="${dto.id}" readonly>
        </div>

        <div class="input-group mb-3">
            <span class="input-group-text">Title</span>
            <input type="text" class="form-control" th:value="${dto.title}" readonly>
        </div>

        <div class="input-group mb-3">
            <span class="input-group-text">Writer</span>
            <input type="text" name="reviewer" class="form-control" th:value="${dto.reviewerUserId}" readonly>
            <input type="text" name="reviewer" class="form-control" th:value="${dto.reviewerNickname}" readonly>
        </div>


        <div class="input-group mb-3">
            <span class="input-group-text">MeetingDate</span>
            <input type="datetime-local" class="form-control" th:value="${dto.meetingDate}" readonly>
        </div>
        <div class="input-group mb-3">
            <span class="input-group-text">Location</span>
            <input type="text" name="location" class="form-control" th:value="${dto.meetingLocation}" readonly>
        </div>
        <div class="input-group mb-3">
            <span class="input-group-text">Address</span>
            <input type="text" class="form-control" th:value="${dto.meetingAddress}" readonly>
        </div>


        <div class="input-group mb-3">
            <span class="input-group-text">Content</span>
            <textarea class="form-control col-sm-5" rows="5" readonly>[[${dto.content}]]</textarea>
        </div>
        <div th:if="${dto.imageList != null and not #lists.isEmpty(dto.imageList)}" class="mt-4">
            <h4>후기 사진</h4>
            <div class="d-flex flex-wrap">
                <div th:each="image : ${dto.imageList}" class="p-2">
                    <img th:src="@{/upload/display(fileName='s_' + ${image.uuid} + '_' + ${image.fileName})}"
                         alt="Review Image"
                         class="img-fluid rounded"
                         style="max-width: 200px; height: auto;">
                </div>
            </div>
        </div>

        <div class="my-4">
            <div class="float-end" th:with="link = ${pageRequestDTO.getLink()}">
                <a th:href="@{/cafe/{cafeId}/meeting/review/list(cafeId=${cafeResponse.id}, page=${pageRequestDTO.page}, type=${pageRequestDTO.type}, keyword=${pageRequestDTO.keyword})}">
                    <button type="button" class="btn btn-primary">List</button>
                </a>
                <a th:if="${#authentication.principal != null and #authentication.principal.username == dto.reviewerUserId}"
                   th:href="|@{/cafe/{cafeId}/meeting/review/modify(cafeId=${cafeResponse.id}, id=${dto.id})}&${link}|" class="text-decoration-none">
                    <button type="button" class="btn btn-secondary">Modify</button>
                </a>
            </div>
        </div>
    </div>

    <div class="comment-section mt-5">
        <h2 class="h4">댓글</h2>
        <hr>

        <div id="replyList" class="reply-list">
        </div>

        <div class="comment-form-container mt-4">
            <h3 class="h5">댓글 작성</h3>
            <div th:if="${#authentication.principal}">
                <form id="commentForm">
                    <textarea id="replyText" class="form-control mb-2" rows="3" required></textarea>
                    <div class="text-end">
                        <button type="button" id="replyRegisterBtn" class="btn btn-primary">댓글 작성</button>
                    </div>
                </form>
            </div>
            <div th:unless="${#authentication.principal}" class="text-center py-3">
                <p class="text-muted">댓글을 작성하려면 <a th:href="@{/login}">로그인</a>이 필요합니다.</p>
            </div>
        </div>
    </div>
</div>

    <script layout:fragment="script" th:inline="javascript">
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        const reviewId = [[${dto.id}]];
        const loggedInUser = [[${#authentication.principal != null ? #authentication.principal.username : null}]];

        async function getReplyList(reviewId) {
            try {
                const response = await fetch(`/replies/reviews/${reviewId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch replies');
                }
                const replies = await response.json();
                const replyListDiv = document.getElementById('replyList');
                replyListDiv.innerHTML = ''; // 기존 목록 초기화

                if (replies.length > 0) {
                    replies.forEach(reply => {
                        const isMyReply = loggedInUser && loggedInUser === reply.replyer;
                        const controlsHtml = isMyReply ? `
                        <button class="btn btn-sm btn-outline-secondary me-2 edit-comment-btn" data-reply-id="${reply.id}" data-content="${reply.text}">수정</button>
                        <button class="btn btn-sm btn-outline-danger delete-comment-btn" data-reply-id="${reply.id}">삭제</button>
                    ` : '';

                        const replyHtml = `
                        <div class="comment d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <strong>${reply.replyer}</strong>
                                <p>${reply.text}</p>
                            </div>
                            <div class="d-flex" data-reply-id="${reply.id}">
                                ${controlsHtml}
                            </div>
                        </div>
                    `;
                        replyListDiv.insertAdjacentHTML('beforeend', replyHtml);
                    });
                } else {
                    replyListDiv.innerHTML = `<div class="text-center text-muted py-4"><p>아직 댓글이 없습니다. 첫 댓글을 남겨보세요!</p></div>`;
                }
            } catch (error) {
                console.error('댓글 목록 로딩 중 오류 발생:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            getReplyList(reviewId);
        });


        const replyRegisterBtn = document.getElementById('replyRegisterBtn');
        const replyTextarea = document.getElementById('replyText');

        // 댓글 등록 버튼이 존재할 때만 이벤트 리스너 추가
        if (replyRegisterBtn) {
            replyRegisterBtn.addEventListener('click', async () => {
                const text = replyTextarea.value.trim();
                if (!text) {
                    alert('댓글 내용을 입력해주세요.');
                    return;
                }

                const replyData = {
                    reviewId: reviewId,
                    replyer: loggedInUser,
                    text: text
                };

                try {
                    const response = await fetch(`/replies/reviews/${reviewId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: JSON.stringify(replyData)
                    });

                    if (response.ok) {
                        alert('댓글이 성공적으로 등록되었습니다.');
                        window.location.reload();
                    } else {
                        alert('댓글 등록에 실패했습니다.');
                    }
                } catch (error) {
                    console.error('댓글 등록 중 오류 발생:', error);
                }
            });
        }

        // 수정/삭제 버튼 이벤트를 클릭 이벤트 위임으로 처리
        document.addEventListener('click', async (e) => {
            const target = e.target;
            if (target.classList.contains('edit-comment-btn')) {
                const replyId = target.dataset.replyId;
                const currentContent = target.dataset.content;
                const newContent = prompt('댓글을 수정하세요:', currentContent);

                if (newContent !== null && newContent.trim() !== '') {
                    try {
                        const response = await fetch(`/replies/${replyId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                [csrfHeader]: csrfToken
                            },
                            body: JSON.stringify({ text: newContent })
                        });
                        if (response.ok) {
                            alert('댓글이 성공적으로 수정되었습니다.');
                            window.location.reload();
                        } else {
                            alert('댓글 수정에 실패했습니다.');
                        }
                    } catch (error) {
                        console.error('댓글 수정 중 오류 발생:', error);
                    }
                }
            } else if (target.classList.contains('delete-comment-btn')) {
                const replyId = target.dataset.replyId;
                if (confirm('정말로 이 댓글을 삭제하시겠습니까?')) {
                    try {
                        const response = await fetch(`/replies/${replyId}`, {
                            method: 'DELETE',
                            headers: {
                                [csrfHeader]: csrfToken
                            }
                        });
                        if (response.ok) {
                            alert('댓글이 성공적으로 삭제되었습니다.');
                            window.location.reload();
                        } else {
                            alert('댓글 삭제에 실패했습니다.');
                        }
                    } catch (error) {
                        console.error('댓글 삭제 중 오류 발생:', error);
                    }
                }
            }
        });

        // 기존 버튼 이벤트 리스너는 선택된 요소가 존재하는지 확인하는 코드를 추가
        const listBtn = document.querySelector(".btn-primary");
        if (listBtn) {
            listBtn.addEventListener("click", function (e) {
                e.preventDefault();
                self.location = `/cafe/${cafeId}/meeting/review/list?${pageRequestDTO.link}`;
            }, false);
        }

        const modifyBtn = document.querySelector(".btn-secondary");
        if (modifyBtn) {
            modifyBtn.addEventListener("click", function (e) {
                e.preventDefault();
                self.location = `/cafe/${cafeId}/meeting/review/modify?id=${dto.id}&${pageRequestDTO.link}`;
            }, false);
        }
    </script>