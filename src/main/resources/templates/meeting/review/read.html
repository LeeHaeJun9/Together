<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모임후기 상세</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/postDetail.css}">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <style>
        .participant-table{width:100%;border-collapse:collapse;table-layout:fixed;text-align:center;}
        .participant-table th,.participant-table td{padding:8px 12px;text-align:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;border-bottom:1px solid #ddd;}
        .participant-table th:nth-child(1){width:10%;}
        .participant-table th:nth-child(2){width:25%;}
        .participant-table th:nth-child(3){width:20%;}
        .participant-table th:nth-child(4){width:20%;}
    </style>
</head>
<body>
<div th:replace="~{/layout/header :: header}"></div>

<main>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4" th:with="link = ${pageRequestDTO.getLink()}">
            <a th:href="@{/cafe/{cafeId}/meeting/review/list(cafeId=${cafeResponse.id}, page=${pageRequestDTO.page}, type=${pageRequestDTO.type}, keyword=${pageRequestDTO.keyword})}"
               class="btn btn-custom-secondary">목록으로</a>
            <div class="post-actions d-flex gap-2">
                <!-- ✅ 후기글 신고 (POST) -->
                <span th:replace="~{/fragments/report :: reportBtn2('POST', ${dto.id})}"></span>

                <a th:if="${#authentication.principal != null and #authentication.principal.username == dto.reviewerUserId}"
                   th:href="|@{/cafe/{cafeId}/meeting/review/modify(cafeId=${cafeResponse.id}, id=${dto.id})}&${link}|"
                   class="btn btn-custom-primary">수정</a>

                <form th:if="${#authentication.principal != null and #authentication.principal.username == dto.reviewerUserId}"
                      th:action="@{/cafe/{cafeId}/meeting/review/remove(cafeId=${cafeResponse.id})}"
                      method="post" class="d-inline-block">
                    <input type="hidden" name="id" th:value="${dto.id}" />
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="btn btn-custom-danger" onclick="return confirm('정말로 삭제하시겠습니까?');">삭제</button>
                </form>
            </div>
        </div>

        <!-- 본문/이미지/댓글: 기존 코드 그대로 유지 -->
        <div class="post-content-section mb-4">
            <div class="post-header-container">
                <input type="hidden" class="form-control" th:value="${dto.id}" readonly>
                <h1 th:text="${dto.title}">모임 제목</h1>
                <div class="post-meta">
                    <span th:if="*{cafeResponse != null}" th:text="'[' + *{cafeResponse.category} + ']'">카테고리</span>
                    <span th:if="*{cafeResponse != null}" th:text="*{cafeResponse.name}">카페</span> |
                    <span th:text="${dto.reviewerNickname}">작성자</span>
                </div>
            </div>
            <div class="post-content">
                <div class="meeting-content">
                    <div id="map" th:if="${dto.meetingAddress != null and !#strings.isEmpty(dto.meetingAddress)}"
                         style="width:400px;height:300px;"></div>
                    <br>
                    <span th:text="'날짜 : ' + ${#temporals.format(dto.meetingDate, 'yyyy/MM/dd HH:ss')}">모임 날짜</span><br>
                    <span th:text="'장소 : ' + ${dto.meetingLocation}">모임 장소</span><br>
                    <span th:text="'상세 주소 : ' + ${dto.meetingAddress}">상세 주소</span>
                </div>
                <br>
                <p th:text="${dto.content}">게시글 내용</p>
            </div>

            <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=00d1cc9629760bc7ec0a4a9e59c66965&libraries=services"></script>
            <script th:inline="javascript">
                var address = [[${dto.meetingAddress}]]

                var map = new kakao.maps.Map(document.getElementById('map'), {
                    center: new kakao.maps.LatLng(33.450701, 126.570667),  // 기본 위치
                    level: 3
                });

                var geocoder = new kakao.maps.services.Geocoder();

                geocoder.addressSearch(address, function(result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                        map.setCenter(coords);  // 지도 중심 이동

                        new kakao.maps.Marker({ map: map, position: coords });  // 마커 표시
                    }
                });
            </script>

            <div th:if="${dto.imageList != null and not #lists.isEmpty(dto.imageList)}" class="mt-4">
                <h4>후기 사진</h4>
                <div class="d-flex flex-wrap">
                    <div th:each="image : ${dto.imageList}" class="p-2">
                        <img th:src="@{/upload/display(fileName='s_' + ${image.uuid} + '_' + ${image.fileName})}"
                             alt="Review Image" class="img-fluid rounded" style="max-width: 200px; height: auto;">
                    </div>
                </div>
            </div>
        </div>

        <div class="comment-section mt-5">
            <h2 class="h4">댓글</h2>
            <hr>
            <div id="replyList" class="reply-list"></div>
            <div class="comment-form-container mt-4">
                <h3 class="h5">댓글 작성</h3>
                <div th:if="${#authentication.principal}">
                    <form id="commentForm">
                        <textarea id="replyText" class="form-control mb-2" rows="3" required></textarea>
                        <div class="text-end">
                            <button type="button" id="replyRegisterBtn" class="btn btn-primary">댓글 작성</button>
                        </div>
                    </form>
                </div>
                <div th:unless="${#authentication.principal}" class="text-center py-3">
                    <p class="text-muted">댓글을 작성하려면 <a th:href="@{/login}">로그인</a>이 필요합니다.</p>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="editCommentModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3 class="h5">댓글 수정하기</h3>
        <form id="editCommentForm" class="mt-3">
            <input type="hidden" id="editCommentId" name="commentId">
            <textarea id="editCommentContent" name="content" class="form-control mb-3" rows="3" required></textarea>
            <button type="submit" class="btn btn-custom-primary w-100">수정 완료</button>
        </form>
    </div>
</div>

<div th:replace="~{/layout/footer :: footer}"></div>

<!-- ✅ 신고 스크립트 -->
<script th:src="@{/js/report-quick.js}"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    // (기존 댓글 로딩/등록/수정/삭제 스크립트 그대로)
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    const reviewId = [[${dto.id}]];
    const loggedInUser = [[${#authentication.principal != null ? #authentication.principal.username : null}]];
    async function getReplyList(reviewId){ /* ... 기존 구현 그대로 ... */ }
    document.addEventListener('DOMContentLoaded', () => { getReplyList(reviewId); });
    // 나머지 핸들러들 그대로…
</script>
</body>
</html>
