<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모임후기 수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        main {
            flex-grow: 1;
            padding: 2rem 0;
        }
        .page-header-container {
            max-width: 1100px;
            margin: 0 auto;
            padding-left: 1rem;
            padding-right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        .page-header-container h3 {
            font-size: 1.75rem;
            font-weight: bold;
            color: #212529;
            margin-bottom: 0;
        }
        .card-custom {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            border-radius: 0.25rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
            border: 1px solid rgba(0,0,0,.125);
            background-color: white;
        }
        .form-label-custom {
            font-weight: 600;
            color: #343a40;
        }
        .form-control {
            border-radius: 0.25rem;
            border: 1px solid #ced4da;
            padding: 0.5rem 0.75rem;
        }
        .form-control:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }
        .btn-primary-custom {
            background-color: #0d6efd;
            border-color: #0d6efd;
            border-radius: 0.25rem;
            padding: 0.5rem 1rem;
            font-weight: normal;
            color: white;
            text-decoration: none;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary-custom:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
            color: white;
        }
        .btn-secondary-custom {
            background-color: #6c757d;
            border-color: #6c757d;
            border-radius: 0.25rem;
            padding: 0.5rem 1rem;
            font-weight: normal;
            color: white;
            text-decoration: none;
            transition: all 0.2s ease-in-out;
        }
        .btn-secondary-custom:hover {
            background-color: #5c636a;
            border-color: #565e64;
            color: white;
        }
    </style>
</head>
<body>

<div th:replace="~{layou/header :: header}"></div>

<main>
    <div class="page-header-container">
        <h3>모임 후기 수정</h3>
    </div>

    <div class="container">
        <div class="card card-custom">
            <form th:action="@{/cafe/{cafeId}/meeting/review/modify(cafeId=${cafeResponse.id})}" method="post" id="f1" enctype="multipart/form-data">
                <input type="hidden" class="form-control" id="id" name="id" th:value="${dto.id}">

                <div class="mb-3">
                    <label for="title" class="form-label-custom">제목:</label>
                    <input type="text" class="form-control" id="title" name="title" th:value="${dto.title}" required>
                </div>

                <div class="mb-3" th:if="*{dto.cafe != null}">
                    <!--                    <label for="category" class="form-label-custom">카테고리:</label>-->
                    <input type="hidden" class="form-control" id="category" th:value="*{dto.cafe.category}" readonly>
                </div>
                <div class="mb-3" th:if="*{dto.cafe != null}">
                    <!--                    <label for="cafe" class="form-label-custom">소속된 카페:</label>-->
                    <!--                    <input type="hidden" th:field="*{dto.cafe.id}" />-->
                    <input type="hidden" class="form-control" id="cafe" th:value="*{dto.cafe.name}" readonly>
                </div>

                <div class="mb-3">
                    <label for="meetingDate" class="form-label-custom">모임 날짜:</label>
                    <input type="datetime-local" class="form-control" id="meetingDate" name="meetingDate" th:value="*{dto.meetingDate}">
                </div>

                <div class="mb-3">
                    <label for="location" class="form-label-custom">모임 장소:</label>
                    <input type="text" class="form-control" id="location" name="location" th:value="*{dto.meetingLocation}">
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label-custom">모임 주소:</label>
                    <input type="text" class="form-control" id="address" th:field="*{dto.meetingAddress}" readonly>
                    <button type="button" onclick="execDaumPostcode()" class="btn btn-outline-secondary">주소 찾기</button>
                </div>

                <div class="mb-3">
                    <label for="content" class="form-label-custom">후기 내용:</label>
                    <textarea class="form-control col-sm-5" rows="5" id="content" th:field="*{dto.content}"></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label-custom">기존 이미지:</label>
                    <div class="d-flex flex-wrap existingImages" th:if="${dto.imageList != null and not #lists.isEmpty(dto.imageList)}">
                        <div th:each="image : ${dto.imageList}" class="p-2 position-relative existing-image-container">
                            <img th:src="@{/upload/display(fileName='s_' + ${image.uuid} + '_' + ${image.fileName})}"
                                 alt="Review Image"
                                 class="img-fluid rounded"
                                 style="max-width: 100px; height: auto;">
                            <button type="button" class="btn-close remove-image-btn" aria-label="Close" th:data-uuid="${image.uuid}" style="position: absolute; top: 0; right: 0;"></button>
                        </div>
                    </div>
                </div>

                <div class="input-group mb-3">
                    <span class="input-group-text">새 이미지</span>
                    <input type="file" name="files" class="form-control" multiple>
                </div>
                <div class="row mt-3">
                    <div class="col">
                        <div class="container-fluid d-flex newUploadResult" style="flex-wrap: wrap;">
                        </div>
                    </div>
                </div>

                <div id="removed-images"></div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end my-4">
                    <button type="button" class="btn btn-primary-custom modBtn">수정하기</button>
                    <button type="button" class="btn btn-secondary-custom listBtn">취소</button>
                </div>
            </form>
        </div>
    </div>
</main>

<div th:replace="~{layou/footer :: footer}"></div>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    // 함수 이름을 execDaumPostcode()로 통일
    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                var addr = data.address;
                document.getElementById("address").value = addr;
            }
        }).open();
    }
</script>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        console.log("mtReviewModify....");

        const errors = [[${errors}]];
        if (errors) {
            let errorMsg = '';
            errors.forEach(err => {
                errorMsg += `${err.field}은(는) ${err.code} \n`;
            });
            alert(errorMsg);
        }

        const cafeId = [[${cafeResponse.id}]];
        const link = [[${pageRequestDTO.getLink()}]];
        const formObj = document.querySelector("#f1");

        const newFileInput = document.querySelector("input[name='files']");
        const newUploadResult = document.querySelector(".newUploadResult");
        const removedImagesContainer = document.querySelector("#removed-images");

        // ✅ 새로운 이미지 미리보기 로직 (register.html과 동일)
        newFileInput.addEventListener("change", (e) => {
            const files = e.target.files;
            if (!files.length) return;
            newUploadResult.innerHTML = '';
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement("img");
                    img.src = e.target.result;
                    img.classList.add("card-img-top", "m-1");
                    img.style.cssText = "width: 100px; height: 100px;";
                    newUploadResult.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

        // ✅ 기존 이미지 삭제 로직
        document.querySelectorAll('.remove-image-btn').forEach(button => {
            button.addEventListener('click', function() {
                const uuid = this.getAttribute('data-uuid');
                const container = this.closest('.existing-image-container');
                container.remove();

                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'removedImageUuids';
                hiddenInput.value = uuid;
                removedImagesContainer.appendChild(hiddenInput);
            });
        });

        // 폼 제출 버튼 이벤트
        document.querySelector(".modBtn").addEventListener("click", function (e) {
            e.preventDefault();
            formObj.action = `/cafe/${cafeId}/meeting/review/modify?${link}`;
            formObj.method = 'post';
            formObj.submit();
        });

        document.querySelector(".listBtn").addEventListener("click", function (e) {
            e.preventDefault();
            formObj.reset();
            self.location = `/cafe/${cafeId}/meeting/review/list?${link}`;
        });
    });
</script>

</body>
</html>