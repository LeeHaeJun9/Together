<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모임 상세</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/postDetail.css}">
</head>

<body>

<div th:replace="~{/layout/header :: header}"></div>

<main>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4" th:with="link = ${pageRequestDTO.getLink()}">
            <a th:href="|@{/cafe/{cafeId}/meetings(cafeId=${cafeResponse.id})}?${link}|"
               class="btn btn-custom-secondary">목록으로</a>
            <div class="post-actions">
                <a th:if="${#authentication.principal != null and #authentication.principal.username == dto.organizerName}"
                   th:href="|@{/cafe/{cafeId}/meeting/modify(cafeId=${cafeResponse.id}, id=${dto.id})}&${link}|"
                   class="btn btn-custom-primary me-2">수정</a>

                <form th:if="${#authentication.principal != null and #authentication.principal.username == dto.organizerName}"
                      th:action="@{/cafe/{cafeId}/meeting/remove(cafeId=${cafeResponse.id})}"
                      method="post" class="d-inline-block">
                    <input type="hidden" name="id" th:value="${dto.id}" />
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="btn btn-custom-danger" onclick="return confirm('정말로 삭제하시겠습니까?');">삭제</button>
                </form>
            </div>
        </div>

        <div class="post-content-section mb-4">
            <div class="post-header-container">
                <input type="hidden" class="form-control" th:value="${dto.id}" readonly>

                <h1 th:text="${dto.title}">모임 제목</h1>
                <div class="post-meta">
                    <span th:if="*{dto.cafe != null}" th:text="'[' + *{dto.cafe.category} + ']'">카테고리</span>
                    <span th:if="*{dto.cafe != null}" th:text="*{dto.cafe.name}">카페</span> |
                    <span th:text="${dto.organizerNickname}">작성자</span>
                </div>
            </div>
            <div class="post-content">
                <div class="meeting-content">
                    <span th:text="'날짜 : ' + ${dto.meetingDate}">모임 날짜</span><br>
                    <span th:text="'장소 : ' + ${dto.location}">모임 장소</span><br>
                    <span th:text="'상세 주소 : ' + ${dto.address}">상세 주소</span>
                </div>
                <p th:text="${dto.content}">게시글 내용</p>
            </div>
<!--            <div>-->
<!--                <span th:text="${dto.visibility != null and dto.visibility.name() == 'PUBLIC'} ? '전체 공개' : '카페 공개'"></span>-->
<!--                /-->
<!--                <span th:text="${dto.recruiting != null and dto.recruiting.name() == 'END'} ? '모집 마감' : '모집 중'"></span>-->
<!--            </div>-->
        </div>

        <div class="my-2">
            <form method="post" style="display: inline;"
                  th:if="${isJoinedUser == null || !isJoinedUser}"
                  th:action="@{/cafe/{cafeId}/meeting/apply(cafeId=${cafeResponse.id})}">
                <input type="hidden" name="meetingId" th:value="${dto.id}" />
                <button type="submit" class="btn"
                        th:classappend="(${dto.meetingDate.isBefore(T(java.time.LocalDateTime).now())} or ${dto.recruiting.name() == 'END'}) ? 'btn-secondary disabled' : 'btn-success'"
                        th:disabled="${dto.meetingDate.isBefore(T(java.time.LocalDateTime).now())} or ${dto.recruiting.name() == 'END'}">
                    <span th:text="(${dto.meetingDate.isBefore(T(java.time.LocalDateTime).now())} or ${dto.recruiting.name() == 'END'}) ? '모집 마감' : '신청하기'">모집 상태</span>
                </button>
            </form>
            <!-- ✅ 신청 취소 (이미 신청한 경우) -->
            <button type="button"
                    class="btn btn-danger"
                    th:if="${isJoinedUser}"
                    data-bs-toggle="modal"
                    data-bs-target="#cancelModal">
                신청 취소
            </button>

            <button type="button"
                    class="btn btn-outline-primary ms-2 reviewBtn"
                    th:if="${isJoinedUser} and ${dto.meetingDate.isBefore(T(java.time.LocalDateTime).now())}"
                    th:onclick="|location.href='@{/cafe/{cafeId}/meeting/review/register(cafeId=${cafeResponse.id}, meetingId=${dto.id})}'|">
                모임 후기 작성
            </button>
        </div>

        <!-- 신청 취소 확인 모달 -->
        <div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form th:action="@{/cafe/{cafeId}/meeting/cancel(cafeId=${cafeResponse.id})}" method="post">
                        <input type="hidden" name="meetingId" th:value="${dto.id}" />
                        <div class="modal-header">
                            <h5 class="modal-title" id="cancelModalLabel">신청 취소</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                        </div>
                        <div class="modal-body">
                            정말로 이 모임 신청을 취소하시겠습니까?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">돌아가기</button>
                            <button type="submit" class="btn btn-danger">모임 신청 취소</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="comment-section">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h4">참가자 목록</h2>
                <div class="participant-actions">

            <hr>

            <table class="table table-striped">
                <thead>
                <tr>
                    <th>넘버</th>
                    <th>아이디</th>
                    <th>닉네임</th>
                    <th>참가 상태</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="mu : ${meetingUser}">
                    <td th:text="${mu.id}">아이디</td>
                    <td th:text="${mu.userIdName}">아이디</td>
                    <td th:text="${mu.nickname}">닉네임</td>
                    <td th:text="${mu.joinStatus}">상태</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
        </div>
    </div>
</main>
<div th:replace="~{/layout/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    document.querySelector(".modBtn").addEventListener("click", function (e) {
        self.location = `/board/modify?tno=${dto.tno}&${pageRequestDTO.link}`
    },false)

    document.querySelector(".ListBtn").addEventListener("click", function (e) {
        self.location = `/board/list?${pageRequestDTO.link}`
    }, false)

    // document.querySelector(".removeBtn").addEventListener("click", function (e) {
    //     e.stopPropagation()
    //     e.preventDefault()
    //
    //     formObj.action = `/cafe/${cafeId}/meeting/remove`
    //     formObj.method = 'post'
    //     formObj.submit()
    // }, false)
</script>