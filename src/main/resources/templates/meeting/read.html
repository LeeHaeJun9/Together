<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모임 상세</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/postDetail.css}">
    <style>
        .participant-table{width:100%;border-collapse:collapse;table-layout:fixed;text-align:center;}
        .participant-table th,.participant-table td{padding:8px 12px;text-align:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;border-bottom:1px solid #ddd;}
        .participant-table th:nth-child(1){width:10%;}
        .participant-table th:nth-child(2){width:25%;}
        .participant-table th:nth-child(3){width:20%;}
        .participant-table th:nth-child(4){width:20%;}
        .participant-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            text-align: center;
        }
        .participant-table th,
        .participant-table td {
            padding: 8px 12px;
            text-align: center;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            border-bottom: 1px solid #ddd;
        }
        .participant-table th:nth-child(1) { width: 10%; }
        .participant-table th:nth-child(2) { width: 25%; }
        .participant-table th:nth-child(3) { width: 20%; }
        .participant-table th:nth-child(4) { width: 20%; }

        /* 리스트 아이콘 버튼 */
        .icon-btn{ display:inline-flex; align-items:center; justify-content:center; width:44px; height:44px; border-radius:10px; border:none;
            background:transparent; color:#6c757d; transition:.15s; }
        .icon-btn:hover{ color:#0d6efd; background:#f5f9ff; }
        .icon-btn svg{ width:22px; height:22px; }

    </style>
</head>
<body>
<div th:replace="~{/layout/header :: header}"></div>

<main>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4" th:with="link = ${pageRequestDTO.getLink()}">

            <a th:href="|@{/cafe/{cafeId}/meetings(cafeId=${cafeResponse.id})}?${link}|" class="btn btn-custom-secondary">목록으로</a>
            <div class="post-actions d-flex gap-2">
                <!-- ✅ 모임글 신고 (POST) -->
                <span th:replace="~{/fragments/report :: reportBtn2('POST', ${dto.id})}"></span>


<!--            <a th:href="|@{/cafe/{cafeId}/meetings(cafeId=${cafeResponse.id})}?${link}|"-->
<!--               class="btn btn-custom-secondary">목록으로</a>-->
            <a class="icon-btn btn btn-custom-secondary"
               th:href="|@{/cafe/{cafeId}/meetings(cafeId=${cafeResponse.id})}?${link}|" title="목록" aria-label="목록">
                <svg xmlns="http://www.w3.org/2000/svg" class="bi bi-list" viewBox="0 0 16 16" aria-hidden="true">
                    <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/>
                </svg>
            </a>

            <div class="post-actions">

                <a th:if="${#authentication.principal != null and #authentication.principal.username == dto.organizerName}"
                   th:href="|@{/cafe/{cafeId}/meeting/modify(cafeId=${cafeResponse.id}, id=${dto.id})}&${link}|"
                   class="btn btn-custom-primary">수정</a>

                <form th:if="${#authentication.principal != null and #authentication.principal.username == dto.organizerName}"
                      th:action="@{/cafe/{cafeId}/meeting/remove(cafeId=${cafeResponse.id})}"
                      method="post" class="d-inline-block">
                    <input type="hidden" name="id" th:value="${dto.id}" />
                    <input type="hidden" id="applicantCount" th:value="${applicantCount}" />
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="btn btn-custom-danger" onclick="return confirm('정말로 삭제하시겠습니까?');">삭제</button>
                </form>
            </div>
        </div>

        <!-- 본문 -->
        <div class="post-content-section mb-4">
            <div class="post-header-container">
                <input type="hidden" class="form-control" th:value="${dto.id}" readonly>
                <h1 th:text="${dto.title}">모임 제목</h1>
                <div class="post-meta">
                    <span th:if="*{dto.cafe != null}" th:text="'[' + *{dto.cafe.category} + ']'">카테고리</span>
                    <span th:if="*{dto.cafe != null}" th:text="*{dto.cafe.name}">카페</span> |
                    <span th:text="${dto.organizerNickname}">작성자</span>
                </div>
            </div>
            <div class="post-content">
                <div class="meeting-content">
                    <div id="map" th:if="${dto.address != null and !#strings.isEmpty(dto.address)}"
                         style="width:400px;height:300px;"></div>
                    <br>
                    <span th:text="'날짜 : ' + ${#temporals.format(dto.meetingDate, 'yyyy/MM/dd HH:ss')}">모임 날짜</span><br>
                    <span th:text="'장소 : ' + ${dto.location}">모임 장소</span><br>
                    <span th:text="'상세 주소 : ' + ${dto.address}">상세 주소</span>
                </div>
                <br>
                <p th:text="${dto.content}">게시글 내용</p>
            </div>
        </div>


        <!-- 참가자 목록/버튼들: 기존 그대로 -->

        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=00d1cc9629760bc7ec0a4a9e59c66965&libraries=services"></script>
        <script th:inline="javascript">
            var address = [[${dto.address}]]

            var map = new kakao.maps.Map(document.getElementById('map'), {
                center: new kakao.maps.LatLng(33.450701, 126.570667),  // 기본 위치
                level: 3
            });

            var geocoder = new kakao.maps.services.Geocoder();

            geocoder.addressSearch(address, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                    map.setCenter(coords);  // 지도 중심 이동

                    new kakao.maps.Marker({ map: map, position: coords });  // 마커 표시
                }
            });
        </script>

        <div class="comment-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h4">참가자 목록</h2>
                <div class="my-2">
                    <form method="post" style="display: inline;"
                          th:if="${isJoinedUser == null || !isJoinedUser}"
                          th:action="@{/cafe/{cafeId}/meeting/apply(cafeId=${cafeResponse.id})}">
                        <input type="hidden" name="meetingId" th:value="${dto.id}" />
                        <button type="submit" class="btn"
                                th:classappend="(${dto.meetingDate.isBefore(T(java.time.LocalDateTime).now())} or ${dto.recruiting.name() == 'END'}) ? 'btn-secondary disabled' : 'btn-success'"
                                th:disabled="${dto.meetingDate.isBefore(T(java.time.LocalDateTime).now())} or ${dto.recruiting.name() == 'END'}">
                            <span th:text="(${dto.meetingDate.isBefore(T(java.time.LocalDateTime).now())} or ${dto.recruiting.name() == 'END'}) ? '모집 마감' : '신청하기'">모집 상태</span>
                        </button>
                    </form>
                    <form th:if="${isJoinedUser}"
                          th:action="@{/cafe/{cafeId}/meeting/cancel(cafeId=${cafeResponse.id})}"
                          method="post" class="d-inline-block">
                        <input type="hidden" name="meetingId" th:value="${dto.id}" />
                        <button type="submit" class="btn btn-custom-danger" onclick="return confirm('정말로 신청 취소하시겠습니까?');">취소</button>
                        <button type="button"
                                class="btn btn-secondary"
                                disabled
                                th:if="${dto.recruiting.name() == 'END' or dto.meetingDate.isBefore(T(java.time.LocalDateTime).now())}">
                            모집 마감
                        </button>
                    </form>
                    <button type="button" class="btn btn-outline-primary ms-2 reviewBtn"
                            th:if="${isJoinedUser} and ${dto.meetingDate.isBefore(T(java.time.LocalDateTime).now())}"
                            th:onclick="|location.href='@{/cafe/{cafeId}/meeting/review/register(cafeId=${cafeResponse.id}, meetingId=${dto.id})}'|">
                        모임 후기 작성
                    </button>
                </div>
            </div>

            <hr>

            <table class="table participant-table">
                <thead>
                <tr>
                    <th>No.</th>
                    <th>닉네임</th>
                    <th>신청 날짜</th>
                    <th>참가 상태</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="mu, iterStat : ${meetingUser}">
                    <td th:text="${iterStat.index + 1}">No</td>
                    <td th:text="${mu.nickname}">닉네임</td>
                    <td th:text="${#temporals.format(mu.regDate, 'yyyy-MM-dd HH:mm')}">신청날짜</td>
                    <td>
                        <span th:if="${mu.joinStatus != null and mu.joinStatus.name() == 'ACCEPTED'}">신청 완료</span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<div th:replace="~{/layout/footer :: footer}"></div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

<script th:inline="javascript">
    // document.addEventListener('DOMContentLoaded', function() {
    //     const deleteForm = document.querySelector('form[action*="remove"]');
    //     const applicantCount = /*[[${applicantCount}]]*/ 0;
    //
    //     if(deleteForm) {
    //         deleteForm.addEventListener('submit', function(e) {
    //             if(applicantCount > 0) {
    //                 e.preventDefault(); // 폼 제출 막기
    //                 alert('신청자가 있는 모임은 삭제가 불가합니다.');
    //             } else {
    //                 // 신청자 없으면 삭제 진행 (기존 confirm은 그대로 두어도 됨)
    //             }
    //         });
    //     }
    // });
</script>

